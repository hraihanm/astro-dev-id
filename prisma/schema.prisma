generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  password      String?
  name          String?
  image         String?
  emailVerified DateTime?
  role          String         @default("student")
  apiKey        String?        @unique
  createdAt     DateTime       @default(now())
  courses       Course[]
  attempts      QuizAttempt[]
  profile       Profile?
  blockProgress BlockProgress[]
  progress      QuizProgress[]
  accounts      Account[]
  sessions      Session[]
  passwordResetTokens PasswordResetToken[]
  classroomsCreated Classroom[]           @relation("ClassroomCreator")
  classroomMemberships ClassroomMembership[] @relation("UserClassroomMemberships")
  classroomPosts     ClassroomPost[]        @relation("UserClassroomPosts")
  classroomComments  ClassroomComment[]     @relation("UserClassroomComments")
  classroomResourcesAdded ClassroomResource[] @relation("UserAddedResources")
  assessmentsCreated      Assessment[]        @relation("AssessmentCreator")
  assessmentSubmissions AssessmentSubmission[] @relation("AssessmentStudent")
  gradedSubmissions     AssessmentSubmission[] @relation("AssessmentGrader")
}

model Course {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  slug        String    @unique
  visibility  String    @default("PUBLIC") // PUBLIC or PRIVATE
  createdBy   Int
  createdAt   DateTime  @default(now())
  chapters    Chapter[]
  quizzes     Quiz[]
  creator     User      @relation(fields: [createdBy], references: [id])
  classroomResources ClassroomResource[] @relation("CourseClassroomResources")
}

model Chapter {
  id           Int            @id @default(autoincrement())
  courseId     Int
  title        String
  order        Int
  content      String?        // Markdown content
  blocks       String?        // JSON array of interactive blocks
  course       Course         @relation(fields: [courseId], references: [id])
  quizzes      Quiz[]
  blockProgress BlockProgress[]
}

model Quiz {
  id           Int           @id @default(autoincrement())
  courseId     Int? // Made nullable for standalone quizzes
  chapterId    Int?
  title        String
  availableFrom DateTime?
  availableUntil DateTime?
  openDurationSeconds Int?
  visibility   String        @default("PUBLIC") // PUBLIC or PRIVATE
  questions    String
  settings     String?
  quizType     String        @default("latihan") // "latihan" (unlimited), "tryout" (limited attempts)
  attemptLimit Int?          // null = unlimited, number = max attempts allowed
  scoreReleaseMode String    @default("immediate") // "immediate" or "admin"
  createdAt    DateTime      @default(now())
  course       Course?       @relation(fields: [courseId], references: [id])
  chapter      Chapter?      @relation(fields: [chapterId], references: [id])
  attempts     QuizAttempt[]
  progress     QuizProgress[]
  classroomResources ClassroomResource[] @relation("QuizClassroomResources")
}

model QuizAttempt {
  id              Int       @id @default(autoincrement())
  userId          Int
  quizId          Int
  answers         String
  score           Int
  totalQuestions  Int
  correctAnswers  Int
  percentage      Int
  timeSpent       Int
  detailedResults String
  completedAt     DateTime  @default(now())
  scoreReleasedAt DateTime? // null = not released yet, DateTime = when admin released it
  endReason       String    @default("manual") // "manual" | "time_up"
  essayGrading    Json?     // Store grading data: { questionIndex: { score, maxScore, feedback, gradedBy, gradedAt } }
  essayFiles      String?   // JSON array of uploaded file URLs from Vercel Blob
  user            User      @relation(fields: [userId], references: [id])
  quiz            Quiz      @relation(fields: [quizId], references: [id])
}

model QuizProgress {
  id                  Int       @id @default(autoincrement())
  userId              Int
  quizId              Int
  currentAnswers      String    // JSON array of current answers
  currentQuestionIndex Int       @default(0)
  timeSpent           Int       @default(0)
  flaggedQuestions     String?   // JSON array of flagged question indices
  lastSavedAt         DateTime  @default(now())
  isCompleted         Boolean   @default(false)
  sessionStartedAt    DateTime? // When the current session started
  user                User      @relation(fields: [userId], references: [id])
  quiz                Quiz      @relation(fields: [quizId], references: [id])

  @@unique([userId, quizId])
}

model Profile {
  id            Int      @id @default(autoincrement())
  userId        Int      @unique
  fullName      String?
  firstName     String?
  lastName      String?
  nickname      String?
  headline      String?
  jobTitle      String?
  company       String?
  grade         String?
  school        String?
  bio           String?
  avatar        String?
  website       String?
  location      String?
  phone         String?
  linkedin      String?
  github        String?
  twitter       String?
  preferences   String?
  learningGoals String?
  timezone      String?
  language      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id])
}

model Account {
  id                 Int     @id @default(autoincrement())
  userId             Int
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           Int      @id @default(autoincrement())
  sessionToken String   @unique
  userId       Int
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model BlockProgress {
  id          Int      @id @default(autoincrement())
  userId      Int
  chapterId   Int
  blockId     String  // Unique identifier for the block (e.g., "block-0", "block-1")
  blockType   String  // "quiz", "simulation", "code-editor", etc.
  completed   Boolean @default(false)
  score       Float?
  attempts    Int     @default(0)
  data        String? // JSON for additional state (quiz answers, simulation state, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapter     Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  
  @@unique([userId, chapterId, blockId])
  @@index([userId, chapterId])
}

model Classroom {
  id          Int                   @id @default(autoincrement())
  title       String
  description String?
  isPrivate   Boolean               @default(true)
  createdBy   Int
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  creator     User                  @relation("ClassroomCreator", fields: [createdBy], references: [id])
  memberships ClassroomMembership[]
  posts       ClassroomPost[]
  resources   ClassroomResource[]
  assessments Assessment[]

  @@index([createdBy])
}

model ClassroomMembership {
  id          Int             @id @default(autoincrement())
  classroomId Int
  userId      Int
  role        String          @default("STUDENT")
  status      String          @default("PENDING")
  createdAt   DateTime        @default(now())

  classroom   Classroom       @relation(fields: [classroomId], references: [id])
  user        User            @relation("UserClassroomMemberships", fields: [userId], references: [id])

  @@unique([classroomId, userId])
  @@index([userId])
}

model ClassroomPost {
  id          Int       @id @default(autoincrement())
  classroomId Int
  authorId    Int
  content     String
  pinned      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  classroom   Classroom @relation(fields: [classroomId], references: [id])
  author      User      @relation("UserClassroomPosts", fields: [authorId], references: [id])
  comments    ClassroomComment[]

  @@index([classroomId])
  @@index([authorId])
}

model ClassroomComment {
  id        Int       @id @default(autoincrement())
  postId    Int
  authorId  Int
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  post      ClassroomPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    User          @relation("UserClassroomComments", fields: [authorId], references: [id])

  @@index([postId])
  @@index([authorId])
}

model ClassroomResource {
  id          Int        @id @default(autoincrement())
  classroomId Int
  courseId    Int?
  quizId      Int?
  pinnedAt    DateTime?  @default(now())
  addedBy     Int

  classroom   Classroom  @relation(fields: [classroomId], references: [id])
  course      Course?    @relation("CourseClassroomResources", fields: [courseId], references: [id])
  quiz        Quiz?      @relation("QuizClassroomResources", fields: [quizId], references: [id])
  addedByUser User       @relation("UserAddedResources", fields: [addedBy], references: [id])

  @@index([classroomId])
  @@index([courseId])
  @@index([quizId])
  @@index([addedBy])
}

model Assessment {
  id           Int          @id @default(autoincrement())
  classroomId  Int
  title        String
  description  String?
  type         String       @default("exercise")
  maxScore     Int
  dueAt        DateTime?
  status       String       @default("draft") // draft | published
  resources    Json?
  createdBy    Int
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  classroom    Classroom    @relation(fields: [classroomId], references: [id])
  creator      User         @relation("AssessmentCreator", fields: [createdBy], references: [id])
  submissions  AssessmentSubmission[]

  @@index([classroomId])
  @@index([dueAt])
}

model AssessmentSubmission {
  id           Int        @id @default(autoincrement())
  assessmentId Int
  studentId    Int
  status       String     @default("assigned") // assigned | handed_in | graded | rejected
  submittedAt  DateTime?
  gradedAt     DateTime?
  score        Float?
  comment      String?
  files        Json?
  graderId     Int?
  late         Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  student      User       @relation("AssessmentStudent", fields: [studentId], references: [id])
  grader       User?      @relation("AssessmentGrader", fields: [graderId], references: [id])

  @@unique([assessmentId, studentId])
  @@index([studentId])
}
