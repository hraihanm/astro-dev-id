---
import { getTranslations } from '../lib/i18n';

export interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;

// Server-side locale detection from cookie
const cookieLocale = Astro.cookies.get('locale')?.value;
const currentLocale = (cookieLocale === 'en' || cookieLocale === 'id') ? cookieLocale : 'id';

// Get translations for server-side rendering (if we were to use them directly)
// For now, we just ensure the client knows the correct initial locale
---

<!DOCTYPE html>
<html lang={currentLocale} id="html-root">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title}</title>
  {description && <meta name="description" content={description}>}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <link rel="stylesheet" href="/src/styles/global.css">
  <script is:inline define:vars={{ initialLocale: currentLocale }}>
    // Inline critical translation script
    console.log('=== INLINE I18N SCRIPT LOADING ===');
    
    // Use server-provided locale as source of truth
    let currentLocale = initialLocale;
    console.log('Initial locale from server:', currentLocale);
    
    // Sync to localStorage for client-side logic compatibility
    localStorage.setItem('locale', currentLocale);
    
    // Listen for DOM content loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up language switcher');
      
      const switcher = document.getElementById('locale-switcher');
      console.log('Language switcher element:', switcher);
      
      if (switcher) {
        // Set current value
        switcher.value = currentLocale;
        console.log('Set switcher value to:', currentLocale);
        
        // Add change listener
        switcher.addEventListener('change', function(e) {
          const newLocale = e.target.value;
          console.log('Language switched to:', newLocale);
          
          // Save to localStorage AND Cookie
          localStorage.setItem('locale', newLocale);
          document.cookie = `locale=${newLocale}; path=/; max-age=31536000`; // 1 year
          
          // Reload the page to apply new language via server
          console.log('Reloading page...');
          window.location.reload();
        });
        
        console.log('Language switcher setup complete');
      } else {
        console.error('Language switcher not found!');
      }
    });
  </script>
  <script type="module" src="/src/lib/i18n/client.ts"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow-sm border-b">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <a href="/" class="text-xl font-bold text-blue-600" data-i18n="nav.myLearningPortal">My Learning Portal</a>
        </div>
        <div class="flex items-center space-x-4">
          <a href="/courses" class="text-gray-700 hover:text-blue-600" data-i18n="nav.courses">Courses</a>
          <a href="/quizzes" class="text-gray-700 hover:text-blue-600">Kuis Latihan</a>
          <a href="/admin" class="text-gray-700 hover:text-blue-600" data-i18n="nav.admin">Admin</a>
          <a href="/auth/signin" class="text-gray-700 hover:text-blue-600" data-i18n="nav.signIn">Sign In</a>
          <select id="locale-switcher" class="text-gray-700 bg-transparent border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="en" selected={currentLocale === 'en'}>English</option>
            <option value="id" selected={currentLocale === 'id'}>Bahasa Indonesia</option>
          </select>
        </div>
      </div>
    </nav>
  </header>
  
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <slot />
  </main>
</body>
</html>

