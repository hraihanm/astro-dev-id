---
export const prerender = false;

import Layout from '../../../../components/Layout.astro';
import Icon from '../../../../components/icons/Icon.astro';
import { prisma } from '../../../../lib/db';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/courses');
}

const course = await prisma.course.findUnique({
  where: { id: parseInt(id) },
  include: {
    chapters: {
      orderBy: { order: 'asc' }
    },
    quizzes: {
      orderBy: { id: 'desc' }
    }
  }
});

if (!course) {
  return Astro.redirect('/admin/courses');
}
---

<Layout title={`Edit ${course.title}`}>
  <div class="min-h-screen bg-slate-50">
    <!-- Header -->
    <div class="bg-white border-b border-slate-200 sticky top-0 z-10">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <a href="/admin/courses" class="text-slate-500 hover:text-slate-700 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
            </a>
            <div>
              <h1 class="text-lg font-bold text-slate-900">{course.title}</h1>
              <p class="text-sm text-slate-500">Edit Kursus</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <a href={`/courses/${course.slug}`} target="_blank" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
              Pratinjau
            </a>
            <button type="submit" form="course-form" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
              Simpan Perubahan
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Course Info Card -->
          <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50">
              <h2 class="font-bold text-slate-900 flex items-center gap-2">
                <Icon name="pencil" class="w-4 h-4" />
                <span>Informasi Kursus</span>
              </h2>
            </div>
            <form id="course-form" class="p-6 space-y-5">
              <input type="hidden" name="courseId" value={course.id} />
              
              <div>
                <label for="title" class="block text-sm font-medium text-slate-700 mb-1.5">
                  Judul Kursus
                </label>
                <input
                  type="text"
                  name="title"
                  id="title"
                  required
                  value={course.title}
                  class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                  placeholder="Misalnya: Pengantar Astronomi"
                />
              </div>

              <div>
                <label for="slug" class="block text-sm font-medium text-slate-700 mb-1.5">
                  URL Slug
                </label>
                <div class="flex items-center">
                  <span class="text-slate-500 text-sm mr-2">/courses/</span>
                  <input
                    type="text"
                    name="slug"
                    id="slug"
                    required
                    value={course.slug}
                    class="flex-1 px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                    placeholder="pengantar-astronomi"
                  />
                </div>
              </div>

              <div>
                <label for="description" class="block text-sm font-medium text-slate-700 mb-1.5">
                  Deskripsi
                </label>
                <textarea
                  name="description"
                  id="description"
                  rows="3"
                  class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
                  placeholder="Deskripsi singkat tentang kursus ini..."
                >{course.description}</textarea>
              </div>

              <div>
                <label for="visibility" class="block text-sm font-medium text-slate-700 mb-1.5">
                  Visibilitas
                </label>
                <select
                  id="visibility"
                  name="visibility"
                  class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                >
                  <option value="PUBLIC" selected={course.visibility !== 'PRIVATE'}>Publik (semua pengguna)</option>
                  <option value="PRIVATE" selected={course.visibility === 'PRIVATE'}>Privat (admin & kelas terkait)</option>
                </select>
                <p class="text-xs text-slate-500 mt-1">
                  Privat: hanya admin atau anggota kelas yang menautkan kursus ini. Publik: semua pengguna dapat mengakses.
                </p>
              </div>
            </form>
          </div>

          <!-- Course Structure - Khan Academy Style -->
          <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
              <h2 class="font-bold text-slate-900 flex items-center gap-2">
                <Icon name="book-stack" class="w-4 h-4" />
                <span>Struktur Kursus</span>
              </h2>
              <a
                href={`/admin/courses/${course.id}/chapters/new`}
                class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span>Tambah Bab</span>
              </a>
            </div>
            <div class="px-6 py-2 border-b border-slate-100 bg-slate-50 flex items-center justify-between text-sm text-slate-600">
              <span>Seret pegangan untuk mengubah urutan bab.</span>
              <span id="chapter-order-status" class="hidden font-medium"></span>
            </div>
            
            <div class="divide-y divide-slate-100" id="chapter-list">
              {course.chapters.length === 0 ? (
                <div class="p-8 text-center">
                  <div class="w-16 h-16 mx-auto mb-4 bg-slate-100 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                  </div>
                  <p class="text-slate-500 mb-4">Belum ada bab. Tambahkan bab pertama untuk memulai.</p>
                  <a
                    href={`/admin/courses/${course.id}/chapters/new`}
                    class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span>Tambah Bab Pertama</span>
                  </a>
                </div>
              ) : (
                course.chapters.map((chapter) => (
                  <div
                    class="chapter-item group flex items-center gap-4 px-6 py-4 hover:bg-slate-50 transition-colors cursor-grab"
                    draggable="true"
                    data-chapter-id={chapter.id}
                  >
                    <!-- Chapter Number -->
                    <div class="chapter-order-badge flex-shrink-0 w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-blue-700 font-bold">
                      {chapter.order}
                    </div>
                    
                    <!-- Chapter Info -->
                    <div class="flex-1 min-w-0">
                      <h3 class="font-medium text-slate-900 truncate">{chapter.title}</h3>
                      <p class="text-sm text-slate-500 truncate">
                        {chapter.content ? `${chapter.content.substring(0, 60)}...` : 'Belum ada konten'}
                      </p>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex-shrink-0 flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                      <a 
                        href={`/courses/${course.slug}/chapter/${chapter.order}`}
                        target="_blank"
                        class="p-2 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors"
                        title="Pratinjau"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                      </a>
                      <a 
                        href={`/admin/courses/${course.id}/chapters/${chapter.id}/edit`}
                        class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                        title="Edit"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      </a>
                    </div>
                    
                    <!-- Drag Handle (for future) -->
                    <div class="chapter-drag-handle flex-shrink-0 text-slate-400 cursor-grab" title="Geser untuk mengurutkan">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                      </svg>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Stats Card -->
          <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm">
            <h3 class="font-bold text-slate-900 mb-4">Statistik Kursus</h3>
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <span class="text-slate-600">Total Bab</span>
                <span class="font-bold text-slate-900">{course.chapters.length}</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-slate-600">Total Kuis</span>
                <span class="font-bold text-slate-900">{course.quizzes.length}</span>
              </div>
            </div>
          </div>

          <!-- Quizzes Card -->
          <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
            <div class="px-5 py-4 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
              <h3 class="font-bold text-slate-900 flex items-center gap-2">
                <Icon name="pencil" class="w-4 h-4" />
                <span>Kuis</span>
              </h3>
            </div>
            
            <div class="p-5 space-y-4">
              <!-- Import Quiz -->
              <details class="group">
                <summary class="flex items-center justify-between cursor-pointer text-sm font-medium text-blue-600 hover:text-blue-700">
                  <span>+ Impor Kuis Baru</span>
                  <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </summary>
                
                <div class="mt-4 space-y-3">
                  <form id="quiz-import-form" class="space-y-3">
                    <input type="hidden" name="courseId" value={course.id} />
                    
                    <div>
                      <input
                        type="text"
                        name="title"
                        id="quiz-title"
                        required
                        class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Judul Kuis"
                      />
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                      <input
                        type="number"
                        name="timeLimit"
                        id="time-limit"
                        min="1"
                        class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Waktu (menit)"
                      />
                      <input
                        type="number"
                        name="maxAttempts"
                        id="max-attempts"
                        min="1"
                        class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Maks Percobaan"
                      />
                    </div>
                    
                    <div>
                      <input
                        type="file"
                        id="quiz-file"
                        name="file"
                        accept=".md,.txt"
                        required
                        class="w-full text-sm text-slate-500 file:mr-2 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                      />
                    </div>
                    
                    <button
                      type="submit"
                      id="quiz-import-btn"
                      class="w-full py-2 px-4 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
                    >
                      Impor
                    </button>
                  </form>
                  
                  <div id="import-status" class="hidden text-sm"></div>
                </div>
              </details>
              
              <!-- Quiz List -->
              <div id="quiz-list" class="space-y-2">
                {course.quizzes.length === 0 ? (
                  <p class="text-sm text-slate-500 text-center py-4">Belum ada kuis</p>
                ) : (
                  course.quizzes.map((quiz) => (
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                      <div class="min-w-0 flex-1">
                        <p class="font-medium text-slate-900 text-sm truncate">{quiz.title}</p>
                      </div>
                      <div class="flex items-center gap-1 ml-2">
                        <a href={`/admin/quizzes/${quiz.id}/edit`} class="p-1.5 text-slate-400 hover:text-blue-600 rounded">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                          </svg>
                        </a>
                        <button class="delete-quiz-btn p-1.5 text-slate-400 hover:text-red-600 rounded" data-id={quiz.id} data-title={quiz.title}>
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="bg-white rounded-xl border border-red-200 overflow-hidden shadow-sm">
            <div class="px-5 py-4 border-b border-red-100 bg-red-50">
              <h3 class="font-bold text-red-900">Zona Berbahaya</h3>
            </div>
            <div class="p-5">
              <p class="text-sm text-slate-600 mb-4">Menghapus kursus akan menghapus semua bab dan kuis terkait.</p>
              <button
                type="button"
                id="delete-btn"
                class="w-full py-2 px-4 text-sm font-medium text-red-700 bg-red-50 border border-red-300 rounded-lg hover:bg-red-100 transition-colors"
              >
                Hapus Kursus
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ courseId: course.id }}>
  // Form submission
  document.getElementById('course-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    const courseData = {
      title: formData.get('title'),
      slug: formData.get('slug'),
      description: formData.get('description'),
      visibility: formData.get('visibility')
    };
    
    try {
      const response = await fetch(`/api/admin/courses/${courseId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(courseData)
      });
      
      if (response.ok) {
        window.location.reload();
      } else {
        const error = await response.json();
        alert('Gagal menyimpan: ' + (error.error || 'Kesalahan tidak dikenal'));
      }
    } catch (error) {
      alert('Gagal menyimpan perubahan');
    }
  });

  // Delete course
  document.getElementById('delete-btn')?.addEventListener('click', async () => {
    if (!confirm('Apakah Anda yakin ingin menghapus kursus ini? Semua bab dan kuis akan dihapus.')) {
      return;
    }

    try {
      const response = await fetch(`/api/admin/courses/${courseId}`, { method: 'DELETE' });
      
      if (response.ok) {
        window.location.href = '/admin/courses';
      } else {
        const error = await response.json();
        alert('Gagal menghapus: ' + (error.error || 'Kesalahan tidak dikenal'));
      }
    } catch (error) {
      alert('Gagal menghapus kursus');
    }
  });

  // Quiz import
  document.getElementById('quiz-import-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const statusDiv = document.getElementById('import-status');
    const submitBtn = document.getElementById('quiz-import-btn');
    
    const title = form.querySelector('#quiz-title')?.value;
    const file = form.querySelector('#quiz-file')?.files?.[0];
    
    if (!title || !file) {
      statusDiv.className = 'p-3 bg-red-50 text-red-700 text-sm rounded-lg';
      statusDiv.textContent = 'Harap isi judul dan pilih file';
      statusDiv.classList.remove('hidden');
      return;
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Mengimpor...';
    statusDiv.className = 'p-3 bg-blue-50 text-blue-700 text-sm rounded-lg';
    statusDiv.textContent = 'Mengimpor...';
    statusDiv.classList.remove('hidden');
    
    const formData = new FormData(form);
    
    try {
      const response = await fetch('/api/admin/quiz/import', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (response.ok) {
        statusDiv.className = 'p-3 bg-emerald-50 text-emerald-700 text-sm rounded-lg';
        statusDiv.textContent = `âœ“ Berhasil mengimpor ${result.questions?.length || 0} soal`;
        form.reset();
        setTimeout(() => window.location.reload(), 1500);
      } else {
        statusDiv.className = 'p-3 bg-red-50 text-red-700 text-sm rounded-lg';
        statusDiv.textContent = 'Gagal: ' + (result.error || 'Kesalahan tidak dikenal');
      }
    } catch (error) {
      statusDiv.className = 'p-3 bg-red-50 text-red-700 text-sm rounded-lg';
      statusDiv.textContent = 'Gagal mengimpor kuis';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Impor';
    }
  });

  // Delete quiz buttons
  document.querySelectorAll('.delete-quiz-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const quizId = btn.dataset.id;
      const quizTitle = btn.dataset.title;
      
      if (!confirm(`Hapus kuis "${quizTitle}"?`)) return;
      
      try {
        const response = await fetch(`/api/admin/quiz/${quizId}/delete`, { method: 'DELETE' });
        
        if (response.ok) {
          window.location.reload();
        } else {
          alert('Gagal menghapus kuis');
        }
      } catch (error) {
        alert('Gagal menghapus kuis');
      }
    });
  });

  // Chapter drag-and-drop ordering
  const chapterList = document.getElementById('chapter-list');
  const chapterOrderStatus = document.getElementById('chapter-order-status');

  if (chapterList) {
    let draggedItem = null;
    let initialOrder = [];

    const items = Array.from(chapterList.querySelectorAll('.chapter-item'));
    items.forEach((item) => attachDragHandlers(item));

    function attachDragHandlers(item) {
      item.addEventListener('dragstart', (e) => {
        draggedItem = item;
        initialOrder = Array.from(chapterList.querySelectorAll('.chapter-item')).map((el) => el.dataset.chapterId || '');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', item.dataset.chapterId || '');
        item.classList.add('opacity-60', 'ring-2', 'ring-blue-200', 'cursor-grabbing');
      });

      item.addEventListener('dragenter', (e) => {
        e.preventDefault();
        if (item !== draggedItem) {
          item.classList.add('bg-slate-50');
        }
      });

      item.addEventListener('dragover', (e) => e.preventDefault());

      item.addEventListener('dragleave', () => {
        item.classList.remove('bg-slate-50');
      });

      item.addEventListener('drop', (e) => {
        e.preventDefault();
        item.classList.remove('bg-slate-50');

        if (!draggedItem || draggedItem === item) {
          return;
        }

        const rect = item.getBoundingClientRect();
        const placeAfter = (e.clientY - rect.top) > rect.height / 2;

        if (placeAfter) {
          item.after(draggedItem);
        } else {
          item.before(draggedItem);
        }

        finalizeOrderChange(initialOrder);
      });

      item.addEventListener('dragend', () => {
        item.classList.remove('opacity-60', 'ring-2', 'ring-blue-200', 'cursor-grabbing', 'bg-slate-50');
        draggedItem = null;
      });
    }

    function updateOrderBadges() {
      chapterList.querySelectorAll('.chapter-item').forEach((item, index) => {
        const badge = item.querySelector('.chapter-order-badge');
        if (badge) {
          badge.textContent = String(index + 1);
        }
      });
    }

    function showOrderStatus(message, type = 'info') {
      if (!chapterOrderStatus) return;

      chapterOrderStatus.classList.remove('hidden', 'text-emerald-600', 'text-red-600', 'text-slate-600');

      if (type === 'success') {
        chapterOrderStatus.classList.add('text-emerald-600');
      } else if (type === 'error') {
        chapterOrderStatus.classList.add('text-red-600');
      } else {
        chapterOrderStatus.classList.add('text-slate-600');
      }

      chapterOrderStatus.textContent = message;
    }

    function restoreOrder(orderIds) {
      const lookup = new Map(
        Array.from(chapterList.querySelectorAll('.chapter-item')).map((el) => [el.dataset.chapterId || '', el])
      );

      chapterList.innerHTML = '';
      orderIds.forEach((id) => {
        const el = lookup.get(id);
        if (el) {
          chapterList.appendChild(el);
        }
      });

      updateOrderBadges();
    }

    async function persistOrder(previousOrder, nextOrder) {
      try {
        showOrderStatus('Menyimpan urutan...', 'info');

        const response = await fetch(`/api/admin/courses/${courseId}/chapters`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chapterIds: nextOrder.map((cid) => Number(cid)) })
        });

        if (!response.ok) {
          const error = await response.json().catch(() => null);
          throw new Error(error?.error || 'Gagal menyimpan urutan');
        }

        showOrderStatus('Urutan tersimpan', 'success');
      } catch (error) {
        restoreOrder(previousOrder);
        showOrderStatus(error?.message || 'Gagal menyimpan urutan', 'error');
      }
    }

    function finalizeOrderChange(previousOrder) {
      const nextOrder = Array.from(chapterList.querySelectorAll('.chapter-item')).map((el) => el.dataset.chapterId || '');

      if (nextOrder.join(',') === previousOrder.join(',')) {
        updateOrderBadges();
        return;
      }

      updateOrderBadges();
      persistOrder(previousOrder, nextOrder);
    }
  }
</script>
