---
import Layout from '../../../components/Layout.astro';
import { requireAdmin } from '../../../lib/auth-guard';
import { prisma } from '../../../lib/db';

// Prisma types may lag in some editors; use a local alias.
const db = prisma as any;

export const prerender = false;

const admin = await requireAdmin(Astro.cookies);
if (!admin) {
  return Astro.redirect('/');
}

const classrooms = await db.classroom.findMany({
  orderBy: { createdAt: 'desc' },
  include: {
    _count: { select: { memberships: true, posts: true, resources: true } },
    memberships: {
      include: { user: { select: { id: true, email: true, role: true } } },
      orderBy: { createdAt: 'asc' }
    }
  }
});
---

<Layout title="Admin • Classrooms" description="Kelola kelas, anggota, dan permintaan bergabung">
  <div class="min-h-screen bg-gray-50">
    <div class="bg-white shadow-sm border-b border-gray-200">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex items-center justify-between">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Admin</p>
          <h1 class="text-2xl font-bold text-slate-900">Classrooms</h1>
          <p class="text-sm text-slate-600">Buat kelas baru dan kelola permintaan bergabung.</p>
        </div>
        <a
          href="/admin"
          class="text-sm text-blue-600 hover:text-blue-700 font-semibold"
        >
          ← Dashboard
        </a>
      </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
      <section class="bg-white border border-slate-200 rounded-xl shadow-sm p-5 space-y-4">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">Buat Kelas</h2>
          <p class="text-sm text-slate-600">Guru akan otomatis diset sebagai pembuat.</p>
        </div>
        <form id="create-class-form" class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-slate-700">Judul</label>
            <input name="title" class="mt-1 w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500" placeholder="Contoh: Kelas Fisika 10A" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">Deskripsi</label>
            <textarea name="description" rows="2" class="mt-1 w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500" placeholder="Ringkasan kelas"></textarea>
          </div>
          <button type="submit" class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors" id="create-class-submit">
            Buat kelas
          </button>
          <span id="create-class-status" class="text-sm text-slate-600"></span>
        </form>
      </section>

      <section class="space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-900">Daftar Kelas</h2>
          <p class="text-sm text-slate-600">{classrooms.length} kelas</p>
        </div>

        {classrooms.length === 0 ? (
          <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-5 text-slate-700">
            Belum ada kelas.
          </div>
        ) : (
          <div class="space-y-4">
            {classrooms.map((cls: any) => {
              const pending = cls.memberships.filter((m: any) => m.status === 'PENDING');
              return (
                <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-5 space-y-3">
                  <div class="flex items-center justify-between">
                    <div>
                      <h3 class="text-lg font-semibold text-slate-900">{cls.title}</h3>
                      <p class="text-sm text-slate-600">{cls.description || 'Tidak ada deskripsi'}</p>
                    </div>
                    <div class="text-xs text-slate-500 space-x-3">
                      <span class="inline-flex items-center gap-1.5">
                        <svg class="w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M16 7a4 4 0 10-8 0v2a4 4 0 008 0V7zM5 10a7 7 0 0014 0V8.5M7 21h10" />
                        </svg>
                        {cls._count.memberships} anggota
                      </span>
                      <span class="inline-flex items-center gap-1.5">
                        <svg class="w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M7 4h10a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V6a2 2 0 012-2z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M9 9h6M9 13h6M9 17h3" />
                        </svg>
                        {cls._count.posts} post
                      </span>
                      <span class="inline-flex items-center gap-1.5">
                        <svg class="w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M12 6l-6 4v8l6-4 6 4v-8l-6-4z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M12 6v8" />
                        </svg>
                        {cls._count.resources} resource
                      </span>
                    </div>
                  </div>

                  {pending.length > 0 ? (
                    <div class="border border-amber-200 bg-amber-50 rounded-lg p-3 space-y-2">
                      <div class="text-sm font-semibold text-amber-800">Permintaan bergabung ({pending.length})</div>
                      {pending.map((m: any) => (
                        <div class="flex items-center justify-between bg-white border border-slate-100 rounded-lg px-3 py-2">
                          <div class="text-sm text-slate-800">{m.user.email}</div>
                          <div class="flex items-center gap-2">
                            <button
                              type="button"
                              class="px-3 py-1 text-xs font-semibold rounded-lg bg-green-600 text-white hover:bg-green-700"
                              data-approve={m.userId}
                              data-class={cls.id}
                            >
                              Setujui
                            </button>
                            <button
                              type="button"
                              class="px-3 py-1 text-xs font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700"
                              data-reject={m.userId}
                              data-class={cls.id}
                            >
                              Tolak
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p class="text-sm text-slate-600">Tidak ada permintaan bergabung.</p>
                  )}

                  <div class="flex items-center gap-3 text-sm">
                    <a href={`/classrooms/${cls.id}`} class="text-blue-600 hover:text-blue-700 font-semibold">Lihat kelas →</a>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </section>
    </div>
  </div>

  <script type="module">
    const form = document.querySelector('#create-class-form');
    const statusEl = document.querySelector('#create-class-status');
    const submitBtn = document.querySelector('#create-class-submit');
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const title = data.get('title')?.toString().trim();
      const description = data.get('description')?.toString().trim();
      if (!title) {
        statusEl.textContent = 'Judul wajib diisi.';
        return;
      }
      submitBtn.textContent = 'Membuat...';
      submitBtn.setAttribute('disabled', 'true');
      statusEl.textContent = '';
      try {
        const res = await fetch('/api/classrooms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description })
        });
        if (res.ok) {
          statusEl.textContent = 'Berhasil dibuat. Memuat ulang...';
          location.reload();
        } else {
          const body = await res.json().catch(() => ({}));
          statusEl.textContent = body.error || 'Gagal membuat kelas.';
        }
      } catch (err) {
        statusEl.textContent = 'Tidak dapat membuat kelas.';
      } finally {
        submitBtn.textContent = 'Buat kelas';
        submitBtn.removeAttribute('disabled');
      }
    });

    document.querySelectorAll('[data-approve]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const userId = btn.getAttribute('data-approve');
        const classId = btn.getAttribute('data-class');
        btn.textContent = 'Menyetujui...';
        btn.setAttribute('disabled', 'true');
        try {
          const res = await fetch(`/api/classrooms/${classId}/members`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, status: 'ACTIVE', role: 'STUDENT' })
          });
          if (res.ok) {
            location.reload();
          } else {
            const body = await res.json().catch(() => ({}));
            alert(body.error || 'Gagal menyetujui.');
          }
        } finally {
          btn.textContent = 'Setujui';
          btn.removeAttribute('disabled');
        }
      });
    });

    document.querySelectorAll('[data-reject]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const userId = btn.getAttribute('data-reject');
        const classId = btn.getAttribute('data-class');
        btn.textContent = 'Menolak...';
        btn.setAttribute('disabled', 'true');
        try {
          const res = await fetch(`/api/classrooms/${classId}/members`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId })
          });
          if (res.ok) {
            location.reload();
          } else {
            const body = await res.json().catch(() => ({}));
            alert(body.error || 'Gagal menolak.');
          }
        } finally {
          btn.textContent = 'Tolak';
          btn.removeAttribute('disabled');
        }
      });
    });
  </script>
</Layout>
