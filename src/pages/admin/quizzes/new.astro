---
export const prerender = false;

import Layout from '../../../components/Layout.astro';
---

<Layout title="Create Standalone Quiz">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow mb-8">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <a href="/admin/quizzes" class="text-gray-700 hover:text-blue-600 mr-4">‚Üê Kembali ke Kuis</a>
            <h1 class="text-2xl font-bold text-gray-900">Buat Kuis Mandiri</h1>
          </div>
        </div>
      </div>
    </div>

    <!-- Quiz Creation Options -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      
      <!-- Import/Create Tabs -->
      <div class="mb-6">
        <div class="border-b border-gray-200">
          <nav class="-mb-px flex space-x-4">
            <button
              type="button"
              id="manual-tab"
              class="tab-button active py-2 px-4 border-b-2 border-blue-500 text-sm font-medium text-blue-600 cursor-pointer"
              onclick="
                document.getElementById('manual-section').classList.remove('hidden');
                document.getElementById('import-section').classList.add('hidden');
                this.classList.add('border-blue-500', 'text-blue-600');
                this.classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('import-tab').classList.remove('border-blue-500', 'text-blue-600');
                document.getElementById('import-tab').classList.add('border-transparent', 'text-gray-500');
              "
            >
              Buat Manual
            </button>
            <button
              type="button"
              id="import-tab"
              class="tab-button py-2 px-4 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 cursor-pointer"
              onclick="
                document.getElementById('import-section').classList.remove('hidden');
                document.getElementById('manual-section').classList.add('hidden');
                this.classList.add('border-blue-500', 'text-blue-600');
                this.classList.remove('border-transparent', 'text-gray-500');
                document.getElementById('manual-tab').classList.remove('border-blue-500', 'text-blue-600');
                document.getElementById('manual-tab').classList.add('border-transparent', 'text-gray-500');
              "
            >
              Impor dari Markdown
            </button>
          </nav>
        </div>
      </div>
      
      <!-- Import Section -->
      <div id="import-section" class="hidden mb-8">
        <div class="bg-white shadow sm:rounded-lg p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Impor Kuis Mandiri dari Markdown</h3>
          
          <!-- Quiz Import -->
          <div class="mb-6 p-4 border-2 border-dashed border-gray-300 rounded-lg">
            <h4 class="text-sm font-medium text-gray-900 mb-3">Kuis Pilihan Ganda</h4>
            <form id="standalone-quiz-import-form" method="POST" action="/api/admin/quiz/import-standalone" enctype="multipart/form-data">
              <div class="space-y-3">
                <div>
                  <label for="standalone-quiz-title" class="block text-sm font-medium text-gray-700">
                    Judul Kuis
                  </label>
                  <input
                    type="text"
                    id="standalone-quiz-title"
                    name="title"
                    required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Misalnya, Kuis Latihan Matematika"
                  />
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label for="standalone-time-limit" class="block text-sm font-medium text-gray-700">
                      Batas Waktu (menit)
                    </label>
                    <input
                      type="number"
                      id="standalone-time-limit"
                      name="timeLimit"
                      min="0"
                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"
                      placeholder="30"
                    />
                  </div>
                  
                  <div>
                    <label for="standalone-max-attempts" class="block text-sm font-medium text-gray-700">
                      Maksimum Percobaan
                    </label>
                    <input
                      type="number"
                      id="standalone-max-attempts"
                      name="maxAttempts"
                      min="0"
                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"
                      placeholder="3"
                    />
                  </div>
                </div>
                
                <div>
                  <label for="standalone-quiz-file" class="block text-sm font-medium text-gray-700">
                    File Kuis (.md)
                  </label>
                  <input
                    type="file"
                    id="standalone-quiz-file"
                    name="file"
                    accept=".md,.txt"
                    required
                    class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                  />
                  <p class="mt-1 text-xs text-gray-500">
                    Unggah file Markdown berisi pertanyaan kuis.
                  </p>
                </div>
                
                <button
                  type="submit"
                  id="standalone-quiz-import-btn"
                  class="w-full bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  Impor Kuis
                </button>
              </div>
            </form>
            <div id="standalone-quiz-import-status" class="mt-3 hidden"></div>
          </div>
          
          <!-- Essay Import -->
          <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg">
            <h4 class="text-sm font-medium text-gray-900 mb-3">Soal Essay</h4>
            <form id="standalone-essay-import-form" method="POST" action="/api/admin/essay/import-standalone" enctype="multipart/form-data">
              <div class="space-y-3">
                <div>
                  <label for="standalone-essay-title" class="block text-sm font-medium text-gray-700">
                    Judul Soal Essay
                  </label>
                  <input
                    type="text"
                    id="standalone-essay-title"
                    name="title"
                    required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Misalnya, Soal Essay Fisika"
                  />
                </div>
                
                <div>
                  <label for="standalone-essay-file" class="block text-sm font-medium text-gray-700">
                    File Soal Essay (.md)
                  </label>
                  <input
                    type="file"
                    id="standalone-essay-file"
                    name="file"
                    accept=".md,.txt"
                    required
                    class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"
                  />
                  <p class="mt-1 text-xs text-gray-500">
                    Unggah file Markdown dengan soal essay. Format: <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">## Judul Soal</code> untuk soal, <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">### Subsoal</code> untuk subsoal.
                  </p>
                </div>
                
                <button
                  type="submit"
                  class="w-full bg-purple-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
                >
                  Impor Soal Essay
                </button>
              </div>
            </form>
            <div id="standalone-essay-import-status" class="mt-3 hidden"></div>
          </div>
        </div>
      </div>
      
      <!-- Manual Creation Section -->
      <div id="manual-section">
      <form id="quiz-form" class="space-y-6">
        
        <!-- Quiz Info -->
        <div class="bg-white shadow px-4 py-5 sm:rounded-lg sm:p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-6">Informasi Kuis</h3>
          
          <div class="space-y-4">
            <div>
              <label for="title" class="block text-sm font-medium text-gray-700">
                Judul Kuis *
              </label>
              <input
                type="text"
                name="title"
                id="title"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="contoh: Kuis Dasar Matematika"
              />
            </div>

            <div>
              <label for="description" class="block text-sm font-medium text-gray-700">
                Deskripsi
              </label>
              <textarea
                name="description"
                id="description"
                rows="3"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="Deskripsi singkat tentang apa yang dicakup kuis ini..."
              ></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="timeLimit" class="block text-sm font-medium text-gray-700">
                  Batas Waktu (menit)
                </label>
                <input
                  type="number"
                  name="timeLimit"
                  id="timeLimit"
                  min="1"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                  placeholder="30"
                />
              </div>

              <div>
                <label for="maxAttempts" class="block text-sm font-medium text-gray-700">
                  Maksimal Percobaan
                </label>
                <input
                  type="number"
                  name="maxAttempts"
                  id="maxAttempts"
                  min="1"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                  placeholder="3"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Questions -->
        <div class="bg-white shadow px-4 py-5 sm:rounded-lg sm:p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">Pertanyaan</h3>
            <button
              type="button"
              id="add-question-btn"
              class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm"
            >
              + Tambah Pertanyaan
            </button>
          </div>

          <div id="questions-container" class="space-y-4">
            <p class="text-sm text-gray-500 text-center py-8">
              Belum ada pertanyaan. Klik "Tambah Pertanyaan" untuk memulai.
            </p>
          </div>
        </div>

        <!-- Submit -->
        <div class="flex justify-end space-x-4">
          <a href="/admin/quizzes" class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
            Batal
          </a>
          <button
            type="submit"
            class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
          >
            Buat Kuis
          </button>
        </div>
      </form>
    </div>

    <!-- Question Template (hidden) -->
    <template id="question-template">
      <div class="question-block border border-gray-200 rounded-lg p-4" data-question-id="">
        <div class="flex items-center justify-between mb-4">
          <h4 class="text-md font-medium text-gray-900">Pertanyaan <span class="question-number"></span></h4>
          <button type="button" class="delete-question text-red-600 hover:text-red-800 text-sm">
            Hapus
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Teks Pertanyaan</label>
            <textarea
              class="question-text block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              rows="3"
              placeholder="Masukkan pertanyaan Anda di sini..."
            ></textarea>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Pertanyaan</label>
              <select class="question-type block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="multiple-choice">Pilihan Ganda</option>
                <option value="complex">Pilihan Ganda Kompleks</option>
                <option value="text">Jawaban Teks</option>
                <option value="number">Jawaban Numerik</option>
              </select>
            </div>

            <div class="options-container">
              <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Opsi</label>
              <input
                type="number"
                class="num-options block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                min="2"
                max="10"
                value="4"
              />
            </div>
          </div>

          <div class="options-list space-y-2"></div>

          <div class="correct-answer-container">
            <label class="block text-sm font-medium text-gray-700 mb-2">Jawaban Benar</label>
            <input
              type="text"
              class="correct-answer block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder='Untuk ganda: "1, 3" atau tunggal: "2"'
            />
          </div>

          <div class="tolerance-container hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Toleransi (untuk numerik)</label>
            <input
              type="number"
              class="tolerance block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              step="0.01"
              value="0.01"
            />
          </div>
        </div>
      </div>
    </template>

    <script>
      let questionCounter = 0;
      const questionsContainer = document.getElementById('questions-container');
      const questionTemplate = document.getElementById('question-template');
      const addQuestionBtn = document.getElementById('add-question-btn');
      const quizForm = document.getElementById('quiz-form');

      // Add question
      addQuestionBtn?.addEventListener('click', () => {
        questionCounter++;
        const questionClone = questionTemplate.content.cloneNode(true);
        const questionBlock = questionClone.querySelector('.question-block');
        questionBlock?.setAttribute('data-question-id', questionCounter.toString());
        questionClone.querySelector('.question-number').textContent = questionCounter.toString();

        // Empty state message
        const emptyState = questionsContainer?.querySelector('p.text-center');
        if (emptyState) emptyState.remove();

        questionsContainer?.appendChild(questionClone);

        setupQuestionListeners(questionBlock);
      });

      // Setup listeners for a question
      function setupQuestionListeners(questionBlock) {
        // Delete button
        questionBlock.querySelector('.delete-question')?.addEventListener('click', () => {
          questionBlock.remove();
          if (questionsContainer && questionsContainer.querySelectorAll('.question-block').length === 0) {
            questionsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">Belum ada pertanyaan. Klik "Tambah Pertanyaan" untuk memulai.</p>';
          }
        });

        // Type change
        const typeSelect = questionBlock.querySelector('.question-type');
        const toleranceContainer = questionBlock.querySelector('.tolerance-container');
        const optionsContainer = questionBlock.querySelector('.options-container');

        typeSelect?.addEventListener('change', () => {
          if (typeSelect.value === 'number') {
            toleranceContainer?.classList.remove('hidden');
            optionsContainer?.classList.add('hidden');
          } else if (typeSelect.value === 'text') {
            toleranceContainer?.classList.add('hidden');
            optionsContainer?.classList.add('hidden');
          } else {
            toleranceContainer?.classList.add('hidden');
            optionsContainer?.classList.remove('hidden');
          }
          generateOptions(questionBlock);
        });

        // Number of options
        const numOptionsInput = questionBlock.querySelector('.num-options');
        numOptionsInput?.addEventListener('change', () => {
          generateOptions(questionBlock);
        });

        // Initial options
        generateOptions(questionBlock);
      }

      // Generate options
      function generateOptions(questionBlock) {
        const typeSelect = questionBlock.querySelector('.question-type');
        const numOptionsInput = questionBlock.querySelector('.num-options');
        const optionsList = questionBlock.querySelector('.options-list');

        if (typeSelect?.value === 'text' || typeSelect?.value === 'number') {
          optionsList.innerHTML = '';
          return;
        }

        const numOptions = parseInt(numOptionsInput?.value || '4');
        optionsList.innerHTML = '';

        for (let i = 0; i < numOptions; i++) {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'flex items-center space-x-2';
          optionDiv.innerHTML = `
            <label class="block text-sm font-medium text-gray-700 w-16">${String.fromCharCode(65 + i)}.</label>
            <input
              type="text"
              class="option-input block flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              placeholder="Opsi ${String.fromCharCode(65 + i)}"
            />
          `;
          optionsList.appendChild(optionDiv);
        }
      }

      // Form submit
      quizForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = (document.getElementById('title') as HTMLInputElement)?.value;
        const description = (document.getElementById('description') as HTMLTextAreaElement)?.value;
        const timeLimit = (document.getElementById('timeLimit') as HTMLInputElement)?.value;
        const maxAttempts = (document.getElementById('maxAttempts') as HTMLInputElement)?.value;

        if (!title) {
          alert('Quiz title is required');
          return;
        }

        const questions: any[] = [];
        const questionBlocks = document.querySelectorAll('.question-block');

        if (questionBlocks.length === 0) {
          alert('Please add at least one question');
          return;
        }

        questionBlocks.forEach((block) => {
          const type = (block.querySelector('.question-type') as HTMLSelectElement)?.value;
          const questionText = (block.querySelector('.question-text') as HTMLTextAreaElement)?.value;
          const correctAnswer = (block.querySelector('.correct-answer') as HTMLInputElement)?.value;

          if (!questionText || !correctAnswer) {
            alert('All questions must have text and correct answer');
            return;
          }

          const options: string[] = [];
          if (type !== 'text' && type !== 'number') {
            block.querySelectorAll('.option-input').forEach((input: any) => {
              options.push(input.value);
            });
          }

          const question: any = {
            id: questions.length + 1,
            type,
            question: questionText,
            options,
            correctAnswer: correctAnswer.includes(',') 
              ? correctAnswer.split(',').map((n: string) => parseInt(n.trim()))
              : parseInt(correctAnswer)
          };

          if (type === 'number') {
            const tolerance = parseFloat((block.querySelector('.tolerance') as HTMLInputElement)?.value || '0.01');
            question.tolerance = tolerance;
          }

          questions.push(question);
        });

        try {
          const response = await fetch('/api/admin/quiz/create-standalone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title,
              description,
              timeLimit: timeLimit ? parseInt(timeLimit) : undefined,
              maxAttempts: maxAttempts ? parseInt(maxAttempts) : undefined,
              questions
            })
          });

          const result = await response.json();

          if (response.ok) {
            window.location.href = '/admin/quizzes';
          } else {
            alert('Error creating quiz: ' + result.error);
          }
        } catch (error) {
          alert('Error creating quiz. Please try again.');
          console.error(error);
        }
      });
    </script>
    
    <!-- Import Options -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mt-8 border-t">
      <div class="bg-white shadow sm:rounded-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Atau Impor dari Markdown</h2>
        
        <!-- Quiz Import -->
        <div class="mb-6 p-4 border-2 border-dashed border-gray-300 rounded-lg">
          <h4 class="text-sm font-medium text-gray-900 mb-3">Kuis Pilihan Ganda</h4>
          <form id="standalone-quiz-import-form" onsubmit="return false;">
            <div class="space-y-3">
              <div>
                <label for="standalone-quiz-title" class="block text-sm font-medium text-gray-700">
                  Judul Kuis
                </label>
                <input
                  type="text"
                  id="standalone-quiz-title"
                  name="title"
                  required
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Misalnya, Kuis Latihan Matematika"
                />
              </div>
              
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label for="standalone-time-limit" class="block text-sm font-medium text-gray-700">
                    Batas Waktu (menit)
                  </label>
                  <input
                    type="number"
                    id="standalone-time-limit"
                    name="timeLimit"
                    min="0"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"
                    placeholder="30"
                  />
                </div>
                
                <div>
                  <label for="standalone-max-attempts" class="block text-sm font-medium text-gray-700">
                    Maksimum Percobaan
                  </label>
                  <input
                    type="number"
                    id="standalone-max-attempts"
                    name="maxAttempts"
                    min="0"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"
                    placeholder="3"
                  />
                </div>
              </div>
              
              <div>
                <label for="standalone-quiz-file" class="block text-sm font-medium text-gray-700">
                  File Kuis (.md)
                </label>
                <input
                  type="file"
                  id="standalone-quiz-file"
                  name="file"
                  accept=".md,.txt"
                  required
                  class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
              </div>
              
              <button
                type="submit"
                id="standalone-quiz-import-btn"
                class="w-full bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700"
              >
                Impor Kuis
              </button>
            </div>
          </form>
          <div id="standalone-quiz-import-status" class="mt-3 hidden"></div>
        </div>
        
        <!-- Essay Import -->
        <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg">
          <h4 class="text-sm font-medium text-gray-900 mb-3">Soal Essay</h4>
          <form id="standalone-essay-import-form" onsubmit="return false;">
            <div class="space-y-3">
              <div>
                <label for="standalone-essay-title" class="block text-sm font-medium text-gray-700">
                  Judul Soal Essay
                </label>
                <input
                  type="text"
                  id="standalone-essay-title"
                  name="title"
                  required
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Misalnya, Soal Essay Fisika"
                />
              </div>
              
              <div>
                <label for="standalone-essay-file" class="block text-sm font-medium text-gray-700">
                  File Soal Essay (.md)
                </label>
                <input
                  type="file"
                  id="standalone-essay-file"
                  name="file"
                  accept=".md,.txt"
                  required
                  class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"
                />
              </div>
              
              <button
                type="submit"
                class="w-full bg-purple-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-purple-700"
              >
                Impor Soal Essay
              </button>
            </div>
          </form>
          <div id="standalone-essay-import-status" class="mt-3 hidden"></div>
        </div>
      </div>
    </div>
    
    <script>
      // Handle standalone quiz import
      document.getElementById('standalone-quiz-import-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const form = e.target as HTMLFormElement;
        const statusDiv = document.getElementById('standalone-quiz-import-status');
        const submitBtn = document.getElementById('standalone-quiz-import-btn') as HTMLButtonElement;
        
        const title = (form.querySelector('#standalone-quiz-title') as HTMLInputElement)?.value;
        const file = (form.querySelector('#standalone-quiz-file') as HTMLInputElement)?.files?.[0];
        
        if (!title || !file) {
          if (statusDiv) {
            statusDiv.className = 'mt-3 p-3 bg-red-50 border border-red-200 rounded text-red-700';
            statusDiv.textContent = '‚ùå Harap isi judul dan pilih file.';
            statusDiv.classList.remove('hidden');
          }
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Mengimpor...';
        
        statusDiv!.className = 'mt-3 p-3 bg-blue-50 border border-blue-200 rounded text-blue-700';
        statusDiv!.textContent = 'Mengimpor kuis...';
        statusDiv!.classList.remove('hidden');
        
        const formData = new FormData(form);
        
        try {
          const response = await fetch('/api/admin/quiz/import-standalone', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (response.ok) {
            statusDiv!.className = 'mt-3 p-3 bg-green-50 border border-green-200 rounded text-green-700';
            const count = result.questionCount || 0;
            statusDiv!.textContent = `‚úÖ Berhasil mengimpor ${count} pertanyaan!`;
            form.reset();
            setTimeout(() => {
              window.location.href = '/admin/quizzes';
            }, 1500);
          } else {
            statusDiv!.className = 'mt-3 p-3 bg-red-50 border border-red-200 rounded text-red-700';
            statusDiv!.textContent = `‚ùå ${result.error || 'Gagal mengimpor kuis'}`;
          }
        } catch (error) {
          statusDiv!.className = 'mt-3 p-3 bg-red-50 border border-red-200 rounded text-red-700';
          statusDiv!.textContent = `‚ùå Kesalahan: ${error instanceof Error ? error.message : 'Unknown'}`;
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Impor Kuis';
        }
      });
      
      // Handle standalone essay import
      document.getElementById('standalone-essay-import-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const form = e.target as HTMLFormElement;
        const statusDiv = document.getElementById('standalone-essay-import-status');
        const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
        
        const title = (form.querySelector('#standalone-essay-title') as HTMLInputElement)?.value;
        const file = (form.querySelector('#standalone-essay-file') as HTMLInputElement)?.files?.[0];
        
        if (!title || !file) {
          if (statusDiv) {
            statusDiv.className = 'mt-3 p-3 bg-red-50 border border-red-200 rounded text-red-700';
            statusDiv.textContent = '‚ùå Harap isi judul dan pilih file.';
            statusDiv.classList.remove('hidden');
          }
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Mengimpor...';
        
        statusDiv!.className = 'mt-3 p-3 bg-blue-50 border border-blue-200 rounded text-blue-700';
        statusDiv!.textContent = 'Mengimpor soal essay...';
        statusDiv!.classList.remove('hidden');
        
        const formData = new FormData(form);
        
        try {
          const response = await fetch('/api/admin/essay/import-standalone', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (response.ok) {
            statusDiv!.className = 'mt-3 p-3 bg-green-50 border border-green-200 rounded text-green-700';
            const count = result.problemCount || 0;
            statusDiv!.textContent = `‚úÖ Berhasil mengimpor ${count} soal essay!`;
            form.reset();
            setTimeout(() => {
              window.location.href = '/admin/quizzes';
            }, 1500);
          } else {
            statusDiv!.className = 'mt-3 p-3 bg-red-50 border border-red-200 rounded text-red-700';
            statusDiv!.textContent = `‚ùå ${result.error || 'Gagal mengimpor soal essay'}`;
          }
        } catch (error) {
          statusDiv!.className = 'mt-3 p-3 bg-red-50 border border-red-200 rounded text-red-700';
          statusDiv!.textContent = `‚ùå Kesalahan: ${error instanceof Error ? error.message : 'Unknown'}`;
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Impor Soal Essay';
        }
      });
    </script>
  </div>
</Layout>

