---
import Layout from '../../components/Layout.astro';
import { renderMarkdown } from '../../lib/latex';

export const prerender = false;

const { id } = Astro.params;

// Fetch quiz details directly from database
let quiz: any = null;
let error = '';

try {
  const quizId = parseInt(id || '0');
  
  // Use server-side import to get the quiz
  const { getQuiz } = await import('../../lib/quizzes');
  const rawQuiz = await getQuiz(quizId);
  
  // Check if quiz exists (can be standalone or course quiz)
  if (!rawQuiz) {
    error = 'Quiz not found';
  } else {
    // Parse questions if it's a string
    quiz = {
      ...rawQuiz,
      questions: typeof rawQuiz.questions === 'string' 
        ? JSON.parse(rawQuiz.questions) 
        : rawQuiz.questions,
      settings: typeof rawQuiz.settings === 'string'
        ? JSON.parse(rawQuiz.settings)
        : rawQuiz.settings
    };
    
    // Handle essay problem format
    if (quiz.settings?.type === 'essay' && quiz.questions?.type === 'essay-problem-set') {
      // Essay problems have a different structure
      quiz.isEssay = true;
      quiz.problems = quiz.questions.problems || [];
    } else if (Array.isArray(quiz.questions)) {
      quiz.isEssay = false;
    } else {
      // Unknown format
      error = 'Invalid quiz format';
    }
  }
} catch (err) {
  error = 'Error loading quiz';
  console.error(err);
}
---

<Layout title={quiz?.title || 'Quiz Not Found'}>
  <div class="min-h-screen bg-gray-50">
    {error ? (
      <div class="max-w-2xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow p-8 text-center">
          <div class="text-red-500 text-6xl mb-4">‚ùå</div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">{error}</h2>
          <p class="text-gray-600 mb-4">The quiz you're looking for doesn't exist.</p>
          <a href="/quizzes" class="text-blue-600 hover:text-blue-700">
            ‚Üê Back to Practice Quizzes
          </a>
        </div>
      </div>
    ) : quiz?.isEssay ? (
      <!-- Essay Problems Display (keep existing) -->
      <div id="quiz-container" class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow p-8">
          <div class="mb-6 pb-4 border-b">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">{quiz.title}</h1>
            {quiz.settings?.description && (
              <p class="text-gray-600 mb-4">{quiz.settings.description}</p>
            )}
            <div class="flex items-center space-x-6 text-sm text-gray-600">
              <span>{quiz.problems?.length || 0} essay problems</span>
            </div>
          </div>

          <div class="space-y-8">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
              <p class="text-blue-800 text-sm">
                üìù <strong>Soal Essay:</strong> Ini adalah soal essay untuk latihan. Anda dapat membaca dan mengerjakan soal-soal berikut.
              </p>
            </div>
            
            {quiz.problems.map((problem: any, pIndex: number) => (
              <div class="border rounded-lg p-6 bg-gray-50">
                <h3 class="text-xl font-bold text-gray-900 mb-4">
                  Soal {pIndex + 1}: {problem.title}
                </h3>
                
                <div class="prose max-w-none mb-6">
                  <div set:html={problem.problemStatement} class="text-gray-700"></div>
                </div>
                
                {problem.subproblems && problem.subproblems.length > 0 && (
                  <div class="space-y-4 ml-4">
                    {problem.subproblems.map((sub: any, sIndex: number) => (
                      <div class="border-l-4 border-purple-500 pl-4">
                        <h4 class="font-semibold text-gray-900 mb-2">
                          {String.fromCharCode(97 + sIndex)}. {sub.title}
                        </h4>
                        <div class="prose max-w-none">
                          <div set:html={sub.content} class="text-gray-700"></div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
            
            <div class="mt-8 pt-6 border-t flex justify-between">
              <a
                href="/quizzes"
                class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700"
              >
                ‚Üê Kembali ke Daftar Kuis
              </a>
            </div>
          </div>
        </div>
      </div>
    ) : (
      <!-- Multiple Choice Quiz with Pagination -->
      <div class="flex flex-col h-screen bg-gray-100">
        <!-- Quiz Title Header - Spans entire width -->
        <div class="bg-white shadow-sm px-6 py-4 border-b">
          <h1 class="text-xl font-bold text-gray-900">{quiz.title}</h1>
        </div>

        <!-- Navigation Row - Nav and Timer aligned -->
        <div class="flex border-b bg-white">
          <!-- Navigation Bar Column -->
          <div id="nav-container" class="flex-1 px-6 py-4 flex items-center justify-between">
            <!-- Navigation bar will be rendered here by JavaScript -->
          </div>
          
          <!-- Timer Column -->
          <div class="w-80 border-l px-4 py-4">
            <div id="timer" class="flex items-center justify-center space-x-2 bg-blue-100 px-4 py-3 rounded-lg">
              <span class="text-sm font-medium text-blue-900">SISA WAKTU</span>
              <span id="timer-display" class="text-lg font-mono font-bold text-blue-900">--:--:--</span>
            </div>
          </div>
        </div>

        <!-- Main Content Area with Sidebar -->
        <div class="flex flex-1 overflow-hidden">
          <!-- Main Quiz Area -->
          <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Question Display Area - Scroll only at this level, not inside container -->
            <div class="flex-1 overflow-y-auto px-6 py-6">
              <div id="question-container" class="max-w-4xl mx-auto overflow-visible">
                <!-- Questions will be rendered here by JavaScript -->
              </div>
            </div>
          </div>

          <!-- Sidebar - Question Navigator -->
          <div class="w-80 bg-white border-l flex flex-col overflow-y-auto">

            <!-- Question Grid -->
            <div class="p-4 border-b">
              <h3 class="font-semibold text-gray-700 text-sm mb-3 tracking-wide">NOMOR SOAL</h3>
              <div id="question-grid" class="grid grid-cols-5 gap-2 max-h-96 overflow-y-auto p-1">
                <!-- Question numbers will be rendered here -->
              </div>
            </div>

            <!-- Status Legend - Compact -->
            <div class="p-4 border-b">
              <div class="space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-green-100 border border-green-300 rounded"></div>
                    <span class="text-gray-700">Sudah dijawab</span>
                  </div>
                  <span id="answered-count" class="font-semibold text-gray-900 min-w-[2rem] text-right">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-orange-100 border border-orange-300 rounded"></div>
                    <span class="text-gray-700">Ragu-ragu</span>
                  </div>
                  <span id="flagged-count" class="font-semibold text-gray-900 min-w-[2rem] text-right">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-gray-50 border border-gray-300 rounded"></div>
                    <span class="text-gray-700">Belum dijawab</span>
                  </div>
                  <span id="unanswered-count" class="font-semibold text-gray-900 min-w-[2rem] text-right">0</span>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="p-4 space-y-3">
              <button
                id="flag-btn"
                class="w-full px-4 py-2 border-2 border-orange-500 text-orange-600 rounded-lg hover:bg-orange-50 text-sm font-medium"
              >
                <span id="flag-text">üö© Ragu-Ragu</span>
              </button>
              
              <button
                id="submit-quiz-btn"
                class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold"
              >
                Selesaikan Ujian
              </button>
            </div>
          </div>
        </div>
      </div>
    )}
  </div>

  <style is:global>
    .math-display {
      margin: 1.5rem 0;
      text-align: center;
    }

    .math-inline {
      display: inline-block;
      vertical-align: middle;
    }

    .latex-error {
      background-color: #fee;
      border: 1px solid #fcc;
      padding: 0.5rem;
      border-radius: 0.25rem;
      color: #c33;
    }

    .question-number {
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      font-size: 0.875rem;
      border: 2px solid transparent;
    }

    .question-number:hover {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    /* Answered - Light green with checkmark feel */
    .question-number.answered {
      background-color: #dcfce7;
      color: #166534;
      border-color: #86efac;
    }

    /* Flagged - Warm orange for attention */
    .question-number.flagged {
      background-color: #ffedd5;
      color: #9a3412;
      border-color: #fdba74;
    }

    /* Unanswered - Subtle gray */
    .question-number.unanswered {
      background-color: #f9fafb;
      color: #6b7280;
      border-color: #e5e7eb;
    }

    /* Current question - Bold blue, highly visible */
    .question-number.current {
      background-color: #2563eb !important;
      color: white !important;
      font-weight: 700 !important;
      border-color: #2563eb !important;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15) !important;
      transform: scale(1.15) !important;
    }

    .question-number.current:hover {
      transform: scale(1.15) !important;
    }

    .option-label {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 0.75rem;
    }

    .option-label:hover {
      background-color: #f9fafb;
      border-color: #93c5fd;
    }

    .option-label.selected {
      background-color: #eff6ff;
      border-color: #3b82f6;
    }

    .option-label input[type="radio"],
    .option-label input[type="checkbox"] {
      flex-shrink: 0;
      width: 1.25rem;
      height: 1.25rem;
      margin-right: 1rem;
      margin-top: 0.125rem;
      cursor: pointer;
    }

    .option-content {
      flex: 1;
      text-align: left;
      line-height: 1.6;
    }

    .option-content p {
      margin: 0;
    }
  </style>

  <script define:vars={{ quiz, id }}>
    // Client-side markdown renderer for LaTeX
    function processLatex(text) {
      if (!text) return '';
      
      // Convert display math blocks ($$ ... $$) to placeholders
      let processed = text.replace(/\$\$([\s\S]*?)\$\$/g, (match, latex) => {
        const cleanLatex = (latex || '').trim();
        return `<div class="math-display" data-latex="${cleanLatex}"></div>`;
      });

      // Convert inline math $...$ to placeholders
      processed = processed.replace(/(?<!\$)\$([^$\n]+?)\$(?!\$)/g, (match, latex) => {
        const cleanLatex = (latex || '').trim();
        return `<span class="math-inline" data-latex="${cleanLatex}"></span>`;
      });

      return processed;
    }

    // Quiz state
    let currentQuestionIndex = 0;
    let answers = new Array(quiz.questions.length).fill(null);
    let flaggedQuestions = new Set();
    let startTime = Date.now();
    let timerInterval = null;

    // Initialize timer if time limit exists
    if (quiz.settings?.timeLimit) {
      const timeLimit = quiz.settings.timeLimit;
      let remainingTime = timeLimit;

      timerInterval = setInterval(() => {
        remainingTime--;
        
        if (remainingTime <= 0) {
          clearInterval(timerInterval);
          submitQuiz();
          return;
        }

        const hours = Math.floor(remainingTime / 3600);
        const minutes = Math.floor((remainingTime % 3600) / 60);
        const seconds = remainingTime % 60;
        
        document.getElementById('timer-display').textContent = 
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    } else {
      document.getElementById('timer').style.display = 'none';
    }

    // Render question grid
    function renderQuestionGrid() {
      const grid = document.getElementById('question-grid');
      grid.innerHTML = '';
      
      quiz.questions.forEach((_, index) => {
        const btn = document.createElement('button');
        btn.textContent = index + 1;
        
        // Build class list
        const classes = ['question-number'];
        
        // Add status class (current takes precedence)
        if (index === currentQuestionIndex) {
          classes.push('current');
        } else if (flaggedQuestions.has(index)) {
          classes.push('flagged');
        } else if (answers[index] !== null) {
          classes.push('answered');
        } else {
          classes.push('unanswered');
        }
        
        btn.className = classes.join(' ');
        btn.onclick = () => goToQuestion(index);
        grid.appendChild(btn);
      });

      updateCounts();
    }

    // Update status counts
    function updateCounts() {
      const answered = answers.filter(a => a !== null && !flaggedQuestions.has(answers.indexOf(a))).length;
      const flagged = flaggedQuestions.size;
      const unanswered = quiz.questions.length - answered - flagged;

      document.getElementById('answered-count').textContent = answered;
      document.getElementById('flagged-count').textContent = flagged;
      document.getElementById('unanswered-count').textContent = unanswered;
    }

    // Render current question
    function renderQuestion() {
      const question = quiz.questions[currentQuestionIndex];
      const container = document.getElementById('question-container');
      
      const isComplex = question.type === 'complex-multiple-choice' || question.type === 'complex';
      const inputType = isComplex ? 'checkbox' : 'radio';
      
      // Process question text with LaTeX
      const questionHtml = processLatex(question.question || '');
      
      // Process options with LaTeX
      const optionsHtml = question.options.map((option, optIndex) => {
        const optionHtml = processLatex(option || '');
        const isSelected = isAnswerSelected(currentQuestionIndex, optIndex + 1);
        
        return `
          <label class="option-label ${isSelected ? 'selected' : ''}" data-option="${optIndex + 1}">
            <input
              type="${inputType}"
              name="question-${currentQuestionIndex}"
              value="${optIndex + 1}"
              ${isSelected ? 'checked' : ''}
              onchange="handleAnswerChange(${currentQuestionIndex}, ${optIndex + 1}, this.type)"
            />
            <div class="option-content">${optionHtml}</div>
          </label>
        `;
      }).join('');
      
      // Process solution with LaTeX
      const solutionHtml = question.metadata?.solution ? processLatex(question.metadata.solution) : '';
      
      // Render navigation bar directly into nav-container
      const navContainer = document.getElementById('nav-container');
      navContainer.innerHTML = `
        <button
          id="prev-btn-main"
          class="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm font-medium"
          ${currentQuestionIndex === 0 ? 'disabled' : ''}
        >
          <span>‚Üê Soal Sebelumnya</span>
        </button>
        
        <div class="inline-block bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">
          SOAL NO. ${currentQuestionIndex + 1}
        </div>
        
        <button
          id="next-btn-main"
          class="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium"
        >
          <span>${currentQuestionIndex === quiz.questions.length - 1 ? 'Selesai' : 'Soal Selanjutnya ‚Üí'}</span>
        </button>
      `;

      // Render question content (no navigation bar inside)
      container.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg p-8">

          <div class="prose max-w-none mb-8">
            <div class="text-lg text-gray-800">${questionHtml}</div>
          </div>

          ${question.images && question.images.length > 0 ? `
            <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
              ${question.images.map(img => `
                <img src="${img}" alt="Question illustration" class="rounded-lg border shadow-sm" />
              `).join('')}
            </div>
          ` : ''}

          <div class="space-y-3">
            ${optionsHtml}
          </div>

          ${isComplex ? `
            <p class="mt-4 text-sm text-purple-600 font-medium">
              üî£ Pilihan ganda kompleks - Beberapa jawaban mungkin benar
            </p>
          ` : ''}

          ${question.metadata?.solution ? `
            <details class="mt-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
              <summary class="font-semibold text-gray-800 cursor-pointer hover:text-blue-600">
                üí° Lihat Pembahasan
              </summary>
              <div class="prose max-w-none text-gray-700 mt-4">
                ${solutionHtml}
              </div>
              ${question.metadata.solutionImages && question.metadata.solutionImages.length > 0 ? `
                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                  ${question.metadata.solutionImages.map(img => `
                    <img src="${img}" alt="Solution" class="rounded-lg border" />
                  `).join('')}
                </div>
              ` : ''}
            </details>
          ` : ''}
        </div>
      `;

      // Add event handlers for navigation buttons
      document.getElementById('prev-btn-main').onclick = () => {
        if (currentQuestionIndex > 0) {
          goToQuestion(currentQuestionIndex - 1);
        }
      };

      document.getElementById('next-btn-main').onclick = () => {
        if (currentQuestionIndex < quiz.questions.length - 1) {
          goToQuestion(currentQuestionIndex + 1);
        } else {
          // On last question, "Selesai" button goes to next or shows completion
          goToQuestion(currentQuestionIndex + 1);
        }
      };

      // Update flag button
      const flagBtn = document.getElementById('flag-btn');
      if (flaggedQuestions.has(currentQuestionIndex)) {
        flagBtn.classList.add('bg-orange-100');
        document.getElementById('flag-text').textContent = '‚úì Ragu-Ragu';
      } else {
        flagBtn.classList.remove('bg-orange-100');
        document.getElementById('flag-text').textContent = 'üö© Ragu-Ragu';
      }

      // Render LaTeX after DOM is ready
      setTimeout(() => renderLatex(), 50);
    }

    // Check if answer is selected
    function isAnswerSelected(questionIndex, optionValue) {
      const answer = answers[questionIndex];
      if (answer === null) return false;
      if (Array.isArray(answer)) {
        return answer.includes(optionValue);
      }
      return answer === optionValue;
    }

    // Handle answer change
    window.handleAnswerChange = function(questionIndex, optionValue, inputType) {
      if (inputType === 'checkbox') {
        // Complex multiple choice
        if (!Array.isArray(answers[questionIndex])) {
          answers[questionIndex] = [];
        }
        const index = answers[questionIndex].indexOf(optionValue);
        if (index > -1) {
          answers[questionIndex].splice(index, 1);
        } else {
          answers[questionIndex].push(optionValue);
        }
        if (answers[questionIndex].length === 0) {
          answers[questionIndex] = null;
        }
      } else {
        // Simple multiple choice
        answers[questionIndex] = optionValue;
      }

      // Update UI
      renderQuestionGrid();
      
      // Update option styling
      document.querySelectorAll('.option-label').forEach(label => {
        const option = parseInt(label.dataset.option);
        if (isAnswerSelected(questionIndex, option)) {
          label.classList.add('selected');
        } else {
          label.classList.remove('selected');
        }
      });
    };

    // Navigation functions
    function goToQuestion(index) {
      currentQuestionIndex = index;
      renderQuestion();
      renderQuestionGrid();
      // Scroll main area to top
      const mainArea = document.querySelector('.flex-1.overflow-y-auto');
      if (mainArea) {
        mainArea.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    // Flag button handler
    document.getElementById('flag-btn').onclick = () => {
      if (flaggedQuestions.has(currentQuestionIndex)) {
        flaggedQuestions.delete(currentQuestionIndex);
      } else {
        flaggedQuestions.add(currentQuestionIndex);
      }
      renderQuestion();
      renderQuestionGrid();
    };

    // Submit quiz
    document.getElementById('submit-quiz-btn').onclick = () => {
      const unanswered = answers.filter(a => a === null).length;
      if (unanswered > 0) {
        if (!confirm(`Anda memiliki ${unanswered} soal yang belum dijawab. Yakin ingin menyelesaikan ujian?`)) {
          return;
        }
      }
      submitQuiz();
    };

    async function submitQuiz() {
      if (timerInterval) clearInterval(timerInterval);
      
      const timeSpent = Math.floor((Date.now() - startTime) / 1000);
      
      try {
        const response = await fetch('/api/quiz/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            quizId: parseInt(id),
            answers: answers.map((answer, index) => ({
              questionId: index,
              answer: answer === null ? [] : (Array.isArray(answer) ? answer : [answer])
            })),
            timeSpent
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          window.location.href = `/quizzes/${id}/results?score=${result.percentage || 0}`;
        } else {
          alert('Error submitting quiz: ' + result.error);
        }
      } catch (error) {
        alert('Error submitting quiz. Please try again.');
        console.error(error);
      }
    }

    // Initialize
    renderQuestionGrid();
    renderQuestion();
  </script>

  <script>
    // LaTeX rendering (same as before)
    (function() {
      if (typeof window !== 'undefined' && !document.querySelector('link[href*="katex"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css';
        document.head.appendChild(link);
      }

      function loadKaTeX() {
        return new Promise((resolve, reject) => {
          if (window.katex) {
            resolve(window.katex);
            return;
          }
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js';
          script.onload = () => resolve(window.katex);
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      window.renderLatex = async function() {
        try {
          await loadKaTeX();
          const mathElements = document.querySelectorAll('.math-display, .math-inline');
          mathElements.forEach((element) => {
            const latex = element.getAttribute('data-latex') || '';
            const displayMode = element.classList.contains('math-display');
            
            try {
              window.katex.render(latex, element, {
                displayMode,
                throwOnError: false,
                trust: true,
                macros: {
                  '\\degree': '^{\\circ}'
                }
              });
            } catch (err) {
              console.warn('KaTeX render error:', err);
              element.innerHTML = `<span class="latex-error">LaTeX Error</span>`;
            }
          });
        } catch (err) {
          console.error('Failed to load KaTeX:', err);
        }
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', window.renderLatex);
      } else {
        window.renderLatex();
      }
    })();
  </script>
</Layout>
