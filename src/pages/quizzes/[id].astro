---
import Layout from '../../components/Layout.astro';
import { renderMarkdown } from '../../lib/latex';

export const prerender = false;

const { id } = Astro.params;

// Fetch quiz details directly from database
let quiz: any = null;
let clientQuiz: any = null; // Sanitized version for client (no solutions/answers)
let error = '';

try {
  const quizId = parseInt(id || '0');
  
  // Use server-side import to get the quiz
  const { getQuiz } = await import('../../lib/quizzes');
  const rawQuiz = await getQuiz(quizId);
  
  // Check if quiz exists (can be standalone or course quiz)
  if (!rawQuiz) {
    error = 'Quiz not found';
  } else {
    // Parse questions if it's a string
    quiz = {
      ...rawQuiz,
      questions: typeof rawQuiz.questions === 'string' 
        ? JSON.parse(rawQuiz.questions) 
        : rawQuiz.questions,
      settings: typeof rawQuiz.settings === 'string'
        ? JSON.parse(rawQuiz.settings)
        : rawQuiz.settings
    };
    
    // Handle essay problem format
    if (quiz.settings?.type === 'essay' && quiz.questions?.type === 'essay-problem-set') {
      // Essay problems have a different structure
      quiz.isEssay = true;
      quiz.problems = quiz.questions.problems || [];
    } else if (Array.isArray(quiz.questions)) {
      quiz.isEssay = false;
    } else {
      // Unknown format
      error = 'Invalid quiz format';
    }

    // Create sanitized version for client - REMOVE solutions and correct answers
    if (quiz && !quiz.isEssay && Array.isArray(quiz.questions)) {
      clientQuiz = {
        id: quiz.id,
        title: quiz.title,
        courseId: quiz.courseId,
        chapterId: quiz.chapterId,
        settings: quiz.settings,
        isEssay: quiz.isEssay,
        questions: quiz.questions.map((q: any, idx: number) => ({
          id: q.id || idx + 1,
          type: q.type,
          question: q.question,
          options: q.options,
          images: q.images,
          // SECURITY: Do NOT include correctAnswer or metadata.solution
        }))
      };
    } else {
      clientQuiz = quiz;
    }
  }
} catch (err) {
  error = 'Error loading quiz';
  console.error(err);
}
---

<Layout title={quiz?.title || 'Quiz Not Found'}>
  <link rel="stylesheet" href="/src/styles/quiz-shared.css">
  <div class="min-h-screen bg-gray-50">
    {error ? (
      <div class="max-w-2xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow p-8 text-center">
          <div class="text-red-500 text-6xl mb-4">‚ùå</div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">{error}</h2>
          <p class="text-gray-600 mb-4">The quiz you're looking for doesn't exist.</p>
          <a href="/quizzes" class="text-blue-600 hover:text-blue-700">
            ‚Üê Back to Practice Quizzes
          </a>
        </div>
      </div>
    ) : quiz?.isEssay ? (
      <!-- Essay Problems Display (keep existing) -->
      <div id="quiz-container" class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow p-8">
          <div class="mb-6 pb-4 border-b">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">{quiz.title}</h1>
            {quiz.settings?.description && (
              <p class="text-gray-600 mb-4">{quiz.settings.description}</p>
            )}
            <div class="flex items-center space-x-6 text-sm text-gray-600">
              <span>{quiz.problems?.length || 0} essay problems</span>
            </div>
          </div>

          <div class="space-y-8">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
              <p class="text-blue-800 text-sm">
                üìù <strong>Soal Essay:</strong> Ini adalah soal essay untuk latihan. Anda dapat membaca dan mengerjakan soal-soal berikut.
              </p>
            </div>
            
            {quiz.problems.map((problem: any, pIndex: number) => (
              <div class="border rounded-lg p-6 bg-gray-50">
                <h3 class="text-xl font-bold text-gray-900 mb-4">
                  Soal {pIndex + 1}: {problem.title}
                </h3>
                
                <div class="prose max-w-none mb-6">
                  <div set:html={problem.problemStatement} class="text-gray-700"></div>
                </div>
                
                {problem.subproblems && problem.subproblems.length > 0 && (
                  <div class="space-y-4 ml-4">
                    {problem.subproblems.map((sub: any, sIndex: number) => (
                      <div class="border-l-4 border-purple-500 pl-4">
                        <h4 class="font-semibold text-gray-900 mb-2">
                          {String.fromCharCode(97 + sIndex)}. {sub.title}
                        </h4>
                        <div class="prose max-w-none">
                          <div set:html={sub.content} class="text-gray-700"></div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
            
            <div class="mt-8 pt-6 border-t flex justify-between">
              <a
                href="/quizzes"
                class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700"
              >
                ‚Üê Kembali ke Daftar Kuis
              </a>
            </div>
          </div>
        </div>
      </div>
    ) : (
      <!-- Multiple Choice Quiz with Pagination - Mobile Friendly -->
      <div class="flex flex-col min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
        <!-- Quiz Title Header - Clean and elegant -->
        <div class="bg-white shadow-sm px-4 sm:px-6 py-3 sm:py-4 border-b border-slate-200">
          <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center space-x-2 sm:space-x-3 min-w-0">
              <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-blue-100 flex items-center justify-center flex-shrink-0">
                <span class="text-blue-600 text-lg sm:text-xl">üìù</span>
              </div>
              <div class="min-w-0">
                <h1 class="text-base sm:text-xl font-bold text-slate-900 truncate">{quiz.title}</h1>
                <p class="text-xs sm:text-sm text-slate-500">{quiz.questions?.length || 0} soal</p>
              </div>
            </div>
            <!-- Mobile sidebar toggle -->
            <button id="mobile-sidebar-toggle" class="lg:hidden p-2 rounded-lg hover:bg-slate-100 transition-colors">
              <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Navigation Row - Responsive -->
        <div class="flex flex-col lg:flex-row border-b border-slate-200 bg-white">
          <!-- Navigation Bar Column -->
          <div id="nav-container" class="flex-1 px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between order-last lg:order-first">
            <!-- Navigation bar will be rendered here by JavaScript -->
          </div>
          
          <!-- Timer - Fixed width to match sidebar -->
          <div class="lg:w-80 lg:border-l border-b lg:border-b-0 border-slate-200 px-4 py-2 sm:py-3 flex items-center justify-center">
            <div id="timer" class="flex items-center space-x-2 sm:space-x-3 bg-slate-50 border border-slate-200 px-3 sm:px-5 py-2 sm:py-2.5 rounded-lg sm:rounded-xl">
              <span class="text-slate-400 text-sm sm:text-base">‚è±Ô∏è</span>
              <span class="hidden sm:inline text-xs font-semibold text-slate-500 uppercase tracking-wider">Sisa Waktu</span>
              <span id="timer-display" class="text-lg sm:text-xl font-mono font-bold text-slate-800 tabular-nums">--:--:--</span>
            </div>
          </div>
        </div>

        <!-- Main Content Area with Sidebar -->
        <div class="flex flex-1 overflow-hidden relative">
          <!-- Main Quiz Area -->
          <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Question Display Area -->
            <div class="flex-1 overflow-y-auto px-4 sm:px-6 py-4 sm:py-6 scroll-smooth">
              <div id="question-container" class="max-w-4xl mx-auto overflow-visible quiz-content">
                <!-- Questions will be rendered here by JavaScript -->
              </div>
              
              <!-- Mobile bottom padding for fixed footer -->
              <div class="h-24 lg:hidden"></div>
            </div>
          </div>

          <!-- Sidebar - Question Navigator (Desktop) / Slide-over (Mobile) -->
          <div id="sidebar" class="fixed lg:relative inset-y-0 right-0 w-80 bg-white border-l border-slate-200 flex flex-col transform translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-40 overflow-y-auto">
            
            <!-- Mobile sidebar close button -->
            <div class="lg:hidden flex items-center justify-between p-4 border-b border-slate-200">
              <span class="font-bold text-slate-700">Menu Quiz</span>
              <button id="close-sidebar" class="p-2 rounded-lg hover:bg-slate-100 transition-colors">
                <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <!-- Question Grid & Legend Container -->
            <div class="p-4 sm:p-5">
              <h3 class="font-bold text-slate-700 text-xs mb-4 uppercase tracking-wider flex items-center gap-2">
                <span>üìã</span>
                <span>Nomor Soal</span>
              </h3>
              <div id="question-grid" class="grid grid-cols-5 gap-2 sm:gap-2.5 overflow-y-auto overflow-x-visible p-1 mb-4 max-h-[360px]">
                <!-- Question numbers will be rendered here - max 50 visible (10 rows), rest scrollable -->
              </div>
              
              <!-- Status Legend - Inline below grid -->
              <div class="bg-slate-50 rounded-lg p-3 sm:p-4 space-y-2">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-emerald-100 border-2 border-emerald-400 flex items-center justify-center">
                      <span class="text-emerald-600 text-[8px]">‚úì</span>
                    </div>
                    <span class="text-slate-600 text-xs font-medium">Sudah dijawab</span>
                  </div>
                  <span id="answered-count" class="font-bold text-emerald-600 text-xs">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-amber-100 border-2 border-amber-400 flex items-center justify-center">
                      <span class="text-amber-600 text-[8px]">?</span>
                    </div>
                    <span class="text-slate-600 text-xs font-medium">Ragu-ragu</span>
                  </div>
                  <span id="flagged-count" class="font-bold text-amber-600 text-xs">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-slate-100 border-2 border-slate-300"></div>
                    <span class="text-slate-600 text-xs font-medium">Belum dijawab</span>
                  </div>
                  <span id="unanswered-count" class="font-bold text-slate-500 text-xs">0</span>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="p-4 sm:p-5 border-t border-slate-100 space-y-3">
              <button
                id="flag-btn"
                class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-white border-2 border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50 hover:border-amber-400 text-sm font-medium transition-all"
              >
                <span>üö©</span>
                <span id="flag-text">Ragu-Ragu</span>
              </button>
              
              <button
                id="submit-quiz-btn"
                class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold text-sm transition-all"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Selesaikan Ujian
              </button>
            </div>
          </div>
          
          <!-- Mobile sidebar overlay -->
          <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden"></div>
        </div>
        
        <!-- Mobile Bottom Navigation -->
        <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-4 py-3 flex items-center justify-between gap-2 z-20">
          <button id="mobile-prev-btn" class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
            ‚Üê Sebelumnya
          </button>
          <button id="mobile-flag-btn" class="px-4 py-2 bg-white border border-amber-300 rounded-md text-amber-700 hover:bg-amber-50">
            üö©
          </button>
          <button id="mobile-next-btn" class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50">
            Selanjutnya ‚Üí
          </button>
        </div>
      </div>
    )}
  </div>

  <style is:global>
    /* Custom Scrollbar Styling */
    .scroll-smooth::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .scroll-smooth::-webkit-scrollbar-track {
      background: transparent;
    }

    .scroll-smooth::-webkit-scrollbar-thumb {
      background: #e2e8f0;
      border-radius: 3px;
      transition: background 0.2s;
    }

    .scroll-smooth::-webkit-scrollbar-thumb:hover {
      background: #cbd5e1;
    }

    /* For Firefox */
    .scroll-smooth {
      scrollbar-width: thin;
      scrollbar-color: #e2e8f0 transparent;
    }
    
    /* Hide scrollbar until hover */
    .scroll-smooth::-webkit-scrollbar-thumb {
      background: transparent;
    }
    
    .scroll-smooth:hover::-webkit-scrollbar-thumb {
      background: #e2e8f0;
    }

    /* Anti-cheating: Disable text selection on quiz content */
    .quiz-content {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    /* Allow selection on input fields */
    .quiz-content input,
    .quiz-content textarea {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    .math-display {
      margin: 0.75rem 0;
      text-align: center;
      overflow-x: auto;
    }

    .math-inline {
      display: inline;
      vertical-align: baseline;
    }

    .math-inline .katex {
      display: inline;
      vertical-align: baseline;
      font-size: 1em;
    }

    .math-inline .katex-html {
      display: inline;
    }

    /* Ensure KaTeX elements align properly with text */
    .prose .math-inline,
    .prose p .math-inline,
    .option-text .math-inline,
    .option-content .math-inline {
      vertical-align: baseline;
    }

    .math-inline .katex-display {
      margin: 0;
      display: inline;
    }

    .latex-error {
      background-color: #fee;
      border: 1px solid #fcc;
      padding: 0.5rem;
      border-radius: 0.25rem;
      color: #c33;
    }

    .question-number {
      width: 2.25rem;
      height: 2.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.15s ease-in-out;
      font-size: 0.8125rem;
      border: 2px solid transparent;
      position: relative;
      flex-shrink: 0;
    }
    
    @media (min-width: 640px) {
      .question-number {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 0.625rem;
        font-size: 0.875rem;
      }
    }

    .question-number:hover {
      transform: scale(1.08);
      z-index: 10;
    }
    
    .question-number:active {
      transform: translateY(-1px) scale(1.02);
    }

    /* Answered - Emerald green */
    .question-number.answered {
      background-color: #ecfdf5;
      color: #059669;
      border-color: #6ee7b7;
    }

    /* Flagged (unanswered) - Amber */
    .question-number.flagged {
      background-color: #fffbeb;
      color: #d97706;
      border-color: #fcd34d;
    }

    /* Flagged + Answered - Orange */
    .question-number.flagged-answered {
      background-color: #fff7ed;
      color: #ea580c;
      border-color: #fb923c;
    }

    /* Unanswered - Subtle slate */
    .question-number.unanswered {
      background-color: #f8fafc;
      color: #64748b;
      border-color: #e2e8f0;
    }

    /* Current question - Bold blue */
    .question-number.current {
      background-color: #3b82f6 !important;
      color: white !important;
      font-weight: 700 !important;
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2), 0 4px 6px -1px rgba(59, 130, 246, 0.3) !important;
      transform: scale(1.1) !important;
    }

    .question-number.current:hover {
      transform: scale(1.1) !important;
    }

    .option-label {
      display: flex;
      flex-direction: row;
      align-items: center;
      padding: 0.875rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      margin-bottom: 0.625rem;
      background-color: #ffffff;
      position: relative;
      overflow: hidden;
      min-height: 3rem;
    }
    
    @media (min-width: 640px) {
      .option-label {
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
      }
    }
    
    .option-label::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: transparent;
      transition: all 0.2s ease;
    }

    .option-label:hover {
      background-color: #f8fafc;
      border-color: #94a3b8;
    }

    .option-label.selected {
      background: linear-gradient(to right, #eff6ff, #ffffff);
      border-color: #3b82f6;
    }
    
    .option-label.selected::before {
      background: linear-gradient(to bottom, #3b82f6, #2563eb);
    }

    /* Radio/Checkbox Input - Hidden, using option letters instead */
    .option-label input[type="radio"],
    .option-label input[type="checkbox"] {
      display: none;
    }

    /* Option Letter */
    .option-letter {
      flex-shrink: 0;
      width: 1.75rem;
      height: 1.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.375rem;
      background: #f1f5f9;
      color: #64748b;
      font-weight: 600;
      font-size: 0.8125rem;
      margin-right: 0.875rem;
      transition: all 0.2s ease;
    }

    @media (min-width: 640px) {
      .option-letter {
        width: 2rem;
        height: 2rem;
        margin-right: 1rem;
        font-size: 0.875rem;
      }
    }

    .option-label.selected .option-letter {
      background: #3b82f6;
      color: white;
    }

    .option-content {
      flex: 1;
      text-align: left;
      line-height: 1.5;
      color: #334155;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      min-height: 1.5rem;
    }

    .option-content p {
      margin: 0;
    }
    
    .option-content .math-display {
      margin: 0;
      width: 100%;
    }
    
    /* Markdown rendering styles */
    .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
      font-weight: 700;
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      color: #1e293b;
    }
    
    .prose h3 { font-size: 1.25rem; }
    .prose h4 { font-size: 1.125rem; }
    
    .prose ul, .prose ol {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }
    
    .prose ul { list-style-type: disc; }
    .prose ol { list-style-type: decimal; }
    
    .prose ul ul, .prose ol ol, .prose ul ol, .prose ol ul {
      margin: 0.5rem 0;
    }
    
    .prose ul ul { list-style-type: circle; }
    .prose ul ul ul { list-style-type: square; }
    
    .prose li {
      margin: 0.375rem 0;
      line-height: 1.6;
    }
    
    .prose strong { font-weight: 700; }
    .prose em { font-style: italic; }
    
    .prose code {
      background: #f1f5f9;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.875em;
      font-family: ui-monospace, monospace;
    }
    
    .prose pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      margin: 1rem 0;
    }
    
    .prose pre code {
      background: none;
      padding: 0;
      color: inherit;
    }
    
    .prose blockquote {
      border-left: 4px solid #3b82f6;
      padding-left: 1rem;
      margin: 1rem 0;
      color: #64748b;
      font-style: italic;
    }
    
    .prose hr {
      border: none;
      border-top: 2px solid #e2e8f0;
      margin: 1.5rem 0;
    }
    
    .prose table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    
    .prose th, .prose td {
      border: 1px solid #e2e8f0;
      padding: 0.5rem 0.75rem;
      text-align: left;
    }
    
    .prose th {
      background: #f8fafc;
      font-weight: 600;
    }
    
    /* Question card styling */
    .question-card {
      background: #ffffff;
      border-radius: 1.25rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      border: 1px solid #e2e8f0;
      overflow: hidden;
    }
    
    .question-header {
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 1.5rem;
    }
    
    .question-body {
      padding: 2rem;
    }
    
    .question-text {
      font-size: 1.125rem;
      line-height: 1.8;
      color: #1e293b;
    }
    
    /* Solution styling */
    .solution-panel {
      background: #f1f5f9;
      border: 2px solid #cbd5e1;
      border-radius: 1rem;
      margin-top: 1.5rem;
      overflow: hidden;
    }
    
    .solution-panel summary {
      padding: 1rem 1.5rem;
      font-weight: 600;
      color: #475569;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.2s;
    }
    
    .solution-panel summary:hover {
      background: rgba(203, 213, 225, 0.1);
    }
    
    .solution-panel[open] summary {
      border-bottom: 1px solid #cbd5e1;
    }
    
    .solution-content {
      padding: 1.5rem;
      color: #334155;
      line-height: 1.7;
    }
    
    /* Navigation buttons - Exact match with editor */
    .nav-btn {
      padding: 0.5rem 1rem;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      color: #374151;
      font-size: 0.875rem;
      transition: background-color 0.15s ease;
    }
    
    .nav-btn:hover:not(:disabled) {
      background: #f9fafb;
    }
    
    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .question-indicator {
      color: #374151;
      font-weight: 500;
      font-size: 0.875rem;
    }
  </style>

  <script>
    // Preload KaTeX CSS/JS immediately at page load (before quiz script)
    (function() {
      // Load KaTeX CSS once if not already loaded
      if (typeof window !== 'undefined' && !document.querySelector('link[href*="katex"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css';
        document.head.appendChild(link);
      }

      // Preload KaTeX JS immediately if not already loaded
      if (typeof window !== 'undefined' && !window.katex) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js';
        script.async = false; // Load synchronously for faster availability
        document.head.appendChild(script);
      }

      // Create renderLatex function that will be available when quiz script runs
      window.renderLatex = function() {
        if (!window.katex) {
          // KaTeX not loaded yet, wait a bit and try again
          setTimeout(() => {
            if (window.katex) {
              window.renderLatex();
            }
          }, 10);
          return;
        }

        const mathElements = document.querySelectorAll('.math-display, .math-inline');
        mathElements.forEach((element) => {
          // Skip if already rendered (has katex class)
          if (element.querySelector('.katex')) {
            return;
          }

          const latex = element.getAttribute('data-latex') || '';
          if (!latex) return;

          const displayMode = element.classList.contains('math-display');
          
          try {
            // Clear element first to ensure clean render
            element.innerHTML = '';
            window.katex.render(latex, element, {
              displayMode,
              throwOnError: false,
              trust: true,
              macros: {
                '\\degree': '^{\\circ}'
              }
            });
          } catch (err) {
            console.warn('KaTeX render error:', err);
            element.innerHTML = `<span class="latex-error">LaTeX Error</span>`;
          }
        });
      };
    })();
  </script>

  <!-- Load marked.js for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <script define:vars={{ quiz: clientQuiz, id }}>
    // Escape HTML for safe attribute embedding
    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // Full markdown renderer with LaTeX support
    function renderMarkdown(text) {
      if (!text) return '';
      
      // Normalize newlines
      let processed = text.replace(/\r\n?|\u2028|\u2029/g, '\n');
      
      // Convert display math blocks ($$ ... $$) to placeholders
      processed = processed.replace(/\$\$([\s\S]*?)\$\$/g, (match, latex) => {
        const cleanLatex = (latex || '').trim();
        return `\n<div class="math-display" data-latex="${escapeHtml(cleanLatex)}"></div>\n`;
      });

      // Convert inline math $...$ to placeholders
      processed = processed.replace(/(?<!\$)\$([^$\n]+?)\$(?!\$)/g, (match, latex) => {
        const cleanLatex = (latex || '').trim();
        return `<span class="math-inline" data-latex="${escapeHtml(cleanLatex)}"></span>`;
      });

      // Use marked for full markdown parsing
      if (window.marked) {
        try {
          return window.marked.parse(processed);
        } catch (e) {
          console.error('Markdown parsing error:', e);
          return processed;
        }
      }
      
      return processed;
    }
    
    // Simple LaTeX-only processor (legacy compatibility)
    function processLatex(text) {
      return renderMarkdown(text);
    }

    // Quiz state
    const PROGRESS_KEY = `quiz_progress_${id}`;
    let currentQuestionIndex = 0;
    let answers = new Array(quiz.questions.length).fill(null);
    let flaggedQuestions = new Set();
    let startTime = Date.now();
    let timerInterval = null;

    // Load saved progress
    function loadProgress() {
      try {
        const saved = localStorage.getItem(PROGRESS_KEY);
        if (saved) {
          const progress = JSON.parse(saved);
          answers = progress.answers || answers;
          flaggedQuestions = new Set(progress.flaggedQuestions || []);
          currentQuestionIndex = progress.currentQuestionIndex || 0;
          
          // Restore timer state
          if (quiz.settings?.timeLimit) {
            if (progress.remainingTime !== undefined) {
              // Use saved remaining time
              remainingTime = progress.remainingTime;
            } else if (progress.startTime) {
              // Calculate from start time (legacy support)
              const elapsed = Math.floor((Date.now() - progress.startTime) / 1000);
              remainingTime = Math.max(0, quiz.settings.timeLimit - elapsed);
            }
          }
          
          console.log('Progress loaded:', progress);
          return true;
        }
      } catch (error) {
        console.error('Error loading progress:', error);
      }
      return false;
    }

    // Save progress
    function saveProgress() {
      try {
        const progress = {
          answers,
          flaggedQuestions: Array.from(flaggedQuestions),
          currentQuestionIndex,
          remainingTime: quiz.settings?.timeLimit ? remainingTime : undefined,
          startTime: startTime,
          savedAt: Date.now()
        };
        localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
      } catch (error) {
        console.error('Error saving progress:', error);
      }
    }

    // Clear progress
    function clearProgress() {
      try {
        localStorage.removeItem(PROGRESS_KEY);
      } catch (error) {
        console.error('Error clearing progress:', error);
      }
    }

    // Initialize timer variables
    let remainingTime = quiz.settings?.timeLimit || 0;
    
    // Load progress first
    const hasProgress = loadProgress();

    // If no saved progress, use full time limit
    if (!hasProgress && quiz.settings?.timeLimit) {
      remainingTime = quiz.settings.timeLimit;
    }

    // Timer initialization function (to be called after DOM is ready)
    function initializeTimer() {
      // Initialize timer if time limit exists
      if (quiz.settings?.timeLimit) {
        // Update display immediately
        const updateTimerDisplay = () => {
          const hours = Math.floor(remainingTime / 3600);
          const minutes = Math.floor((remainingTime % 3600) / 60);
          const seconds = remainingTime % 60;
          const timerDisplay = document.getElementById('timer-display');
          if (timerDisplay) {
            timerDisplay.textContent = 
              `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          }
        };
        
        updateTimerDisplay();

        timerInterval = setInterval(() => {
          remainingTime--;
          
          if (remainingTime <= 0) {
            clearInterval(timerInterval);
            submitQuiz();
            return;
          }

          updateTimerDisplay();
          // Save progress periodically (every 10 seconds)
          if (remainingTime % 10 === 0) {
            saveProgress();
          }
        }, 1000);
      } else {
        const timerElement = document.getElementById('timer');
        if (timerElement) {
          timerElement.style.display = 'none';
        }
      }
    }

    // Render question grid
    function renderQuestionGrid() {
      console.log('renderQuestionGrid called');
      const grid = document.getElementById('question-grid');
      
      if (!grid) {
        console.error('question-grid element not found!');
        return;
      }
      
      grid.innerHTML = '';
      
      quiz.questions.forEach((_, index) => {
        const btn = document.createElement('button');
        btn.textContent = index + 1;
        
        // Build class list
        const classes = ['question-number'];
        
        const isFlagged = flaggedQuestions.has(index);
        const isAnswered = answers[index] !== null;
        
        // Add status class (current takes precedence)
        if (index === currentQuestionIndex) {
          classes.push('current');
        } else if (isFlagged && isAnswered) {
          // Flagged AND answered - darker orange
          classes.push('flagged-answered');
        } else if (isFlagged) {
          // Flagged but NOT answered - lighter orange/yellow
          classes.push('flagged');
        } else if (isAnswered) {
          // Answered only - green
          classes.push('answered');
        } else {
          // Not answered - gray
          classes.push('unanswered');
        }
        
        btn.className = classes.join(' ');
        btn.onclick = () => goToQuestion(index);
        grid.appendChild(btn);
      });

      updateCounts();
    }

    // Update status counts
    function updateCounts() {
      let answered = 0;
      let flaggedUnanswered = 0;
      let unanswered = 0;

      answers.forEach((answer, index) => {
        const isFlagged = flaggedQuestions.has(index);
        const isAnswered = answer !== null;

        if (isAnswered) {
          // If answered (regardless of flagged), count as answered
          answered++;
        } else if (isFlagged) {
          // Only count as ragu-ragu if NOT answered
          flaggedUnanswered++;
        } else {
          // Not answered and not flagged
          unanswered++;
        }
      });

      const answeredEl = document.getElementById('answered-count');
      const flaggedEl = document.getElementById('flagged-count');
      const unansweredEl = document.getElementById('unanswered-count');
      
      if (answeredEl) answeredEl.textContent = answered;
      if (flaggedEl) flaggedEl.textContent = flaggedUnanswered;
      if (unansweredEl) unansweredEl.textContent = unanswered;
    }
    
    // Alias for compatibility
    const updateStats = updateCounts;

    // Render current question
    function renderQuestion() {
      console.log('renderQuestion called, currentQuestionIndex:', currentQuestionIndex);
      
      const question = quiz.questions[currentQuestionIndex];
      const container = document.getElementById('question-container');
      const navContainer = document.getElementById('nav-container');
      
      if (!container) {
        console.error('question-container not found!');
        return;
      }
      
      if (!navContainer) {
        console.error('nav-container not found!');
        return;
      }
      
      console.log('Both containers found, rendering...');
      
      const isComplex = question.type === 'complex-multiple-choice' || question.type === 'complex';
      const inputType = isComplex ? 'checkbox' : 'radio';
      
      // Process question text with LaTeX
      const questionHtml = processLatex(question.question || '');
      
      // Process options with LaTeX
      const optionsHtml = question.options.map((option, optIndex) => {
        const optionHtml = processLatex(option || '');
        const isSelected = isAnswerSelected(currentQuestionIndex, optIndex + 1);
        const optionLetter = String.fromCharCode(65 + optIndex); // A, B, C, D...
        
        return `
          <label class="option-label ${isSelected ? 'selected' : ''}" data-option="${optIndex + 1}">
            <input
              type="${inputType}"
              name="question-${currentQuestionIndex}"
              value="${optIndex + 1}"
              ${isSelected ? 'checked' : ''}
              onchange="handleAnswerChange(${currentQuestionIndex}, ${optIndex + 1}, this.type)"
            />
            <span class="option-letter">${optionLetter}</span>
            <div class="option-content">${optionHtml}</div>
          </label>
        `;
      }).join('');
      
      // NOTE: Solutions are NOT sent to client for security
      // They are only shown on the results page after quiz submission
      
      // Render navigation bar directly into nav-container
      navContainer.innerHTML = `
        <button
          type="button"
          id="prev-btn-main"
          class="px-4 py-2 bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          ${currentQuestionIndex === 0 ? 'disabled' : ''}
        >
          ‚Üê Sebelumnya
        </button>
        
        <span class="text-gray-700 font-medium">
          Soal ${currentQuestionIndex + 1} dari ${quiz.questions.length}
        </span>
        
        <button
          type="button"
          id="next-btn-main"
          class="px-4 py-2 bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          ${currentQuestionIndex === quiz.questions.length - 1 ? 'Selesai ‚úì' : 'Selanjutnya ‚Üí'}
        </button>
      `;

      // Render question content (no navigation bar inside)
      container.innerHTML = `
        <div class="question-card">
          <div class="question-header">
            <div class="flex items-center justify-between">
              <span class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Pertanyaan</span>
              ${isComplex ? `
                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-purple-100 text-purple-700 border border-purple-200">
                  üî£ Pilihan Ganda Kompleks
                </span>
              ` : ''}
            </div>
          </div>
          
          <div class="question-body">
            <div class="question-text prose max-w-none mb-8">
              ${questionHtml}
            </div>

            ${question.images && question.images.length > 0 ? `
              <div class="mb-8 grid grid-cols-1 sm:grid-cols-2 gap-4">
                ${question.images.map(img => `
                  <img src="${img}" alt="Question illustration" class="rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow" />
                `).join('')}
              </div>
            ` : ''}

            <div class="space-y-1">
              ${optionsHtml}
            </div>

            <!-- Solution is hidden during quiz session, shown on results page -->
          </div>
        </div>
      `;

      // Add event handlers for navigation buttons
      document.getElementById('prev-btn-main').onclick = () => {
        if (currentQuestionIndex > 0) {
          goToQuestion(currentQuestionIndex - 1);
        }
      };

      document.getElementById('next-btn-main').onclick = () => {
        if (currentQuestionIndex < quiz.questions.length - 1) {
          goToQuestion(currentQuestionIndex + 1);
        } else {
          // On last question, "Selesai" button goes to next or shows completion
          goToQuestion(currentQuestionIndex + 1);
        }
      };

      // Update flag button
      const flagBtn = document.getElementById('flag-btn');
      const flagText = document.getElementById('flag-text');
      if (flaggedQuestions.has(currentQuestionIndex)) {
        flagBtn.classList.add('bg-amber-100', 'border-amber-400');
        flagBtn.classList.remove('bg-white');
        flagText.textContent = '‚úì Ditandai';
      } else {
        flagBtn.classList.remove('bg-amber-100', 'border-amber-400');
        flagBtn.classList.add('bg-white');
        flagText.textContent = 'Ragu-Ragu';
      }

      // Render LaTeX immediately after content is set
      // Use requestAnimationFrame to ensure DOM is ready
      requestAnimationFrame(() => {
        renderLatex();
      });
    }

    // Check if answer is selected
    function isAnswerSelected(questionIndex, optionValue) {
      const answer = answers[questionIndex];
      if (answer === null) return false;
      if (Array.isArray(answer)) {
        return answer.includes(optionValue);
      }
      return answer === optionValue;
    }

    // Handle answer change
    window.handleAnswerChange = function(questionIndex, optionValue, inputType) {
      if (inputType === 'checkbox') {
        // Complex multiple choice
        if (!Array.isArray(answers[questionIndex])) {
          answers[questionIndex] = [];
        }
        const index = answers[questionIndex].indexOf(optionValue);
        if (index > -1) {
          answers[questionIndex].splice(index, 1);
        } else {
          answers[questionIndex].push(optionValue);
        }
        if (answers[questionIndex].length === 0) {
          answers[questionIndex] = null;
        }
      } else {
        // Simple multiple choice
        answers[questionIndex] = optionValue;
      }

      // Update UI
      renderQuestionGrid();
      updateStats();
      
      // Update option styling
      document.querySelectorAll('.option-label').forEach(label => {
        const option = parseInt(label.dataset.option);
        if (isAnswerSelected(questionIndex, option)) {
          label.classList.add('selected');
        } else {
          label.classList.remove('selected');
        }
      });

      // Save progress
      saveProgress();
    };

    // Navigation functions
    function goToQuestion(index) {
      currentQuestionIndex = index;
      renderQuestion();
      renderQuestionGrid();
      // Scroll main area to top
      const mainArea = document.querySelector('.flex-1.overflow-y-auto');
      if (mainArea) {
        mainArea.scrollTo({ top: 0, behavior: 'smooth' });
      }
      // Save progress
      saveProgress();
    }

    // Flag button handler
    document.getElementById('flag-btn').onclick = () => {
      if (flaggedQuestions.has(currentQuestionIndex)) {
        flaggedQuestions.delete(currentQuestionIndex);
      } else {
        flaggedQuestions.add(currentQuestionIndex);
      }
      renderQuestion();
      renderQuestionGrid();
      updateStats();
      // Save progress
      saveProgress();
    };

    // Submit quiz
    document.getElementById('submit-quiz-btn').onclick = () => {
      const unanswered = answers.filter(a => a === null).length;
      if (unanswered > 0) {
        if (!confirm(`Anda memiliki ${unanswered} soal yang belum dijawab. Yakin ingin menyelesaikan ujian?`)) {
          return;
        }
      }
      submitQuiz();
    };

    async function submitQuiz() {
      if (timerInterval) clearInterval(timerInterval);
      
      const timeSpent = Math.floor((Date.now() - startTime) / 1000);
      
      try {
        const response = await fetch('/api/quiz/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            quizId: parseInt(id),
            answers: answers.map((answer, index) => ({
              questionId: index,
              answer: answer === null ? [] : (Array.isArray(answer) ? answer : [answer])
            })),
            timeSpent
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          // Clear saved progress
          clearProgress();
          window.location.href = `/quizzes/${id}/results?score=${result.percentage || 0}`;
        } else {
          alert('Error submitting quiz: ' + result.error);
        }
      } catch (error) {
        alert('Error submitting quiz. Please try again.');
        console.error(error);
      }
    }

    // Initialize quiz
    function initializeQuiz() {
      console.log('Initializing quiz... readyState:', document.readyState);
      
      // Double-check that all required elements exist
      const requiredElements = [
        'question-container',
        'nav-container',
        'question-grid',
        'answered-count',
        'flagged-count',
        'unanswered-count',
        'flag-btn',
        'submit-quiz-btn'
      ];
      
      const missingElements = requiredElements.filter(id => !document.getElementById(id));
      
      if (missingElements.length > 0) {
        console.error('Missing elements:', missingElements);
        console.log('Retrying in 50ms...');
        setTimeout(initializeQuiz, 50);
        return;
      }
      
      console.log('All elements found, initializing...');
      
      // Initialize timer first
      initializeTimer();
      
      // Render UI immediately (don't wait for KaTeX)
      console.log('Rendering question grid...');
      renderQuestionGrid();
      console.log('Updating stats...');
      updateStats();
      console.log('Rendering question...');
      renderQuestion();
      
      // LaTeX will be rendered by renderQuestion() via requestAnimationFrame
      console.log('Quiz initialized successfully');
    }

    // Wait for DOM to be fully ready
    function startInitialization() {
      console.log('startInitialization called, readyState:', document.readyState);
      
      if (document.readyState === 'loading') {
        console.log('Waiting for DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', () => {
          console.log('DOMContentLoaded fired');
          // Use a small delay to ensure all elements are painted
          setTimeout(initializeQuiz, 10);
        });
      } else {
        console.log('DOM already ready, initializing...');
        // Use a small delay to ensure all elements are painted
        setTimeout(initializeQuiz, 10);
      }
    }
    
    // Start initialization
    startInitialization();
    
    // Mobile sidebar toggle
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
    const closeSidebar = document.getElementById('close-sidebar');
    
    function openSidebar() {
      sidebar?.classList.remove('translate-x-full');
      sidebarOverlay?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function closeSidebarFn() {
      sidebar?.classList.add('translate-x-full');
      sidebarOverlay?.classList.add('hidden');
      document.body.style.overflow = '';
    }
    
    mobileSidebarToggle?.addEventListener('click', openSidebar);
    closeSidebar?.addEventListener('click', closeSidebarFn);
    sidebarOverlay?.addEventListener('click', closeSidebarFn);
    
    // Mobile bottom navigation
    const mobilePrevBtn = document.getElementById('mobile-prev-btn');
    const mobileNextBtn = document.getElementById('mobile-next-btn');
    const mobileFlagBtn = document.getElementById('mobile-flag-btn');
    
    mobilePrevBtn?.addEventListener('click', () => {
      if (currentQuestionIndex > 0) {
        goToQuestion(currentQuestionIndex - 1);
      }
    });
    
    mobileNextBtn?.addEventListener('click', () => {
      if (currentQuestionIndex < quiz.questions.length - 1) {
        goToQuestion(currentQuestionIndex + 1);
      }
    });
    
    mobileFlagBtn?.addEventListener('click', () => {
      if (flaggedQuestions.has(currentQuestionIndex)) {
        flaggedQuestions.delete(currentQuestionIndex);
      } else {
        flaggedQuestions.add(currentQuestionIndex);
      }
      renderQuestion();
      renderQuestionGrid();
      updateStats();
      saveProgress();
    });
    
    // Update mobile buttons state
    function updateMobileNav() {
      if (mobilePrevBtn) {
        mobilePrevBtn.disabled = currentQuestionIndex === 0;
      }
      if (mobileNextBtn) {
        mobileNextBtn.textContent = currentQuestionIndex === quiz.questions.length - 1 ? 'Selesai ‚úì' : 'Next ‚Üí';
      }
    }
    
    // Call updateMobileNav in goToQuestion
    const originalGoToQuestion = goToQuestion;
    goToQuestion = function(index) {
      originalGoToQuestion(index);
      updateMobileNav();
    };

    // ============================================
    // ANTI-CHEATING MEASURES
    // ============================================
    
    // Disable right-click on quiz content
    document.getElementById('question-container')?.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      return false;
    });

    // Disable common keyboard shortcuts for DevTools/View Source
    document.addEventListener('keydown', (e) => {
      // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
      if (
        e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j')) ||
        (e.ctrlKey && (e.key === 'U' || e.key === 'u'))
      ) {
        e.preventDefault();
        return false;
      }
    });

    // Detect if DevTools is open (basic detection)
    let devToolsWarningShown = false;
    const devToolsDetector = setInterval(() => {
      const widthThreshold = window.outerWidth - window.innerWidth > 160;
      const heightThreshold = window.outerHeight - window.innerHeight > 160;
      
      if ((widthThreshold || heightThreshold) && !devToolsWarningShown) {
        devToolsWarningShown = true;
        console.clear();
        console.log('%c‚ö†Ô∏è PERINGATAN!', 'color: red; font-size: 24px; font-weight: bold;');
        console.log('%cMembuka DevTools selama ujian dapat dianggap sebagai kecurangan dan akan dicatat.', 'color: red; font-size: 14px;');
        console.log('%cOpening DevTools during the exam may be considered cheating and will be logged.', 'color: red; font-size: 14px;');
      }
    }, 1000);

    // Clear interval when leaving page
    window.addEventListener('beforeunload', () => {
      clearInterval(devToolsDetector);
    });

    // Disable drag on images
    document.querySelectorAll('img').forEach(img => {
      img.addEventListener('dragstart', (e) => e.preventDefault());
    });
  </script>
</Layout>
