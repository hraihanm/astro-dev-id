---
export const prerender = false;

import Layout from '../../components/Layout.astro';
import { prisma } from '../../lib/db';
import { getSessionUser } from '../../lib/auth-guard';

const user = await getSessionUser(Astro.cookies);

let classroomIds: number[] = [];
if (user) {
  const memberships = await prisma.classroomMembership.findMany({
    where: { userId: user.id, status: 'ACTIVE' },
    select: { classroomId: true }
  });
  classroomIds = memberships.map((m) => m.classroomId);
}

const visibilityFilter: any =
  user?.role === 'admin'
    ? {}
    : {
        OR: [
          { NOT: { visibility: 'PRIVATE' } },
          {
            AND: [
              { visibility: 'PRIVATE' },
              classroomIds.length
                ? { classroomResources: { some: { classroomId: { in: classroomIds } } } }
                : { classroomResources: { some: { classroomId: -1 } } }
            ]
          }
        ]
      };

const courses = await prisma.course.findMany({
  where: visibilityFilter,
  include: {
    chapters: {
      orderBy: { order: 'asc' },
      select: { id: true, title: true, order: true }
    },
    quizzes: {
      select: { id: true, title: true }
    }
  },
  orderBy: { createdAt: 'desc' }
});
---

<Layout title="Semua Kursus">
  <div class="min-h-screen bg-gradient-to-b from-slate-50 via-white to-white">
    <div class="border-b bg-white/80 backdrop-blur">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
          <div class="space-y-3">
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-600">Koleksi Materi</p>
            <div class="flex flex-wrap items-center gap-3">
              <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Jelajahi Kursus</h1>
              <span class="rounded-full bg-blue-50 px-3 py-1 text-xs font-semibold text-blue-700">
                {courses.length} kursus tersedia
              </span>
            </div>
            <p class="max-w-3xl text-sm text-slate-600">
              Materi terkurasi dengan bab dan kuis pendukung. Lihat ringkasan isi kursus di setiap kartu
              sebelum kamu mulai belajar.
            </p>
          </div>
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
            <a
              href="/"
              class="inline-flex items-center justify-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:border-blue-200 hover:text-blue-700 hover:shadow-md"
            >
              Beranda
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7"></path>
              </svg>
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
      {courses.length === 0 ? (
        <div class="rounded-2xl border border-dashed border-slate-200 bg-white/80 p-10 text-center shadow-sm">
          <div class="mx-auto mb-4 flex h-14 w-14 items-center justify-center rounded-full bg-slate-100 text-2xl">ðŸ“š</div>
          <h3 class="text-xl font-semibold text-slate-900">Belum ada kursus</h3>
          <p class="mt-2 text-sm text-slate-600">Kursus akan segera tersedia. Silakan cek kembali nanti.</p>
        </div>
      ) : (
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-3">
          {courses.map((course) => (
            <a href={`/courses/${course.slug}`} class="group flex h-full flex-col overflow-hidden rounded-2xl border border-slate-200/80 bg-white/90 shadow-sm transition duration-200 hover:-translate-y-0.5 hover:shadow-lg">
              <div class="relative h-32 overflow-hidden bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-600">
                <div class="absolute inset-0 opacity-10">
                  <div class="absolute -left-6 top-4 h-24 w-24 rounded-full border-4 border-white"></div>
                  <div class="absolute right-0 -bottom-8 h-32 w-32 rounded-full border-4 border-white"></div>
                </div>
                <div class="flex h-full items-center justify-between px-6">
                  <div class="space-y-2">
                    <span class="inline-flex items-center gap-2 rounded-full bg-white/15 px-3 py-1 text-xs font-semibold text-white backdrop-blur">
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2-1.343-2-3-2z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14c-3.314 0-6 1.343-6 3v1h12v-1c0-1.657-2.686-3-6-3z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v2m4 0V4m-8 0v2"></path>
                      </svg>
                      {course.visibility === 'PRIVATE' ? 'Kelas Privat' : 'Kelas Publik'}
                    </span>
                    <h3 class="text-xl font-semibold text-white drop-shadow-sm">{course.title}</h3>
                  </div>
                  <span class="text-4xl">ðŸš€</span>
                </div>
              </div>

              <div class="flex flex-1 flex-col gap-4 p-6">
                <p class="text-sm leading-relaxed text-slate-600 line-clamp-3">
                  {course.description || 'Materi pembelajaran komprehensif untuk persiapan olimpiade.'}
                </p>

                <div class="flex flex-wrap gap-2 text-xs font-medium text-slate-600">
                  <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    {course.chapters.length} Bab
                  </span>
                  <span class="inline-flex items-center gap-2 rounded-full bg-blue-50 px-3 py-1 text-blue-700">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    {course.quizzes.length} Kuis
                  </span>
                </div>

                <div class="mt-auto flex items-center justify-between gap-3 border-t border-slate-100 pt-4">
                  <div class="flex items-center gap-2 text-sm font-semibold text-blue-700">
                    <span>Mulai belajar</span>
                    <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-blue-50 text-blue-700 transition group-hover:translate-x-1">
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7"></path>
                      </svg>
                    </span>
                  </div>
                  <div class="text-xs font-semibold text-slate-500">Terakhir diperbarui</div>
                </div>
              </div>
            </a>
          ))}
        </div>
      )}
    </div>
  </div>
</Layout>
