---
export const prerender = false;

import CourseLayout from '../../../../layouts/CourseLayout.astro';
import QuizCard from '../../../../components/QuizCard.astro';
import InteractiveBlockComponent from '../../../../components/InteractiveBlock.astro';
import { getChapterContent } from '../../../../lib/student';
import { renderMarkdown } from '../../../../lib/latex';
import { getCourseQuizzes, getChapterQuizzes } from '../../../../lib/quizzes';
import { parseBlocks, splitContentAtMarkers, type InteractiveBlock } from '../../../../lib/blocks';
import { getSessionUser } from '../../../../lib/auth-guard';
import { prisma } from '../../../../lib/db';

const { slug, order } = Astro.params;

if (!slug || !order) {
  return Astro.redirect('/courses');
}

const chapterOrder = parseInt(order);

// Get user from cookies for progress tracking and access control
const user = await getSessionUser(Astro.cookies);
let classroomIds: number[] = [];
if (user) {
  const memberships = await prisma.classroomMembership.findMany({
    where: { userId: user.id, status: 'ACTIVE' },
    select: { classroomId: true }
  });
  classroomIds = memberships.map((m) => m.classroomId);
}

const userId = user?.id;

const courseData = await getChapterContent(slug, chapterOrder, userId, {
  role: user?.role,
  classroomIds
});

if (!courseData || !courseData.chapter) {
  return Astro.redirect(`/courses/${slug}`);
}

const { course, chapter, prevChapter, nextChapter } = courseData;

// Parse blocks from chapter
const blocks = parseBlocks(chapter.blocks || null);

// Render markdown content
const renderedContent = chapter.content ? renderMarkdown(chapter.content) : '';

// Split content at block markers for proper interleaved rendering
const contentSegments = splitContentAtMarkers(renderedContent, blocks);

// Get quizzes for this chapter
const chapterQuizzes = await getChapterQuizzes(chapter.id);

// Parse quiz data
const quizzes = chapterQuizzes.map(quiz => {
  const settings = quiz.settings ? JSON.parse(quiz.settings) : {};
  const questions = quiz.questions ? JSON.parse(quiz.questions) : [];
  
  return {
    id: quiz.id,
    title: quiz.title,
    type: settings.type || 'multiple-choice',
    questionCount: settings.type === 'essay' ? (settings.problemCount || 0) : (Array.isArray(questions) ? questions.length : 0),
    isEssay: settings.type === 'essay'
  };
});
---

<CourseLayout title={`${chapter.title} - ${course.title}`} course={course} currentChapterOrder={chapterOrder}>
  <div class="bg-white rounded-lg border border-gray-200 p-8 lg:p-12">
    <div class="prose prose-lg max-w-none">
      <span class="text-sm font-semibold text-blue-600 uppercase tracking-wide mb-2 block">Chapter {chapter.order}</span>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-8">{chapter.title}</h1>
      
      {contentSegments.length > 0 ? (
        <div class="chapter-content-wrapper">
          {/* Render content and blocks in order (interleaved) */}
          {contentSegments.map((segment) => {
            if (segment.type === 'content') {
              return (
                <div class="chapter-content" set:html={segment.html} />
              );
            } else {
              // Find progress for this block
              const blockProgress = chapter.blockProgress?.find(
                (bp: any) => bp.blockId === segment.block.id
              );
              
              const progress = blockProgress ? {
                completed: blockProgress.completed,
                score: blockProgress.score || undefined,
                attempts: blockProgress.attempts
              } : undefined;
              
              return (
                <InteractiveBlockComponent
                  block={segment.block}
                  userId={userId}
                  progress={progress}
                />
              );
            }
          })}
        </div>
      ) : (
        <div class="text-center py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300">
          <div class="text-gray-400 mb-4">
            <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2" data-i18n="courses.contentComingSoon">Content Coming Soon</h3>
          <p class="text-gray-500" data-i18n="courses.contentBeingPrepared">This chapter is being prepared by your instructor.</p>
        </div>
      )}
    </div>

    <!-- Chapter Quizzes Section -->
    {quizzes.length > 0 ? (
      <div class="mt-12 pt-8 border-t border-gray-200">
        <div class="flex items-center mb-6">
          <div class="h-8 w-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center mr-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-900">Practice Quizzes</h3>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {quizzes.map((quiz) => (
            <QuizCard
              id={quiz.id}
              title={quiz.title}
              questionCount={quiz.questionCount}
              isEssay={quiz.isEssay}
              href={`/quizzes/${quiz.id}`}
            />
          ))}
        </div>
      </div>
    ) : (
      <div class="mt-12 pt-8 border-t border-gray-200">
        <div class="flex items-center mb-6">
          <div class="h-8 w-8 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center mr-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-400">Practice Quizzes</h3>
        </div>
        <p class="text-gray-500 italic">No quizzes available for this chapter yet.</p>
      </div>
    )}
    
    <!-- Navigation -->
    <div class="mt-12 flex justify-between items-center pt-8 border-t border-gray-200">
      <div>
        {prevChapter ? (
          <a
            href={`/courses/${course.slug}/chapter/${prevChapter.order}`}
            class="group inline-flex items-center text-gray-500 hover:text-blue-600 transition-colors"
          >
            <div class="mr-3 h-10 w-10 rounded-full border border-gray-200 flex items-center justify-center group-hover:border-blue-200 group-hover:bg-blue-50">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </div>
            <div class="text-left">
              <p class="text-xs text-gray-400 uppercase tracking-wider font-medium">Previous</p>
              <p class="text-sm font-medium">{prevChapter.title}</p>
            </div>
          </a>
        ) : (
          <div class="invisible">Placeholder</div>
        )}
      </div>
      
      <div>
        {nextChapter ? (
          <a
            href={`/courses/${course.slug}/chapter/${nextChapter.order}`}
            class="group inline-flex items-center text-gray-500 hover:text-blue-600 transition-colors text-right"
          >
            <div class="text-right">
              <p class="text-xs text-gray-400 uppercase tracking-wider font-medium">Next</p>
              <p class="text-sm font-medium">{nextChapter.title}</p>
            </div>
            <div class="ml-3 h-10 w-10 rounded-full border border-gray-200 flex items-center justify-center group-hover:border-blue-200 group-hover:bg-blue-50">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </a>
        ) : (
          <div class="invisible">Placeholder</div>
        )}
      </div>
    </div>
  </div>
</CourseLayout>

<style>
  .chapter-content {
    line-height: 1.7;
  }
  
  .chapter-content h1,
  .chapter-content h2,
  .chapter-content h3 {
    color: #1f2937;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 1rem;
  }
  
  .chapter-content p {
    margin-bottom: 1.5rem;
    color: #374151;
  }
  
  .chapter-content ul {
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
    list-style-type: disc;
  }
  
  .chapter-content ol {
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
    list-style-type: decimal;
  }
  
  .chapter-content li {
    margin-bottom: 0.5rem;
    display: list-item;
  }
  
  .chapter-content ul ul {
    list-style-type: circle;
  }
  
  .chapter-content ol ol {
    list-style-type: lower-alpha;
  }
  
  .chapter-content ol ol ol {
    list-style-type: lower-roman;
  }
  
  .chapter-content code {
    background-color: #f3f4f6;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
  }
  
  .chapter-content pre {
    background-color: #1f2937;
    color: #f9fafb;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5rem 0;
  }
  
  .chapter-content pre code {
    background-color: transparent;
    padding: 0;
    color: inherit;
  }

  /* Table styles for GFM tables */
  .chapter-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
  }
  
  .chapter-content table th,
  .chapter-content table td {
    border: 1px solid #e2e8f0;
    padding: 0.5rem 0.75rem;
    text-align: left;
  }
  
  .chapter-content table thead th {
    background-color: #f1f5f9;
    font-weight: 600;
  }
  
  .chapter-content table tbody tr:nth-child(even) {
    background-color: #f8fafc;
  }
  
  .chapter-content table tbody tr:hover {
    background-color: #f1f5f9;
  }

  /* Math rendering styles */
  .math-display {
    margin: 1.5rem 0;
    text-align: center;
  }

  .math-inline {
    display: inline-block;
    vertical-align: middle;
  }

  .latex-error {
    background-color: #fee;
    border: 1px solid #fcc;
    padding: 0.5rem;
    border-radius: 0.25rem;
    color: #c33;
  }
</style>

<script>
  // Client-side LaTeX rendering and code highlighting for performance
  (function() {
    // Load KaTeX CSS/JS once if not already loaded
    if (typeof window !== 'undefined' && !document.querySelector('link[href*="katex"]')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css';
      document.head.appendChild(link);
    }
    
    // Load Highlight.js CSS
    if (typeof window !== 'undefined' && !document.querySelector('link[href*="highlight.js"]')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css';
      document.head.appendChild(link);
    }

    // Load and render LaTeX after page loads
    function renderLatex() {
      const w = typeof window !== 'undefined' ? (window as any) : null;
      if (!w || !w.katex) return;
      
      const mathElements = document.querySelectorAll('.math-display, .math-inline');
      mathElements.forEach((element) => {
        const latex = element.getAttribute('data-latex') || '';
        const displayMode = element.classList.contains('math-display');
        
        try {
          w.katex.render(latex, element as HTMLElement, {
            displayMode,
            throwOnError: false,
            trust: true,
            macros: {
              '\\degree': '^{\\circ}'
            }
          });
        } catch (err: any) {
          console.warn('KaTeX render error:', err);
          (element as HTMLElement).innerHTML = `<span class="latex-error">LaTeX Error: ${err?.message || 'Unknown error'}</span>`;
        }
      });
    }
    
    // Highlight code blocks
    function highlightCode() {
      const w = typeof window !== 'undefined' ? (window as any) : null;
      if (!w || !w.hljs) return;
      
      const codeBlocks = document.querySelectorAll('pre code');
      codeBlocks.forEach((block) => {
        if (block instanceof HTMLElement) {
          w.hljs.highlightElement(block);
        }
      });
    }

    // Load dependencies and render
    if (typeof window !== 'undefined') {
      const w = window as any;
      let scriptsLoaded = 0;
      const totalScripts = 2; // KaTeX + Highlight.js
      
      function tryRender() {
        scriptsLoaded++;
        if (scriptsLoaded === totalScripts) {
          renderLatex();
          highlightCode();
        }
      }
      
      // Check if already loaded
      if (w.katex && w.hljs) {
        tryRender();
        tryRender();
      } else {
        // Load KaTeX
        if (w.katex) {
          tryRender();
        } else {
          const katexScript = document.createElement('script');
          katexScript.src = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js';
          katexScript.onload = tryRender;
          document.head.appendChild(katexScript);
        }
        
        // Load Highlight.js
        if (w.hljs) {
          tryRender();
        } else {
          const hljsScript = document.createElement('script');
          hljsScript.src = 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js';
          hljsScript.onload = tryRender;
          document.head.appendChild(hljsScript);
        }
      }
    }
  })();
</script>

