---
import Layout from '../../components/Layout.astro';
---

<Layout title="Daftar - Astro Learning">
  <div class="min-h-screen flex">
    <!-- Left Side - Decorative -->
    <div class="hidden lg:flex lg:w-2/5 bg-gradient-to-br from-blue-600 to-blue-700 relative overflow-hidden">
      <div class="absolute inset-0 opacity-10">
        <div class="absolute top-20 right-20 w-64 h-64 border-4 border-white rounded-full"></div>
        <div class="absolute bottom-20 left-20 w-48 h-48 border-4 border-white rounded-full"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 border-4 border-white rounded-full"></div>
      </div>
      
      <div class="relative z-10 flex flex-col items-center justify-center w-full p-12 text-white text-center">
        <div class="w-24 h-24 bg-white/20 backdrop-blur rounded-3xl flex items-center justify-center mb-8">
          <span class="text-5xl">‚ú®</span>
        </div>
        <h2 class="text-3xl font-bold mb-4">Bergabung Bersama Kami</h2>
        <p class="text-blue-100 text-lg max-w-md">
          Raih impianmu di Olimpiade Astronomi bersama ribuan pelajar lainnya
        </p>
        
        <div class="mt-12 space-y-4 text-left">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
              <span class="text-lg">üìö</span>
            </div>
            <span class="text-blue-100">Materi pembelajaran lengkap</span>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
              <span class="text-lg">üìù</span>
            </div>
            <span class="text-blue-100">Latihan soal interaktif</span>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
              <span class="text-lg">üìä</span>
            </div>
            <span class="text-blue-100">Pantau progres belajar</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Side - Form -->
    <div class="flex-1 flex items-center justify-center px-4 sm:px-6 lg:px-8 py-12 bg-white">
      <div class="w-full max-w-lg">
        <!-- Logo -->
        <div class="text-center mb-8">
          <a href="/" class="inline-flex items-center justify-center w-14 h-14 bg-blue-600 rounded-2xl text-white font-bold text-2xl mb-4 hover:scale-105 transition-transform shadow-lg">
            A
          </a>
          <h1 class="text-2xl font-bold text-slate-900">Buat Akun Baru</h1>
          <p class="text-slate-500 mt-2">Mulai perjalanan belajar astronomi</p>
        </div>
        
        <!-- OAuth -->
        <div class="space-y-3 mb-8">
          <a
            href="/api/auth/signin/google"
            class="w-full inline-flex items-center justify-center gap-3 py-3 px-4 border border-slate-300 rounded-xl text-slate-700 hover:border-blue-500 hover:text-blue-700 transition-colors shadow-sm"
          >
            <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google" class="w-5 h-5" loading="lazy" />
            <span class="font-semibold">Daftar dengan Google</span>
          </a>
          <div class="flex items-center">
            <div class="flex-1 border-t border-slate-200"></div>
            <span class="px-4 text-sm text-slate-400">atau daftar dengan email</span>
            <div class="flex-1 border-t border-slate-200"></div>
          </div>
        </div>
        
        <!-- Form -->
        <form id="signup-form" class="space-y-5">
          <!-- Error Message -->
          <div id="error-message" class="hidden rounded-xl bg-red-50 border border-red-200 p-4">
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
              </div>
              <p class="text-sm text-red-700 font-medium"></p>
            </div>
          </div>
          
          <!-- Name Fields -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="fullName" class="block text-sm font-medium text-slate-700 mb-1.5">
                Nama Lengkap
              </label>
              <input
                id="fullName"
                name="fullName"
                type="text"
                required
                class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-slate-900 placeholder-slate-400"
              />
            </div>
            
            <div>
              <label for="nickname" class="block text-sm font-medium text-slate-700 mb-1.5">
                Nama Panggilan
              </label>
              <input
                id="nickname"
                name="nickname"
                type="text"
                required
                class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-slate-900 placeholder-slate-400"
              />
            </div>
          </div>

          <!-- Grade & School -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="grade" class="block text-sm font-medium text-slate-700 mb-1.5">
                Kelas
              </label>
              <select
                id="grade"
                name="grade"
                required
                class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-slate-900 bg-white"
              >
                <option value="">Pilih kelas</option>
                <option value="7 SMP">7 SMP</option>
                <option value="8 SMP">8 SMP</option>
                <option value="9 SMP">9 SMP</option>
                <option value="10 SMA">10 SMA</option>
                <option value="11 SMA">11 SMA</option>
                <option value="12 SMA">12 SMA</option>
                <option value="Mahasiswa">Mahasiswa</option>
                <option value="Lainnya">Lainnya</option>
              </select>
            </div>

            <div>
              <label for="school" class="block text-sm font-medium text-slate-700 mb-1.5">
                Asal Sekolah
              </label>
              <input
                id="school"
                name="school"
                type="text"
                required
                class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-slate-900 placeholder-slate-400"
              />
            </div>
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-slate-700 mb-1.5">
              Alamat Email
            </label>
            <input
              id="email"
              name="email"
              type="email"
              required
              autocomplete="email"
              class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-slate-900 placeholder-slate-400"
              placeholder="nama@email.com"
            />
          </div>

          <!-- Password -->
          <div>
            <label for="password" class="block text-sm font-medium text-slate-700 mb-1.5">
              Kata Sandi
            </label>
            <div class="relative">
              <input
                id="password"
                name="password"
                type="password"
                required
                minlength="8"
                class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-slate-900 placeholder-slate-400 pr-12"
                placeholder="Minimal 8 karakter (huruf & angka)"
              />
              <button 
                type="button" 
                id="toggle-password"
                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
              >
                <svg id="eye-open" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                <svg id="eye-closed" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                </svg>
              </button>
            </div>
            <div id="password-requirements" class="mt-2 text-xs text-slate-500 space-y-1">
              <p class="flex items-center gap-1.5">
                <span id="req-length" class="w-4 h-4 rounded-full bg-slate-200 flex items-center justify-center text-[10px]">‚úó</span>
                Minimal 8 karakter
              </p>
              <p class="flex items-center gap-1.5">
                <span id="req-letter" class="w-4 h-4 rounded-full bg-slate-200 flex items-center justify-center text-[10px]">‚úó</span>
                Mengandung huruf (a-z, A-Z)
              </p>
              <p class="flex items-center gap-1.5">
                <span id="req-number" class="w-4 h-4 rounded-full bg-slate-200 flex items-center justify-center text-[10px]">‚úó</span>
                Mengandung angka (0-9)
              </p>
            </div>
          </div>

          <!-- Confirm Password -->
          <div>
            <label for="confirmPassword" class="block text-sm font-medium text-slate-700 mb-1.5">
              Konfirmasi Kata Sandi
            </label>
            <input
              id="confirmPassword"
              name="confirmPassword"
              type="password"
              required
              minlength="8"
              class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-slate-900 placeholder-slate-400"
              placeholder="Ulangi kata sandi"
            />
          </div>

          <!-- Terms -->
          <div class="flex items-start gap-3 p-4 bg-slate-50 rounded-xl border border-slate-200">
            <input
              id="terms"
              name="terms"
              type="checkbox"
              required
              class="mt-0.5 w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500"
            />
            <label for="terms" class="text-sm text-slate-600">
              Saya menyetujui <a href="/terms" class="text-blue-600 hover:underline font-medium">Syarat & Ketentuan</a> serta <a href="/privacy" class="text-blue-600 hover:underline font-medium">Kebijakan Privasi</a> platform ini.
            </label>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            id="submit-btn"
            class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all transform hover:scale-[1.02] focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-lg shadow-blue-500/25"
          >
            Daftar Sekarang
          </button>
        </form>

        <!-- Sign In Link -->
        <p class="text-center text-slate-600 mt-6">
          Sudah punya akun?
          <a href="/auth/signin" class="text-blue-600 hover:text-blue-700 font-semibold ml-1">
            Masuk
          </a>
        </p>
        
        <!-- Back Link -->
        <p class="text-center mt-4">
          <a href="/" class="text-slate-400 hover:text-slate-600 text-sm">
            ‚Üê Kembali ke beranda
          </a>
        </p>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Password validation helpers
  function validatePassword(password: string) {
    return {
      length: password.length >= 8,
      letter: /[a-zA-Z]/.test(password),
      number: /[0-9]/.test(password)
    };
  }

  function updatePasswordIndicators(validation: { length: boolean, letter: boolean, number: boolean }) {
    const reqLength = document.getElementById('req-length');
    const reqLetter = document.getElementById('req-letter');
    const reqNumber = document.getElementById('req-number');

    if (reqLength) {
      reqLength.textContent = validation.length ? '‚úì' : '‚úó';
      reqLength.className = `w-4 h-4 rounded-full flex items-center justify-center text-[10px] ${validation.length ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-500'}`;
    }
    if (reqLetter) {
      reqLetter.textContent = validation.letter ? '‚úì' : '‚úó';
      reqLetter.className = `w-4 h-4 rounded-full flex items-center justify-center text-[10px] ${validation.letter ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-500'}`;
    }
    if (reqNumber) {
      reqNumber.textContent = validation.number ? '‚úì' : '‚úó';
      reqNumber.className = `w-4 h-4 rounded-full flex items-center justify-center text-[10px] ${validation.number ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-500'}`;
    }
  }

  // Password input listener
  document.getElementById('password')?.addEventListener('input', (e) => {
    const password = (e.target as HTMLInputElement).value;
    const validation = validatePassword(password);
    updatePasswordIndicators(validation);
  });

  // Toggle password visibility
  document.getElementById('toggle-password')?.addEventListener('click', () => {
    const password = document.getElementById('password') as HTMLInputElement;
    const eyeOpen = document.getElementById('eye-open');
    const eyeClosed = document.getElementById('eye-closed');
    
    if (password.type === 'password') {
      password.type = 'text';
      eyeOpen?.classList.remove('hidden');
      eyeClosed?.classList.add('hidden');
    } else {
      password.type = 'password';
      eyeOpen?.classList.add('hidden');
      eyeClosed?.classList.remove('hidden');
    }
  });

  // Form submission
  document.getElementById('signup-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const errorDiv = document.getElementById('error-message');
    const errorText = errorDiv?.querySelector('p');
    const termsCheckbox = document.getElementById('terms') as HTMLInputElement;
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    const confirmPasswordInput = document.getElementById('confirmPassword') as HTMLInputElement;

    const email = emailInput.value.trim();

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      if (errorText) errorText.textContent = 'Email tidak valid';
      errorDiv?.classList.remove('hidden');
      return;
    }

    // Validate password
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    const validation = validatePassword(password);
    
    if (!validation.length || !validation.letter || !validation.number) {
      if (errorText) errorText.textContent = 'Kata sandi harus minimal 8 karakter dan mengandung huruf serta angka';
      errorDiv?.classList.remove('hidden');
      return;
    }

    if (password !== confirmPassword) {
      if (errorText) errorText.textContent = 'Konfirmasi kata sandi tidak cocok';
      errorDiv?.classList.remove('hidden');
      return;
    }

    if (!termsCheckbox.checked) {
      if (errorText) errorText.textContent = 'Anda harus menyetujui Syarat & Ketentuan';
      errorDiv?.classList.remove('hidden');
      return;
    }
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="inline-block animate-spin mr-2">‚è≥</span> Mendaftarkan...';
    errorDiv?.classList.add('hidden');
    
    const formData = new FormData(form);
    const data = {
      email: formData.get('email') as string,
      password: formData.get('password') as string,
      fullName: formData.get('fullName') as string,
      nickname: formData.get('nickname') as string,
      grade: formData.get('grade') as string,
      school: formData.get('school') as string
    };
    
    try {
      const response = await fetch('/api/auth/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      
      if (response.ok) {
        window.location.href = '/dashboard';
      } else {
        const result = await response.json();
        if (errorText) errorText.textContent = result.error || 'Pendaftaran gagal. Silakan coba lagi.';
        errorDiv?.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Daftar Sekarang';
      }
    } catch (error) {
      if (errorText) errorText.textContent = 'Terjadi kesalahan. Silakan coba lagi.';
      errorDiv?.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Daftar Sekarang';
    }
  });
</script>
