---
import Layout from '../../components/Layout.astro';
import Icon from '../../components/icons/Icon.astro';
import { prisma } from '../../lib/db';
import { getSessionUser } from '../../lib/auth-guard';

export const prerender = false;

const idParam = Astro.params.id;
const classroomId = idParam ? parseInt(idParam, 10) : NaN;
const user = await getSessionUser(Astro.cookies);

const classroom = Number.isNaN(classroomId)
  ? null
  : await prisma.classroom.findUnique({
      where: { id: classroomId },
      select: {
        id: true,
        title: true,
        description: true,
        isPrivate: true,
        createdAt: true,
        updatedAt: true,
        createdBy: true
      }
    });

let membership = null;
let resources: any[] = [];
let posts: any[] = [];
let members: any[] = [];
let pendingMembers: any[] = [];

if (classroom && user) {
  membership = await prisma.classroomMembership.findFirst({
    where: { classroomId, userId: user.id }
  });

  const isActive = membership?.status === 'ACTIVE' || user.role === 'admin';
  if (isActive) {
    resources = await prisma.classroomResource.findMany({
      where: { classroomId },
      orderBy: { pinnedAt: 'desc' },
      include: {
        course: { select: { id: true, title: true, slug: true, visibility: true } },
        quiz: { select: { id: true, title: true, quizType: true, visibility: true } }
      }
    });

    posts = await prisma.classroomPost.findMany({
      where: { classroomId },
      orderBy: [{ pinned: 'desc' }, { createdAt: 'desc' }],
      take: 20,
      include: {
        author: { select: { id: true, email: true } },
        comments: {
          orderBy: { createdAt: 'asc' },
          include: { author: { select: { id: true, email: true } } }
        }
      }
    });

    members = await prisma.classroomMembership.findMany({
      where: { classroomId, status: 'ACTIVE' },
      include: { user: { select: { id: true, email: true, role: true, name: true } } },
      orderBy: { createdAt: 'asc' }
    });

    pendingMembers = await prisma.classroomMembership.findMany({
      where: { classroomId, status: 'PENDING' },
      include: { user: { select: { id: true, email: true, role: true, name: true } } },
      orderBy: { createdAt: 'asc' }
    });
  }
}

// Guard: private classrooms only visible to admin or active members
if (classroom?.isPrivate && !(user?.role === 'admin') && !(membership && membership.status === 'ACTIVE')) {
  return Astro.redirect('/classrooms');
}
---

<Layout title={classroom ? classroom.title : 'Classroom'} description="Ruang kelas">
  <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-8">
    {!classroom && (
      <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
        <p class="text-slate-700">Kelas tidak ditemukan.</p>
      </div>
    )}

    {classroom && (
      <>
        <header class="relative overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-md">
          <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 via-indigo-500/10 to-purple-600/10 pointer-events-none"></div>
          <div class="relative p-6 space-y-4">
            <div class="flex items-start justify-between gap-4">
              <div class="space-y-2">
                <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-slate-500 flex-wrap">
                  <span>Classroom</span>
                  <span class="h-4 w-px bg-slate-200"></span>
                  <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                    Kode: #{classroom.id}
                  </span>
                  <span class={`inline-flex items-center gap-1 px-2 py-1 rounded-full border text-[11px] font-semibold ${classroom.isPrivate ? 'bg-rose-50 text-rose-700 border-rose-100' : 'bg-emerald-50 text-emerald-700 border-emerald-100'}`}>
                    {classroom.isPrivate ? 'Privat' : 'Publik'}
                  </span>
                </div>
                <h1 class="text-2xl md:text-3xl font-bold text-slate-900">{classroom.title}</h1>
                {classroom.description && <p class="text-slate-700 max-w-3xl">{classroom.description}</p>}
                <div class="flex items-center gap-3 text-sm text-slate-600 flex-wrap">
                  <a href={`/classrooms/${classroom.id}/courses`} class="inline-flex items-center gap-1 text-blue-700 hover:text-blue-800 font-semibold">
                    <Icon name="book-stack" class="w-4 h-4" />
                    Kursus kelas
                  </a>
                  <a href={`/classrooms/${classroom.id}/quizzes`} class="inline-flex items-center gap-1 text-blue-700 hover:text-blue-800 font-semibold">
                    <Icon name="puzzle" class="w-4 h-4" />
                    Kuis kelas
                  </a>
                  <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                    <Icon name="users" class="w-4 h-4 text-slate-500" />
                    {members.length} aktif
                  </span>
                  <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                    <Icon name="note" class="w-4 h-4 text-slate-500" />
                    {posts.length} post
                  </span>
                  <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                    <Icon name="bookmark" class="w-4 h-4 text-slate-500" />
                    {resources.length} resource
                  </span>
                </div>
              </div>
              <div class="flex flex-col items-end gap-2">
                {membership ? (
                  <span class="text-xs font-semibold px-3 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                    {membership.role} Â· {membership.status}
                  </span>
                ) : (
                  <span class="text-xs font-semibold px-3 py-1 rounded-full bg-slate-50 text-slate-600 border border-slate-200">
                    Belum bergabung
                  </span>
                )}
                {(membership?.role === 'TEACHER' || user?.role === 'admin') && (
                  <a
                    href={`/classrooms/${classroom.id}/settings`}
                    class="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg bg-slate-900 text-white hover:bg-slate-800 transition"
                  >
                    <Icon name="settings-sliders" class="w-4 h-4" />
                    Pengaturan
                  </a>
                )}
              </div>
            </div>

            {!user && (
              <div class="flex items-center gap-3 text-sm text-slate-700">
                <a href="/auth/signin" class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors">
                  Masuk untuk bergabung
                </a>
              </div>
            )}

            {user && !membership && (
              <div class="flex items-center gap-3">
                <button
                  type="button"
                  class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors"
                  id="join-btn"
                  data-classroom={classroom.id}
                >
                  {classroom.isPrivate ? 'Minta bergabung' : 'Gabung kelas'}
                </button>
                <p class="text-sm text-slate-600">{classroom.isPrivate ? 'Kelas privat; permintaan perlu disetujui.' : 'Kelas publik; kamu akan langsung masuk.'}</p>
              </div>
            )}

            {membership && membership.status === 'PENDING' && (
              <p class="text-sm text-amber-700 bg-amber-50 border border-amber-100 px-3 py-2 rounded-lg">
                Permintaan bergabung menunggu persetujuan.
              </p>
            )}

          </div>
        </header>

        <div class="sticky top-[70px] md:top-[84px] lg:top-[90px] z-30 mt-4 px-4 py-2.5 text-sm font-semibold flex items-center gap-6 rounded-xl border border-slate-200 bg-white/95 backdrop-blur shadow-sm">
          <button type="button" class="tab-btn text-slate-600 hover:text-blue-700 transition-colors" data-tab="stream">Stream</button>
          <button type="button" class="tab-btn text-slate-600 hover:text-blue-700 transition-colors" data-tab="classwork">Classwork</button>
          <button type="button" class="tab-btn text-slate-600 hover:text-blue-700 transition-colors" data-tab="people">People</button>
        </div>

        {user && (membership?.status === 'ACTIVE' || user.role === 'admin') ? (
          <>
            <div class="space-y-8" data-tab-panel="stream">
              <section class="space-y-4">
                <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
                  <div class="flex items-center justify-between mb-3">
                    <div>
                      <h2 class="text-sm font-semibold text-slate-800">Buat Post</h2>
                      <p class="text-xs text-slate-500">Pengumuman, diskusi, atau catatan singkat.</p>
                    </div>
                    <span id="post-status" class="text-xs text-slate-500"></span>
                  </div>
                  <textarea
                    id="post-content"
                    class="w-full border border-slate-200 rounded-xl p-3 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-slate-50"
                    placeholder="Contoh: Jadwal kuis minggu ini, materi baru, atau tautan referensi..."
                    rows="3"
                  ></textarea>
                  <div class="flex items-center justify-between mt-3 text-xs text-slate-500">
                    <span>Tips: singkat, sertakan tautan, gunakan komentar untuk diskusi.</span>
                    <div class="flex gap-2">
                      <button
                        type="button"
                        id="post-clear"
                        class="px-3 py-1.5 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50"
                      >
                        Bersihkan
                      </button>
                      <button
                        type="button"
                        id="post-submit"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm"
                        data-classroom={classroom.id}
                      >
                        Post
                      </button>
                    </div>
                  </div>
                </div>

                <div class="space-y-3">
                  {posts.length === 0 ? (
                    <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm text-slate-700 text-center">
                      <p class="font-semibold text-slate-800">Belum ada post</p>
                      <p class="text-sm text-slate-500">Mulai percakapan pertama untuk kelas ini.</p>
                    </div>
                  ) : (
                    posts.map((post) => (
                      <article class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm space-y-3">
                        <div class="flex items-center justify-between">
                          <div class="text-sm text-slate-600">
                            <span class="font-semibold text-slate-800">{post.author.email}</span>
                            <span class="text-xs text-slate-500 block">{new Date(post.createdAt).toLocaleString('id-ID')}</span>
                          </div>
                          <div class="flex items-center gap-2">
                            {post.pinned && <span class="text-xs px-2 py-1 bg-yellow-50 border border-yellow-100 text-yellow-700 rounded">Pinned</span>}
                            {(membership?.role === 'TEACHER' || user.role === 'admin' || post.authorId === user.id) && (
                              <button
                                type="button"
                                class="text-xs text-red-600 hover:text-red-700"
                                data-delete-post={post.id}
                                data-classroom={classroom.id}
                              >
                                Hapus
                              </button>
                            )}
                          </div>
                        </div>
                        <p class="text-slate-800 whitespace-pre-wrap text-sm leading-relaxed">{post.content}</p>

                        <div class="border-t border-slate-100 pt-3 space-y-3">
                          {post.comments.length === 0 ? (
                            <p class="text-xs text-slate-500">Belum ada komentar.</p>
                          ) : (
                            post.comments.map((c: any) => (
                              <div class="text-sm flex items-start justify-between bg-slate-50 border border-slate-100 rounded-lg px-3 py-2">
                                <div class="space-y-0.5">
                                  <span class="font-medium text-slate-800">{c.author.email}</span>{' '}
                                  <span class="text-slate-700">{c.content}</span>
                                  <div class="text-[11px] text-slate-500">{new Date(c.createdAt).toLocaleString('id-ID')}</div>
                                </div>
                              </div>
                            ))
                          )}
                          <div class="flex items-center gap-2">
                            <input
                              type="text"
                              class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
                              placeholder="Tulis komentar"
                              data-comment-input={post.id}
                            />
                            <button
                              type="button"
                              class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm font-semibold hover:bg-slate-900 transition-colors"
                              data-comment-submit={post.id}
                              data-classroom={classroom.id}
                            >
                              Kirim
                            </button>
                          </div>
                        </div>
                      </article>
                    ))
                  )}
                </div>

                <div class="grid gap-4 lg:grid-cols-2">
                  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                    <h3 class="text-sm font-semibold text-slate-800 mb-3">Tautan cepat</h3>
                    <div class="flex flex-col gap-2 text-sm">
                      <a href={`/classrooms/${classroom.id}/courses`} class="flex items-center justify-between rounded-lg border border-slate-200 px-3 py-2 hover:border-blue-200 hover:text-blue-700 transition">
                        <span class="inline-flex items-center gap-2">
                          <Icon name="book-stack" class="w-4 h-4" />
                          Kursus kelas
                        </span>
                        <span class="text-xs text-slate-500">Buka</span>
                      </a>
                      <a href={`/classrooms/${classroom.id}/quizzes`} class="flex items-center justify-between rounded-lg border border-slate-200 px-3 py-2 hover:border-blue-200 hover:text-blue-700 transition">
                        <span class="inline-flex items-center gap-2">
                          <Icon name="puzzle" class="w-4 h-4" />
                          Kuis kelas
                        </span>
                        <span class="text-xs text-slate-500">Buka</span>
                      </a>
                    </div>
                  </div>

                  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                    <h3 class="text-sm font-semibold text-slate-800 mb-3">Resource terpin</h3>
                    {resources.length === 0 ? (
                      <p class="text-sm text-slate-600">Belum ada resource.</p>
                    ) : (
                      <ul class="space-y-2 text-sm">
                        {resources.map((res) => (
                          <li class="flex items-center gap-2">
                            <Icon name="bookmark" class="w-4 h-4 text-slate-500" />
                            {res.course ? (
                              <a class="text-blue-700 hover:underline" href={`/courses/${res.course.slug}`}>{res.course.title}</a>
                            ) : res.quiz ? (
                              <a class="text-blue-700 hover:underline" href={`/quizzes/${res.quiz.id}`}>{res.quiz.title}</a>
                            ) : (
                              <span class="text-slate-600">Resource</span>
                            )}
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>
                </div>
              </section>
            </div>

            <div class="space-y-6" data-tab-panel="classwork" style="display:none">
              <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm space-y-4">
                <div class="flex items-center justify-between">
                  <div>
                    <h3 class="text-sm font-semibold text-slate-800">Materi & Resource</h3>
                    <p class="text-xs text-slate-500">Kursus, kuis, atau resource lain yang ditautkan.</p>
                  </div>
                  <span class="text-xs text-slate-500">{resources.length} resource</span>
                </div>
                {resources.length === 0 ? (
                  <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50 px-4 py-6 text-center text-sm text-slate-600">
                    Belum ada resource tertaut. Tautkan kursus/kuis ke kelas ini.
                  </div>
                ) : (
                  <div class="grid gap-3 md:grid-cols-2">
                    {resources.map((res) => {
                      const isCourse = !!res.course;
                      const title = res.course?.title || res.quiz?.title || 'Resource';
                      const href = res.course ? `/courses/${res.course.slug}` : res.quiz ? `/quizzes/${res.quiz.id}` : '#';
                      const visibility = res.course?.visibility || res.quiz?.visibility || 'PUBLIC';
                      return (
                        <a
                          class="group flex flex-col gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 shadow-sm hover:border-blue-200 hover:shadow transition"
                          href={href}
                        >
                          <div class="flex items-center justify-between">
                            <div class="inline-flex items-center gap-2 text-xs font-semibold rounded-full px-2 py-1 bg-slate-100 text-slate-700 border border-slate-200">
                              <Icon name={isCourse ? 'book' : 'puzzle'} class="w-4 h-4 text-slate-500" />
                              {isCourse ? 'Kursus' : 'Kuis'}
                            </div>
                            <span class={`text-[11px] px-2 py-1 rounded-full border ${visibility === 'PRIVATE' ? 'bg-rose-50 text-rose-700 border-rose-100' : 'bg-emerald-50 text-emerald-700 border-emerald-100'}`}>
                              {visibility === 'PRIVATE' ? 'Privat' : 'Publik'}
                            </span>
                          </div>
                          <div class="text-sm font-semibold text-slate-900 group-hover:text-blue-800">{title}</div>
                          <div class="flex items-center justify-between text-xs text-slate-500">
                            <span class="inline-flex items-center gap-1">
                              <Icon name="calendar" class="w-3.5 h-3.5" />
                              {new Date(res.createdAt).toLocaleDateString('id-ID')}
                            </span>
                            {res.quiz?.quizType && (
                              <span class="inline-flex items-center gap-1">
                                <Icon name="badge" class="w-3.5 h-3.5" />
                                {res.quiz.quizType === 'exam' ? 'Ujian' : 'Latihan'}
                              </span>
                            )}
                          </div>
                        </a>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>

            <div class="space-y-6" data-tab-panel="people" style="display:none">
              <div class="grid gap-4 md:grid-cols-4">
                <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                  <p class="text-xs text-slate-500">Anggota aktif</p>
                  <p class="text-2xl font-bold text-slate-900">{members.length}</p>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                  <p class="text-xs text-slate-500">Permintaan pending</p>
                  <p class="text-2xl font-bold text-amber-600">{pendingMembers.length}</p>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                  <p class="text-xs text-slate-500">Resource tertaut</p>
                  <p class="text-2xl font-bold text-slate-900">{resources.length}</p>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                  <p class="text-xs text-slate-500">Guru/Admin</p>
                  <p class="text-2xl font-bold text-slate-900">{members.filter((m) => m.role !== 'STUDENT').length}</p>
                </div>
              </div>

              {(membership?.role === 'TEACHER' || user.role === 'admin') && (
                <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm space-y-4">
                  <div class="flex items-center justify-between flex-wrap gap-2">
                    <div>
                      <h3 class="text-sm font-semibold text-slate-800">Tambah anggota langsung</h3>
                      <p class="text-xs text-slate-500">Masukkan ID atau email, bisa pisahkan dengan koma untuk banyak sekaligus. Anggota baru akan ditambahkan sebagai siswa.</p>
                    </div>
                    <span class="text-[11px] rounded-full bg-slate-100 px-2 py-1 text-slate-700 border border-slate-200">Default: Siswa</span>
                  </div>
                  <div class="flex flex-col gap-2 sm:flex-row">
                    <input
                      type="text"
                      id="people-invite-input"
                      class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
                      placeholder="123, 456 atau email@contoh.com, other@mail.com"
                    />
                    <button
                      type="button"
                      id="people-invite-btn"
                      class="px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition-colors"
                      data-classroom={classroom.id}
                    >
                      Tambahkan anggota
                    </button>
                  </div>
                  <p id="people-invite-status" class="text-xs text-slate-500"></p>
                </div>
              )}

              <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm space-y-4">
                <div class="flex items-center gap-3 flex-wrap">
                  <h3 class="text-sm font-semibold text-slate-800">Anggota aktif</h3>
                  <div class="flex-1"></div>
                  <div class="relative w-full sm:w-64">
                    <Icon name="search" class="w-4 h-4 text-slate-400 absolute left-3 top-2.5" />
                    <input
                      id="people-filter"
                      type="text"
                      class="w-full pl-9 pr-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
                      placeholder="Cari nama atau email"
                    />
                  </div>
                </div>
                {members.length === 0 ? (
                  <p class="text-sm text-slate-600">Belum ada anggota aktif.</p>
                ) : (
                  <div class="space-y-4" id="people-list">
                    <div class="space-y-2">
                      <div class="text-xs uppercase tracking-wide text-slate-500 font-semibold">Pengajar & Admin</div>
                      <div class="flex flex-col gap-3">
                        {members.filter((m) => m.role !== 'STUDENT').map((m) => {
                      const displayName = (m.user.name && m.user.name.trim()) ? m.user.name.trim() : (m.user.email || '');
                          const initial = (displayName || m.user.email || '?').trim().charAt(0).toUpperCase();
                          const canKick = user?.role === 'admin' && m.userId !== user.id;
                          return (
                            <div
                              class="flex items-center gap-3 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2"
                              data-name={displayName?.toLowerCase()}
                              data-email={m.user.email?.toLowerCase()}
                              data-person-card="true"
                            >
                              <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-blue-500 text-white font-semibold flex items-center justify-center">
                                {initial}
                              </div>
                              <div class="min-w-0 flex-1">
                                <div class="font-semibold text-slate-900 truncate">{displayName}</div>
                                <div class="text-xs text-slate-500 truncate">{m.user.email}</div>
                              </div>
                              <span class="text-[11px] px-2 py-1 rounded-full bg-purple-50 text-purple-700 border border-purple-100">
                                {m.role}
                              </span>
                              {canKick && (
                                <button
                                  type="button"
                                  class="kick-member-btn px-2.5 py-1 text-xs font-semibold rounded-lg bg-red-50 text-red-700 hover:bg-red-100 transition-colors border border-red-100"
                                  data-user-id={m.userId}
                                  data-classroom={classroom.id}
                                  title="Keluarkan anggota"
                                >
                                  Keluarkan
                                </button>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    <div class="space-y-2">
                      <div class="text-xs uppercase tracking-wide text-slate-500 font-semibold">Siswa</div>
                      <div class="flex flex-col gap-3">
                        {members.filter((m) => m.role === 'STUDENT').map((m) => {
                      const displayName = (m.user.name && m.user.name.trim()) ? m.user.name.trim() : (m.user.email || '');
                          const initial = (displayName || m.user.email || '?').trim().charAt(0).toUpperCase();
                          const canKick = user?.role === 'admin' && m.userId !== user.id;
                          const canPromote = (membership?.role === 'TEACHER' || user?.role === 'admin') && m.userId !== user.id;
                          return (
                            <div
                              class="flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-3 py-2"
                              data-name={displayName?.toLowerCase()}
                              data-email={m.user.email?.toLowerCase()}
                              data-person-card="true"
                            >
                              <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-200 to-slate-300 text-slate-700 font-semibold flex items-center justify-center">
                                {initial}
                              </div>
                              <div class="min-w-0 flex-1">
                                <div class="font-semibold text-slate-900 truncate">{displayName}</div>
                                <div class="text-xs text-slate-500 truncate">{m.user.email}</div>
                              </div>
                              <span class="text-[11px] px-2 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                                Siswa
                              </span>
                              {canPromote && (
                                <button
                                  type="button"
                                  class="promote-member-btn px-2.5 py-1 text-xs font-semibold rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors border border-blue-100"
                                  data-user-id={m.userId}
                                  data-classroom={classroom.id}
                                  title="Promosikan menjadi guru"
                                >
                                  Jadikan Guru
                                </button>
                              )}
                              {canKick && (
                                <button
                                  type="button"
                                  class="kick-member-btn px-2.5 py-1 text-xs font-semibold rounded-lg bg-red-50 text-red-700 hover:bg-red-100 transition-colors border border-red-100"
                                  data-user-id={m.userId}
                                  data-classroom={classroom.id}
                                  title="Keluarkan anggota"
                                >
                                  Keluarkan
                                </button>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {(membership?.role === 'TEACHER' || user.role === 'admin') && pendingMembers.length > 0 && (
                <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm space-y-3">
                  <div class="flex items-center justify-between flex-wrap gap-2">
                    <h3 class="text-sm font-semibold text-slate-800">Permintaan bergabung</h3>
                    <button
                      type="button"
                      class="text-xs font-semibold px-3 py-1.5 rounded bg-emerald-50 text-emerald-700 border border-emerald-100 hover:bg-emerald-100"
                      id="approve-all-btn"
                      data-classroom={classroom.id}
                    >
                      Setujui semua
                    </button>
                  </div>
                  <div class="space-y-2">
                    {pendingMembers.map((m) => {
                      const displayName = m.user.name || m.user.email;
                      return (
                        <div class="flex items-center justify-between rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm">
                          <div>
                            <div class="font-medium text-slate-800">{displayName}</div>
                            <div class="text-xs text-slate-500">{m.user.email}</div>
                          </div>
                          <div class="flex items-center gap-2">
                            <button
                              type="button"
                              class="px-3 py-1 text-xs font-semibold rounded bg-green-600 text-white approve-member-btn"
                              data-user-id={m.userId}
                              data-classroom={classroom.id}
                            >
                              Setujui
                            </button>
                            <button
                              type="button"
                              class="px-3 py-1 text-xs font-semibold rounded bg-red-600 text-white reject-member-btn"
                              data-user-id={m.userId}
                              data-classroom={classroom.id}
                            >
                              Tolak
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          </>
        ) : (
          user && (
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
              <p class="text-slate-700">Kamu belum menjadi anggota kelas ini.</p>
              <button
                type="button"
                class="mt-3 inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors"
                id="join-btn"
                data-classroom={classroom.id}
              >
                Minta bergabung
              </button>
            </div>
          )
        )}
      </>
    )}
  </main>

  {user && (
    <div
      id="class-meta"
      data-class-id={classroom?.id}
      data-class-title={classroom?.title || ''}
      data-class-desc={classroom?.description || ''}
      data-class-private={classroom?.isPrivate ? 'true' : 'false'}
      class="hidden"
    ></div>
    <script type="module">
      const metaEl = document.querySelector('#class-meta');
      const classIdAttr = metaEl ? metaEl.getAttribute('data-class-id') : null;
      const classId = classIdAttr ? parseInt(classIdAttr, 10) : null;
      const classTitle = metaEl ? metaEl.getAttribute('data-class-title') || '' : '';
      const classDesc = metaEl ? metaEl.getAttribute('data-class-desc') || '' : '';
      const classPrivate = metaEl ? metaEl.getAttribute('data-class-private') === 'true' : true;
      const joinBtn = document.querySelector('#join-btn');
      if (joinBtn) {
        if (!classPrivate) joinBtn.textContent = 'Gabung kelas';
        joinBtn.addEventListener('click', async () => {
          const id = joinBtn.getAttribute('data-classroom');
          joinBtn.textContent = classPrivate ? 'Meminta...' : 'Menggabungkan...';
          joinBtn.disabled = true;
          try {
            const res = await fetch(`/api/classrooms/${id}/join`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
            if (res.ok) {
              joinBtn.textContent = classPrivate ? 'Diminta' : 'Bergabung';
              if (!classPrivate) {
                // For public classrooms, refresh to show membership immediately
                window.location.reload();
              }
            } else {
              const data = await res.json().catch(() => ({}));
              joinBtn.textContent = 'Gagal';
              alert(data.error || 'Gagal meminta bergabung');
            }
          } catch (err) {
            joinBtn.textContent = 'Gagal';
            alert('Tidak dapat mengirim permintaan');
          } finally {
            setTimeout(() => {
              joinBtn.textContent = classPrivate ? 'Minta bergabung' : 'Gabung kelas';
              joinBtn.disabled = false;
            }, 1500);
          }
        });
      }

      const postBtn = document.querySelector('#post-submit');
      const postContentEl = document.querySelector('#post-content');
      const postContent = postContentEl instanceof HTMLTextAreaElement ? postContentEl : null;
      const postClear = document.querySelector('#post-clear');
      const postStatus = document.querySelector('#post-status');
      if (postClear && postContent) {
        postClear.addEventListener('click', () => {
          postContent.value = '';
          if (postStatus instanceof HTMLElement) postStatus.textContent = '';
        });
      }
      if (postBtn && postContent) {
        postBtn.addEventListener('click', async () => {
          const id = postBtn.getAttribute('data-classroom');
          const content = postContent.value.trim();
          if (!content) return alert('Isi konten dulu.');
          postBtn.textContent = 'Mengirim...';
          postBtn.setAttribute('disabled', 'true');
          if (postStatus instanceof HTMLElement) {
            postStatus.textContent = 'Mengirim...';
            postStatus.className = 'text-xs text-slate-500';
          }
          try {
            const res = await fetch(`/api/classrooms/${id}/posts`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content })
            });
            if (res.ok) {
              if (postStatus instanceof HTMLElement) {
                postStatus.textContent = 'Terkirim. Memuat ulang...';
                postStatus.className = 'text-xs text-emerald-600';
              }
              location.reload();
            } else {
              const data = await res.json().catch(() => ({}));
              alert(data.error || 'Gagal membuat post');
            }
          } finally {
            postBtn.textContent = 'Post';
            postBtn.removeAttribute('disabled');
            if (postStatus instanceof HTMLElement && !postStatus.textContent) {
              postStatus.textContent = '';
            }
          }
        });
      }

      document.querySelectorAll('[data-comment-submit]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const postId = btn.getAttribute('data-comment-submit');
          const classroomId = btn.getAttribute('data-classroom');
          const inputEl = document.querySelector(`[data-comment-input="${postId}"]`);
          const input = inputEl instanceof HTMLInputElement ? inputEl : null;
          if (!input) return;
          const content = input.value.trim();
          if (!content) return;
          btn.textContent = 'Mengirim...';
          if (btn instanceof HTMLButtonElement) btn.disabled = true;
          try {
            const res = await fetch(`/api/classrooms/${classroomId}/posts/${postId}/comments`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content })
            });
            if (res.ok) {
              location.reload();
            } else {
              const data = await res.json().catch(() => ({}));
              alert(data.error || 'Gagal mengirim komentar');
            }
          } finally {
            btn.textContent = 'Kirim';
            if (btn instanceof HTMLButtonElement) btn.disabled = false;
          }
        });
      });

      const inviteBtn = document.querySelector('#people-invite-btn');
      const inviteInput = document.querySelector('#people-invite-input');
      const inviteStatus = document.querySelector('#people-invite-status');
      if (inviteBtn && inviteInput && classId) {
        inviteBtn.addEventListener('click', async () => {
          const raw = inviteInput.value.trim();
          if (!raw) {
            inviteStatus.textContent = 'ID atau email wajib diisi.';
            inviteStatus.className = 'text-xs text-red-600';
            return;
          }
          const tokens = raw.split(',').map((s) => s.trim()).filter(Boolean);
          if (tokens.length === 0) {
            inviteStatus.textContent = 'Masukkan minimal satu ID/email.';
            inviteStatus.className = 'text-xs text-red-600';
            return;
          }
          inviteBtn.textContent = 'Menambahkan...';
          inviteBtn.setAttribute('disabled', 'true');
          inviteStatus.textContent = '';
          let success = 0;
          for (const token of tokens) {
            const userId = /^\d+$/.test(token) ? parseInt(token, 10) : null;
            const email = userId ? null : token;
            try {
              const res = await fetch(`/api/classrooms/${classId}/invite`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userId ? { userId } : { email })
              });
              if (res.ok) success += 1;
            } catch (err) {
              // ignore, aggregate result
            }
          }
          inviteStatus.textContent = success > 0 ? `Berhasil menambahkan ${success} anggota.` : 'Tidak ada anggota yang ditambahkan.';
          inviteStatus.className = success > 0 ? 'text-xs text-emerald-600' : 'text-xs text-red-600';
          inviteInput.value = '';
          inviteBtn.textContent = 'Tambahkan anggota';
          inviteBtn.removeAttribute('disabled');
          if (success > 0) {
            setTimeout(() => window.location.reload(), 600);
          }
        });
      }

  // Tabs
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabPanels = document.querySelectorAll('[data-tab-panel]');
  function setTab(tab) {
    tabPanels.forEach((panel) => {
      const active = panel.getAttribute('data-tab-panel') === tab;
      panel.setAttribute('style', active ? '' : 'display:none');
    });
    tabButtons.forEach((btn) => {
      btn.classList.toggle('text-blue-700', btn.getAttribute('data-tab') === tab);
      btn.classList.toggle('text-slate-600', btn.getAttribute('data-tab') !== tab);
    });
  }
  tabButtons.forEach((btn) => {
    btn.addEventListener('click', () => setTab(btn.getAttribute('data-tab') || 'stream'));
  });
  setTab('stream');

  // People filter
  const peopleFilter = document.querySelector('#people-filter');
  if (peopleFilter) {
    peopleFilter.addEventListener('input', () => {
      const term = peopleFilter instanceof HTMLInputElement ? peopleFilter.value.toLowerCase() : '';
      document.querySelectorAll('#people-list [data-person-card]').forEach((card) => {
        const name = card.getAttribute('data-name') || '';
        const email = card.getAttribute('data-email') || '';
        const match = !term || name.includes(term) || email.includes(term);
        card.setAttribute('style', match ? '' : 'display:none');
      });
    });
  }

  // Approve / reject pending members
  document.querySelectorAll('.approve-member-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const uid = btn.getAttribute('data-user-id');
      const cid = btn.getAttribute('data-classroom');
      if (!uid || !cid) return;
      btn.textContent = 'Menyetujui...';
      btn.setAttribute('disabled', 'true');
      try {
        const res = await fetch(`/api/classrooms/${cid}/members`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: uid, status: 'ACTIVE', role: 'STUDENT' })
        });
        if (res.ok) {
          window.location.reload();
        } else {
          const body = await res.json().catch(() => ({}));
          alert(body.error || 'Gagal menyetujui');
        }
      } finally {
        btn.textContent = 'Setujui';
        btn.removeAttribute('disabled');
      }
    });
  });
  document.querySelectorAll('.reject-member-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const uid = btn.getAttribute('data-user-id');
      const cid = btn.getAttribute('data-classroom');
      if (!uid || !cid) return;
      btn.textContent = 'Menolak...';
      btn.setAttribute('disabled', 'true');
      try {
        const res = await fetch(`/api/classrooms/${cid}/members`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: uid })
        });
        if (res.ok) {
          window.location.reload();
        } else {
          const body = await res.json().catch(() => ({}));
          alert(body.error || 'Gagal menolak');
        }
      } finally {
        btn.textContent = 'Tolak';
        btn.removeAttribute('disabled');
      }
    });
  });

  // Promote students to teacher
  document.querySelectorAll('.promote-member-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const uid = btn.getAttribute('data-user-id');
      const cid = btn.getAttribute('data-classroom');
      if (!uid || !cid) return;
      if (!confirm('Promosikan siswa ini menjadi guru kelas?')) return;
      btn.textContent = 'Mempromosikan...';
      btn.setAttribute('disabled', 'true');
      try {
        const res = await fetch(`/api/classrooms/${cid}/members`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: uid, role: 'TEACHER', status: 'ACTIVE' })
        });
        if (res.ok) {
          window.location.reload();
        } else {
          const body = await res.json().catch(() => ({}));
          alert(body.error || 'Gagal mempromosikan anggota');
        }
      } finally {
        btn.textContent = 'Jadikan Guru';
        btn.removeAttribute('disabled');
      }
    });
  });

  // Kick members (admin only)
  document.querySelectorAll('.kick-member-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const uid = btn.getAttribute('data-user-id');
      const cid = btn.getAttribute('data-classroom');
      if (!uid || !cid) return;
      if (!confirm('Keluarkan anggota ini dari kelas?')) return;
      btn.textContent = 'Mengeluarkan...';
      btn.setAttribute('disabled', 'true');
      try {
        const res = await fetch(`/api/classrooms/${cid}/members`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: uid })
        });
        if (res.ok) {
          window.location.reload();
        } else {
          const body = await res.json().catch(() => ({}));
          alert(body.error || 'Gagal mengeluarkan anggota');
        }
      } finally {
        btn.textContent = 'Keluarkan';
        btn.removeAttribute('disabled');
      }
    });
  });

  // Approve all pending
  const approveAllBtn = document.querySelector('#approve-all-btn');
  if (approveAllBtn) {
    approveAllBtn.addEventListener('click', async () => {
      const cid = approveAllBtn.getAttribute('data-classroom');
      if (!cid) return;
      approveAllBtn.textContent = 'Menyetujui...';
      approveAllBtn.setAttribute('disabled', 'true');
      const pendingBtns = Array.from(document.querySelectorAll('.approve-member-btn'));
      try {
        for (const btn of pendingBtns) {
          const uid = btn.getAttribute('data-user-id');
          if (!uid) continue;
          await fetch(`/api/classrooms/${cid}/members`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: uid, status: 'ACTIVE', role: 'STUDENT' })
          });
        }
        window.location.reload();
      } finally {
        approveAllBtn.textContent = 'Setujui semua';
        approveAllBtn.removeAttribute('disabled');
      }
    });
  }

    </script>
  )}
</Layout>

