---
import Layout from '../../components/Layout.astro';
import Icon from '../../components/icons/Icon.astro';
import { prisma } from '../../lib/db';
import { getSessionUser } from '../../lib/auth-guard';

export const prerender = false;

const idParam = Astro.params.id;
const classroomId = idParam ? parseInt(idParam, 10) : NaN;
const user = await getSessionUser(Astro.cookies);

const classroom = Number.isNaN(classroomId)
  ? null
  : await prisma.classroom.findUnique({
      where: { id: classroomId },
      select: {
        id: true,
        title: true,
        description: true,
        isPrivate: true,
        createdAt: true,
        updatedAt: true,
        createdBy: true
      }
    });

let membership = null;
let resources: any[] = [];
let posts: any[] = [];
let members: any[] = [];
let pendingMembers: any[] = [];

if (classroom && user) {
  membership = await prisma.classroomMembership.findFirst({
    where: { classroomId, userId: user.id }
  });

  const isActive = membership?.status === 'ACTIVE' || user.role === 'admin';
  if (isActive) {
    resources = await prisma.classroomResource.findMany({
      where: { classroomId },
      orderBy: { pinnedAt: 'desc' },
      include: {
        course: { select: { id: true, title: true, slug: true } },
        quiz: { select: { id: true, title: true, quizType: true } }
      }
    });

    posts = await prisma.classroomPost.findMany({
      where: { classroomId },
      orderBy: [{ pinned: 'desc' }, { createdAt: 'desc' }],
      take: 20,
      include: {
        author: { select: { id: true, email: true } },
        comments: {
          orderBy: { createdAt: 'asc' },
          include: { author: { select: { id: true, email: true } } }
        }
      }
    });

    members = await prisma.classroomMembership.findMany({
      where: { classroomId, status: 'ACTIVE' },
      include: { user: { select: { id: true, email: true, role: true, name: true } } },
      orderBy: { createdAt: 'asc' }
    });

    pendingMembers = await prisma.classroomMembership.findMany({
      where: { classroomId, status: 'PENDING' },
      include: { user: { select: { id: true, email: true, role: true, name: true } } },
      orderBy: { createdAt: 'asc' }
    });
  }
}

// Guard: private classrooms only visible to admin or active members
if (classroom?.isPrivate && !(user?.role === 'admin') && !(membership && membership.status === 'ACTIVE')) {
  return Astro.redirect('/classrooms');
}
---

<Layout title={classroom ? classroom.title : 'Classroom'} description="Ruang kelas">
  <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-8">
    {!classroom && (
      <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
        <p class="text-slate-700">Kelas tidak ditemukan.</p>
      </div>
    )}

    {classroom && (
      <>
        <header class="relative overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-md">
          <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 via-indigo-500/10 to-purple-600/10 pointer-events-none"></div>
          <div class="relative p-6 space-y-4">
            <div class="flex items-start justify-between gap-4">
              <div class="space-y-2">
                <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-slate-500 flex-wrap">
                  <span>Classroom</span>
                  <span class="h-4 w-px bg-slate-200"></span>
                  <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                    Kode: #{classroom.id}
                  </span>
                  <span class={`inline-flex items-center gap-1 px-2 py-1 rounded-full border text-[11px] font-semibold ${classroom.isPrivate ? 'bg-rose-50 text-rose-700 border-rose-100' : 'bg-emerald-50 text-emerald-700 border-emerald-100'}`}>
                    {classroom.isPrivate ? 'Privat' : 'Publik'}
                  </span>
                </div>
                <h1 class="text-2xl md:text-3xl font-bold text-slate-900">{classroom.title}</h1>
                {classroom.description && <p class="text-slate-700 max-w-3xl">{classroom.description}</p>}
                <div class="flex items-center gap-3 text-sm text-slate-600 flex-wrap">
                  <a href={`/classrooms/${classroom.id}/courses`} class="inline-flex items-center gap-1 text-blue-700 hover:text-blue-800 font-semibold">
                    <Icon name="book-stack" class="w-4 h-4" />
                    Kursus kelas
                  </a>
                  <a href={`/classrooms/${classroom.id}/quizzes`} class="inline-flex items-center gap-1 text-blue-700 hover:text-blue-800 font-semibold">
                    <Icon name="puzzle" class="w-4 h-4" />
                    Kuis kelas
                  </a>
                  <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                    <Icon name="users" class="w-4 h-4 text-slate-500" />
                    {members.length} aktif
                  </span>
                  <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                    <Icon name="note" class="w-4 h-4 text-slate-500" />
                    {posts.length} post
                  </span>
                  <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                    <Icon name="bookmark" class="w-4 h-4 text-slate-500" />
                    {resources.length} resource
                  </span>
                </div>
              </div>
              <div class="flex flex-col items-end gap-2">
                {membership ? (
                  <span class="text-xs font-semibold px-3 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                    {membership.role} Â· {membership.status}
                  </span>
                ) : (
                  <span class="text-xs font-semibold px-3 py-1 rounded-full bg-slate-50 text-slate-600 border border-slate-200">
                    Belum bergabung
                  </span>
                )}
                {(membership?.role === 'TEACHER' || user?.role === 'admin') && (
                  <div class="flex items-center gap-2">
                    <button
                      type="button"
                      id="edit-class-btn"
                      class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-slate-900 text-white hover:bg-slate-800 transition"
                    >
                      Edit kelas
                    </button>
                    <button
                      type="button"
                      id="toggle-privacy-btn"
                      class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 transition"
                    >
                      {classroom.isPrivate ? 'Jadikan publik' : 'Jadikan privat'}
                    </button>
                    {user?.role === 'admin' && (
                      <button
                        type="button"
                        id="delete-class-btn"
                        class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-red-50 text-red-700 hover:bg-red-100 transition"
                      >
                        Hapus
                      </button>
                    )}
                  </div>
                )}
              </div>
            </div>

            {!user && (
              <div class="flex items-center gap-3 text-sm text-slate-700">
                <a href="/auth/signin" class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors">
                  Masuk untuk bergabung
                </a>
              </div>
            )}

            {user && !membership && (
              <div class="flex items-center gap-3">
                <button
                  type="button"
                  class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors"
                  id="join-btn"
                  data-classroom={classroom.id}
                >
                  {classroom.isPrivate ? 'Minta bergabung' : 'Gabung kelas'}
                </button>
                <p class="text-sm text-slate-600">{classroom.isPrivate ? 'Kelas privat; permintaan perlu disetujui.' : 'Kelas publik; kamu akan langsung masuk.'}</p>
              </div>
            )}

            {membership && membership.status === 'PENDING' && (
              <p class="text-sm text-amber-700 bg-amber-50 border border-amber-100 px-3 py-2 rounded-lg">
                Permintaan bergabung menunggu persetujuan.
              </p>
            )}

            <div class="flex items-center gap-4 border-t border-slate-100 pt-3 text-sm font-semibold">
              <button type="button" class="tab-btn text-slate-600 hover:text-blue-700" data-tab="stream">Stream</button>
              <button type="button" class="tab-btn text-slate-600 hover:text-blue-700" data-tab="classwork">Classwork</button>
              <button type="button" class="tab-btn text-slate-600 hover:text-blue-700" data-tab="people">People</button>
            </div>
          </div>
        </header>

        {user && (membership?.status === 'ACTIVE' || user.role === 'admin') ? (
          <>
            <div class="space-y-8" data-tab-panel="stream">
              <section class="space-y-4">
                <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
                  <div class="flex items-center justify-between mb-3">
                    <div>
                      <h2 class="text-sm font-semibold text-slate-800">Buat Post</h2>
                      <p class="text-xs text-slate-500">Bagikan pengumuman atau diskusi.</p>
                    </div>
                    <span id="post-status" class="text-xs text-slate-500"></span>
                  </div>
                  <textarea
                    id="post-content"
                    class="w-full border border-slate-200 rounded-xl p-3 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 bg-slate-50"
                    placeholder="Bagikan pengumuman atau diskusi..."
                    rows="3"
                  ></textarea>
                  <div class="flex justify-end mt-3">
                    <button
                      type="button"
                      id="post-submit"
                      class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm"
                      data-classroom={classroom.id}
                    >
                      Post
                    </button>
                  </div>
                </div>

                <div class="space-y-3">
                  {posts.length === 0 ? (
                    <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm text-slate-700 text-center">
                      <p class="font-semibold text-slate-800">Belum ada post</p>
                      <p class="text-sm text-slate-500">Mulai percakapan pertama untuk kelas ini.</p>
                    </div>
                  ) : (
                    posts.map((post) => (
                      <article class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm space-y-3">
                        <div class="flex items-center justify-between">
                          <div class="text-sm text-slate-600">
                            <span class="font-semibold text-slate-800">{post.author.email}</span>
                            <span class="text-xs text-slate-500 block">{new Date(post.createdAt).toLocaleString('id-ID')}</span>
                          </div>
                          <div class="flex items-center gap-2">
                            {post.pinned && <span class="text-xs px-2 py-1 bg-yellow-50 border border-yellow-100 text-yellow-700 rounded">Pinned</span>}
                            {(membership?.role === 'TEACHER' || user.role === 'admin' || post.authorId === user.id) && (
                              <button
                                type="button"
                                class="text-xs text-red-600 hover:text-red-700"
                                data-delete-post={post.id}
                                data-classroom={classroom.id}
                              >
                                Hapus
                              </button>
                            )}
                          </div>
                        </div>
                        <p class="text-slate-800 whitespace-pre-wrap text-sm leading-relaxed">{post.content}</p>

                        <div class="border-t border-slate-100 pt-3 space-y-3">
                          {post.comments.length === 0 ? (
                            <p class="text-xs text-slate-500">Belum ada komentar.</p>
                          ) : (
                            post.comments.map((c: any) => (
                              <div class="text-sm flex items-start justify-between bg-slate-50 border border-slate-100 rounded-lg px-3 py-2">
                                <div>
                                  <span class="font-medium text-slate-800">{c.author.email}</span>{' '}
                                  <span class="text-slate-700">{c.content}</span>
                                </div>
                              </div>
                            ))
                          )}
                          <div class="flex items-center gap-2">
                            <input
                              type="text"
                              class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
                              placeholder="Tulis komentar"
                              data-comment-input={post.id}
                            />
                            <button
                              type="button"
                              class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm font-semibold hover:bg-slate-900 transition-colors"
                              data-comment-submit={post.id}
                              data-classroom={classroom.id}
                            >
                              Kirim
                            </button>
                          </div>
                        </div>
                      </article>
                    ))
                  )}
                </div>

                <div class="grid gap-4 lg:grid-cols-2">
                  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                    <h3 class="text-sm font-semibold text-slate-800 mb-3">Tautan cepat</h3>
                    <div class="flex flex-col gap-2 text-sm">
                      <a href={`/classrooms/${classroom.id}/courses`} class="flex items-center justify-between rounded-lg border border-slate-200 px-3 py-2 hover:border-blue-200 hover:text-blue-700 transition">
                        <span class="inline-flex items-center gap-2">
                          <Icon name="book-stack" class="w-4 h-4" />
                          Kursus kelas
                        </span>
                        <span class="text-xs text-slate-500">Buka</span>
                      </a>
                      <a href={`/classrooms/${classroom.id}/quizzes`} class="flex items-center justify-between rounded-lg border border-slate-200 px-3 py-2 hover:border-blue-200 hover:text-blue-700 transition">
                        <span class="inline-flex items-center gap-2">
                          <Icon name="puzzle" class="w-4 h-4" />
                          Kuis kelas
                        </span>
                        <span class="text-xs text-slate-500">Buka</span>
                      </a>
                    </div>
                  </div>

                  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                    <h3 class="text-sm font-semibold text-slate-800 mb-3">Resource terpin</h3>
                    {resources.length === 0 ? (
                      <p class="text-sm text-slate-600">Belum ada resource.</p>
                    ) : (
                      <ul class="space-y-2 text-sm">
                        {resources.map((res) => (
                          <li class="flex items-center gap-2">
                            <Icon name="bookmark" class="w-4 h-4 text-slate-500" />
                            {res.course ? (
                              <a class="text-blue-700 hover:underline" href={`/courses/${res.course.slug}`}>{res.course.title}</a>
                            ) : res.quiz ? (
                              <a class="text-blue-700 hover:underline" href={`/quizzes/${res.quiz.id}`}>{res.quiz.title}</a>
                            ) : (
                              <span class="text-slate-600">Resource</span>
                            )}
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>
                </div>
              </section>
            </div>

            <div class="space-y-6" data-tab-panel="classwork" style="display:none">
              <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <h3 class="text-sm font-semibold text-slate-800">Materi & Resource</h3>
                    <p class="text-xs text-slate-500">Kursus, kuis, atau resource lain yang ditautkan.</p>
                  </div>
                  <span class="text-xs text-slate-500">{resources.length} resource</span>
                </div>
                {resources.length === 0 ? (
                  <p class="text-sm text-slate-600">Belum ada resource tertaut. Tautkan kursus/kuis ke kelas ini.</p>
                ) : (
                  <ul class="space-y-2 text-sm">
                    {resources.map((res) => (
                      <li class="flex items-center justify-between gap-2 rounded-lg border border-slate-200 px-3 py-2">
                        <div class="flex items-center gap-2 text-slate-700">
                          <Icon name="bookmark" class="w-4 h-4 text-slate-500" />
                          {res.course ? (
                            <a class="text-blue-700 hover:underline" href={`/courses/${res.course.slug}`}>{res.course.title}</a>
                          ) : res.quiz ? (
                            <a class="text-blue-700 hover:underline" href={`/quizzes/${res.quiz.id}`}>{res.quiz.title}</a>
                          ) : (
                            <span class="text-slate-600">Resource</span>
                          )}
                        </div>
                        <span class="text-xs text-slate-500">{new Date(res.createdAt).toLocaleDateString('id-ID')}</span>
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </div>

            <div class="space-y-6" data-tab-panel="people" style="display:none">
              <div class="grid gap-4 md:grid-cols-3">
                <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                  <p class="text-xs text-slate-500">Anggota aktif</p>
                  <p class="text-2xl font-bold text-slate-900">{members.length}</p>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                  <p class="text-xs text-slate-500">Permintaan pending</p>
                  <p class="text-2xl font-bold text-amber-600">{pendingMembers.length}</p>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                  <p class="text-xs text-slate-500">Resource tertaut</p>
                  <p class="text-2xl font-bold text-slate-900">{resources.length}</p>
                </div>
              </div>

              {(membership?.role === 'TEACHER' || user.role === 'admin') && (
                <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm space-y-3">
                  <div class="flex items-center justify-between">
                    <div>
                      <h3 class="text-sm font-semibold text-slate-800">Tambah anggota langsung</h3>
                      <p class="text-xs text-slate-500">Masukkan ID pengguna atau email terdaftar.</p>
                    </div>
                    <span class="text-[11px] rounded-full bg-blue-50 px-2 py-1 text-blue-700 border border-blue-100">Admin/Guru</span>
                  </div>
                  <div class="flex flex-col gap-2 sm:flex-row">
                    <input
                      type="text"
                      id="people-invite-input"
                      class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
                      placeholder="123 atau email@contoh.com"
                    />
                    <button
                      type="button"
                      id="people-invite-btn"
                      class="px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition-colors"
                      data-classroom={classroom.id}
                    >
                      Tambahkan anggota
                    </button>
                  </div>
                  <p id="people-invite-status" class="text-xs text-slate-500"></p>
                </div>
              )}

              <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
                <h3 class="text-sm font-semibold text-slate-800 mb-3">Anggota aktif</h3>
                {members.length === 0 ? (
                  <p class="text-sm text-slate-600">Belum ada anggota aktif.</p>
                ) : (
                  <ul class="divide-y divide-slate-100 text-sm text-slate-700">
                    {members.map((m) => {
                      const displayName = m.user.name || m.user.email;
                      return (
                        <li class="py-2 flex items-center justify-between">
                          <span>{displayName}</span>
                          <span class="text-xs text-slate-500">{m.role}</span>
                        </li>
                      );
                    })}
                  </ul>
                )}
              </div>

              {(membership?.role === 'TEACHER' || user.role === 'admin') && pendingMembers.length > 0 && (
                <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm space-y-3">
                  <h3 class="text-sm font-semibold text-slate-800">Permintaan bergabung</h3>
                  <div class="space-y-2">
                    {pendingMembers.map((m) => {
                      const displayName = m.user.name || m.user.email;
                      return (
                        <div class="flex items-center justify-between rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm">
                          <span>{displayName}</span>
                          <div class="flex items-center gap-2">
                            <button
                              type="button"
                              class="px-3 py-1 text-xs font-semibold rounded bg-green-600 text-white approve-member-btn"
                              data-user-id={m.userId}
                              data-classroom={classroom.id}
                            >
                              Setujui
                            </button>
                            <button
                              type="button"
                              class="px-3 py-1 text-xs font-semibold rounded bg-red-600 text-white reject-member-btn"
                              data-user-id={m.userId}
                              data-classroom={classroom.id}
                            >
                              Tolak
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          </>
        ) : (
          user && (
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
              <p class="text-slate-700">Kamu belum menjadi anggota kelas ini.</p>
              <button
                type="button"
                class="mt-3 inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors"
                id="join-btn"
                data-classroom={classroom.id}
              >
                Minta bergabung
              </button>
            </div>
          )
        )}
      </>
    )}
  </main>

  {user && (
    <div
      id="class-meta"
      data-class-id={classroom?.id}
      data-class-title={classroom?.title || ''}
      data-class-desc={classroom?.description || ''}
      data-class-private={classroom?.isPrivate ? 'true' : 'false'}
      class="hidden"
    ></div>
    <script type="module">
      const metaEl = document.querySelector('#class-meta');
      const classIdAttr = metaEl ? metaEl.getAttribute('data-class-id') : null;
      const classId = classIdAttr ? parseInt(classIdAttr, 10) : null;
      const classTitle = metaEl ? metaEl.getAttribute('data-class-title') || '' : '';
      const classDesc = metaEl ? metaEl.getAttribute('data-class-desc') || '' : '';
      const classPrivate = metaEl ? metaEl.getAttribute('data-class-private') === 'true' : true;
      const joinBtn = document.querySelector('#join-btn');
      if (joinBtn) {
        if (!classPrivate) joinBtn.textContent = 'Gabung kelas';
        joinBtn.addEventListener('click', async () => {
          const id = joinBtn.getAttribute('data-classroom');
          joinBtn.textContent = classPrivate ? 'Meminta...' : 'Menggabungkan...';
          joinBtn.disabled = true;
          try {
            const res = await fetch(`/api/classrooms/${id}/join`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
            if (res.ok) {
              joinBtn.textContent = classPrivate ? 'Diminta' : 'Bergabung';
              if (!classPrivate) {
                // For public classrooms, refresh to show membership immediately
                window.location.reload();
              }
            } else {
              const data = await res.json().catch(() => ({}));
              joinBtn.textContent = 'Gagal';
              alert(data.error || 'Gagal meminta bergabung');
            }
          } catch (err) {
            joinBtn.textContent = 'Gagal';
            alert('Tidak dapat mengirim permintaan');
          } finally {
            setTimeout(() => {
              joinBtn.textContent = classPrivate ? 'Minta bergabung' : 'Gabung kelas';
              joinBtn.disabled = false;
            }, 1500);
          }
        });
      }

      const postBtn = document.querySelector('#post-submit');
      const postContentEl = document.querySelector('#post-content');
      const postContent = postContentEl instanceof HTMLTextAreaElement ? postContentEl : null;
      if (postBtn && postContent) {
        postBtn.addEventListener('click', async () => {
          const id = postBtn.getAttribute('data-classroom');
          const content = postContent.value.trim();
          if (!content) return alert('Isi konten dulu.');
          postBtn.textContent = 'Mengirim...';
          postBtn.setAttribute('disabled', 'true');
          try {
            const res = await fetch(`/api/classrooms/${id}/posts`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content })
            });
            if (res.ok) {
              location.reload();
            } else {
              const data = await res.json().catch(() => ({}));
              alert(data.error || 'Gagal membuat post');
            }
          } finally {
            postBtn.textContent = 'Post';
            postBtn.removeAttribute('disabled');
          }
        });
      }

      document.querySelectorAll('[data-comment-submit]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const postId = btn.getAttribute('data-comment-submit');
          const classroomId = btn.getAttribute('data-classroom');
          const inputEl = document.querySelector(`[data-comment-input="${postId}"]`);
          const input = inputEl instanceof HTMLInputElement ? inputEl : null;
          if (!input) return;
          const content = input.value.trim();
          if (!content) return;
          btn.textContent = 'Mengirim...';
          if (btn instanceof HTMLButtonElement) btn.disabled = true;
          try {
            const res = await fetch(`/api/classrooms/${classroomId}/posts/${postId}/comments`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content })
            });
            if (res.ok) {
              location.reload();
            } else {
              const data = await res.json().catch(() => ({}));
              alert(data.error || 'Gagal mengirim komentar');
            }
          } finally {
            btn.textContent = 'Kirim';
            if (btn instanceof HTMLButtonElement) btn.disabled = false;
          }
        });
      });

      const inviteBtn = document.querySelector('#people-invite-btn');
      const inviteInput = document.querySelector('#people-invite-input');
      const inviteStatus = document.querySelector('#people-invite-status');
      if (inviteBtn && inviteInput && classId) {
        inviteBtn.addEventListener('click', async () => {
          const raw = inviteInput.value.trim();
          if (!raw) {
            inviteStatus.textContent = 'ID atau email wajib diisi.';
            inviteStatus.className = 'text-xs text-red-600';
            return;
          }
          const userId = /^\d+$/.test(raw) ? parseInt(raw, 10) : null;
          const email = userId ? null : raw;
          inviteBtn.textContent = 'Menambahkan...';
          inviteBtn.setAttribute('disabled', 'true');
          inviteStatus.textContent = '';
          try {
            const res = await fetch(`/api/classrooms/${classId}/invite`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(userId ? { userId } : { email })
            });
            const data = await res.json().catch(() => ({}));
            if (res.ok) {
              inviteStatus.textContent = data.message || 'Anggota ditambahkan.';
              inviteStatus.className = 'text-xs text-emerald-600';
              inviteInput.value = '';
            } else {
              inviteStatus.textContent = data.error || 'Gagal menambahkan anggota.';
              inviteStatus.className = 'text-xs text-red-600';
            }
          } catch (err) {
            inviteStatus.textContent = 'Gagal menambahkan anggota.';
            inviteStatus.className = 'text-xs text-red-600';
          } finally {
            inviteBtn.textContent = 'Tambahkan anggota';
            inviteBtn.removeAttribute('disabled');
          }
        });
      }

  // Tabs
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabPanels = document.querySelectorAll('[data-tab-panel]');
  function setTab(tab) {
    tabPanels.forEach((panel) => {
      const active = panel.getAttribute('data-tab-panel') === tab;
      panel.setAttribute('style', active ? '' : 'display:none');
    });
    tabButtons.forEach((btn) => {
      btn.classList.toggle('text-blue-700', btn.getAttribute('data-tab') === tab);
      btn.classList.toggle('text-slate-600', btn.getAttribute('data-tab') !== tab);
    });
  }
  tabButtons.forEach((btn) => {
    btn.addEventListener('click', () => setTab(btn.getAttribute('data-tab') || 'stream'));
  });
  setTab('stream');

  // Approve / reject pending members
  document.querySelectorAll('.approve-member-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const uid = btn.getAttribute('data-user-id');
      const cid = btn.getAttribute('data-classroom');
      if (!uid || !cid) return;
      btn.textContent = 'Menyetujui...';
      btn.setAttribute('disabled', 'true');
      try {
        const res = await fetch(`/api/classrooms/${cid}/members`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: uid, status: 'ACTIVE', role: 'STUDENT' })
        });
        if (res.ok) {
          window.location.reload();
        } else {
          const body = await res.json().catch(() => ({}));
          alert(body.error || 'Gagal menyetujui');
        }
      } finally {
        btn.textContent = 'Setujui';
        btn.removeAttribute('disabled');
      }
    });
  });
  document.querySelectorAll('.reject-member-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const uid = btn.getAttribute('data-user-id');
      const cid = btn.getAttribute('data-classroom');
      if (!uid || !cid) return;
      btn.textContent = 'Menolak...';
      btn.setAttribute('disabled', 'true');
      try {
        const res = await fetch(`/api/classrooms/${cid}/members`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: uid })
        });
        if (res.ok) {
          window.location.reload();
        } else {
          const body = await res.json().catch(() => ({}));
          alert(body.error || 'Gagal menolak');
        }
      } finally {
        btn.textContent = 'Tolak';
        btn.removeAttribute('disabled');
      }
    });
  });

  // Toggle privacy (teacher/admin)
  const toggleBtn = document.querySelector('#toggle-privacy-btn');
  if (toggleBtn && classId) {
    toggleBtn.addEventListener('click', async () => {
      const makePrivate = toggleBtn.textContent?.includes('privat');
      toggleBtn.textContent = 'Menyimpan...';
      toggleBtn.setAttribute('disabled', 'true');
      try {
        const res = await fetch(`/api/classrooms/${classId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: classTitle || 'Kelas',
            description: classDesc || '',
            isPrivate: makePrivate
          })
        });
        if (res.ok) {
          window.location.reload();
        } else {
          const data = await res.json().catch(() => ({}));
          alert(data.error || 'Gagal mengubah privasi');
        }
      } finally {
        toggleBtn.textContent = makePrivate ? 'Jadikan publik' : 'Jadikan privat';
        toggleBtn.removeAttribute('disabled');
      }
    });
  }

      const deleteBtn = document.querySelector('#delete-class-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
          if (!confirm('Hapus kelas ini? Semua post dan membership akan hilang.')) return;
          deleteBtn.textContent = 'Menghapus...';
          deleteBtn.setAttribute('disabled', 'true');
          try {
            const res = await fetch(`/api/classrooms/${classId}`, { method: 'DELETE' });
            if (res.ok) {
              window.location.href = '/admin/classrooms';
            } else {
              const data = await res.json().catch(() => ({}));
              alert(data.error || 'Gagal menghapus kelas');
            }
          } finally {
            deleteBtn.textContent = 'Hapus kelas';
            deleteBtn.removeAttribute('disabled');
          }
        });
      }

      const editBtn = document.querySelector('#edit-class-btn');
      if (editBtn) {
        editBtn.addEventListener('click', async () => {
          const newTitle = prompt('Judul kelas', classTitle);
          if (!newTitle || !newTitle.trim()) return;
          const newDesc = prompt('Deskripsi kelas (opsional)', classDesc);
          try {
            const res = await fetch(`/api/classrooms/${classId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ title: newTitle.trim(), description: newDesc?.toString() })
            });
            if (res.ok) {
              window.location.reload();
            } else {
              const data = await res.json().catch(() => ({}));
              alert(data.error || 'Gagal menyimpan perubahan');
            }
          } catch (err) {
            alert('Gagal menyimpan perubahan');
          }
        });
      }
    </script>
  )}
</Layout>

