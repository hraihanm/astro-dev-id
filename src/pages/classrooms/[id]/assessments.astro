---
import Layout from '../../../components/Layout.astro';
import { prisma } from '../../../lib/db';
import { getSessionUser } from '../../../lib/auth-guard';
import AssessmentForm from '../../../components/AssessmentForm.astro';

export const prerender = false;

const classroomId = parseInt(Astro.params.id || '0', 10);
const user = await getSessionUser(Astro.cookies);

if (!user) {
  return Astro.redirect('/auth/signin');
}

const membership = await prisma.classroomMembership.findFirst({
  where: { classroomId, userId: user.id, status: 'ACTIVE' },
  select: { role: true }
});

const isAdmin = user.role === 'admin';
const isTeacher = isAdmin || membership?.role === 'TEACHER';
const isMember = Boolean(membership);

if (!isAdmin && !isMember) {
  return Astro.redirect('/classrooms');
}

const classroom = await prisma.classroom.findUnique({
  where: { id: classroomId },
  select: { id: true, title: true }
});

const assessments = await prisma.assessment.findMany({
  where: { classroomId },
  orderBy: [{ dueAt: 'asc' }, { createdAt: 'desc' }],
  include: {
    submissions: {
      select: { status: true, studentId: true, score: true, late: true, submittedAt: true },
      ...(isTeacher ? {} : { where: { studentId: user.id } })
    }
  }
});

const list = assessments.map((a) => {
  const counts = { assigned: 0, handed_in: 0, graded: 0, rejected: 0 };
  a.submissions.forEach((s) => {
    if (s.status in counts) {
      // @ts-ignore
      counts[s.status] += 1;
    }
  });
  const mySubmission = a.submissions.find((s) => s.studentId === user.id);
  return { ...a, counts, mySubmission };
});
---

<Layout title={`Assessments • ${classroom?.title || 'Classroom'}`}>
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-6">
    <header class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6 flex items-center justify-between gap-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-500">Classroom</p>
        <h1 class="text-2xl font-bold text-slate-900">Assessments</h1>
        <p class="text-slate-600 mt-1">Tugas, ujian, dan kuis dengan tenggat.</p>
      </div>
      <a href={`/classrooms/${classroomId}`} class="text-sm text-blue-600 hover:text-blue-700 font-semibold">← Kembali ke kelas</a>
    </header>

    <AssessmentForm classroomId={classroomId} isTeacher={isTeacher} />

    {list.length === 0 ? (
      <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm text-slate-700">
        Belum ada assessment di kelas ini.
      </div>
    ) : (
      <div class="space-y-3">
        {list.map((a) => (
          <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm hover:border-blue-200 transition">
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <div class="flex items-center gap-2 text-xs text-slate-500 flex-wrap">
                  <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">{a.type}</span>
                  <span class={`inline-flex items-center gap-1 px-2 py-1 rounded-full border text-[11px] font-semibold ${a.status === 'published' ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-amber-50 text-amber-700 border-amber-100'}`}>
                    {a.status}
                  </span>
                  {a.dueAt && (
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                      Due {new Date(a.dueAt).toLocaleString('id-ID')}
                    </span>
                  )}
                </div>
                <h2 class="text-lg font-semibold text-slate-900">{a.title}</h2>
                {a.description && <p class="text-sm text-slate-600 line-clamp-2">{a.description}</p>}
              </div>
              <div class="text-right text-xs text-slate-500 space-y-1">
                <div>Assigned: {a.counts.assigned}</div>
                <div>Handed in: {a.counts.handed_in}</div>
                <div>Graded: {a.counts.graded}</div>
              </div>
            </div>

            {!isTeacher && a.mySubmission && (
              <div class="mt-3 text-sm text-slate-700 flex items-center gap-2">
                <span class={`text-xs px-2 py-1 rounded-full border ${a.mySubmission.status === 'graded' ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : a.mySubmission.status === 'handed_in' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-slate-100 text-slate-700 border-slate-200'}`}>
                  Status: {a.mySubmission.status}
                </span>
                {a.mySubmission.score !== null && <span>Skor: {a.mySubmission.score} / {a.maxScore}</span>}
                {a.mySubmission.late && <span class="text-xs text-amber-700">Late</span>}
              </div>
            )}

            <div class="mt-4 flex items-center gap-3">
              <a
                href={`/classrooms/${classroomId}/assessments/${a.id}`}
                class="inline-flex items-center px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors"
              >
                Buka
              </a>
              {isTeacher && a.status === 'draft' && (
                <button
                  type="button"
                  class="text-sm text-blue-700 font-semibold px-3 py-2 rounded-lg border border-blue-100 bg-blue-50 hover:bg-blue-100 transition"
                  data-publish={a.id}
                >
                  Publikasikan
                </button>
              )}
            </div>
          </div>
        ))}
      </div>
    )}
  </main>

  {isTeacher && (
    <script type="module">
      document.querySelectorAll('[data-publish]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-publish');
          if (!id) return;
          btn.textContent = 'Memublikasikan...';
          btn.setAttribute('disabled', 'true');
          try {
            const res = await fetch(`/api/classrooms/${classroomId}/assessments/${id}/publish`, { method: 'POST' });
            if (res.ok) {
              window.location.reload();
            } else {
              const body = await res.json().catch(() => ({}));
              alert(body.error || 'Gagal memublikasikan.');
            }
          } finally {
            btn.textContent = 'Publikasikan';
            btn.removeAttribute('disabled');
          }
        });
      });
    </script>
  )}
</Layout>

