---
import Layout from '../../../components/Layout.astro';
import { prisma } from '../../../lib/db';
import { getSessionUser } from '../../../lib/auth-guard';

export const prerender = false;

const classroomId = parseInt(Astro.params.id || '0', 10);
const user = await getSessionUser(Astro.cookies);

if (!user) {
  return Astro.redirect('/auth/signin');
}

const membership = await prisma.classroomMembership.findFirst({
  where: { classroomId, userId: user.id, status: 'ACTIVE' },
  select: { role: true }
});

const isAdmin = user.role === 'admin';
const isMember = Boolean(membership);

if (!isAdmin && !isMember) {
  return Astro.redirect('/classrooms');
}

const classroom = await prisma.classroom.findUnique({
  where: { id: classroomId },
  select: { id: true, title: true }
});

const resources = await prisma.classroomResource.findMany({
  where: { classroomId, courseId: { not: null } },
  include: {
    course: {
      select: { id: true, title: true, slug: true, description: true, visibility: true }
    }
  },
  orderBy: { pinnedAt: 'desc' }
});

const existingCourseIds = resources.map((r) => r.course?.id).filter(Boolean) as number[];
const availableCourses = (isAdmin || membership?.role === 'TEACHER')
  ? await prisma.course.findMany({
      where: existingCourseIds.length ? { id: { notIn: existingCourseIds } } : {},
      select: { id: true, title: true, slug: true, visibility: true },
      orderBy: { createdAt: 'desc' },
      take: 50
    })
  : [];
---

<Layout title={`Kursus • ${classroom?.title || 'Classroom'}`}>
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-6">
    <header class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6 flex items-center justify-between gap-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-500">Classroom</p>
        <h1 class="text-2xl font-bold text-slate-900">{classroom?.title || 'Classroom'}</h1>
        <p class="text-slate-600 mt-1">Kursus yang tertaut ke kelas ini.</p>
      </div>
      <a href={`/classrooms/${classroomId}`} class="text-sm text-blue-600 hover:text-blue-700 font-semibold">← Kembali ke kelas</a>
    </header>

    {(isAdmin || membership?.role === 'TEACHER') && (
      <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5 space-y-3">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">Tambah kursus ke kelas</h2>
          <p class="text-sm text-slate-600">Pilih kursus yang belum tertaut.</p>
        </div>
        {availableCourses.length === 0 ? (
          <p class="text-sm text-slate-600">Semua kursus sudah tertaut atau belum ada kursus tersedia.</p>
        ) : (
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
            <select id="course-select" class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500">
              <option value="">Pilih kursus</option>
              {availableCourses.map((c) => (
              <option value={c.id}>{c.title} — {c.visibility || 'PUBLIC'}</option>
              ))}
            </select>
            <button
              id="add-course-btn"
              class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition-colors"
              data-classroom={classroomId}
            >
              Tambahkan
            </button>
          </div>
        )}
        <p id="course-status" class="text-xs text-slate-500"></p>
      </section>
    )}

    {resources.length === 0 ? (
      <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm text-slate-700">
        Belum ada kursus yang ditautkan ke kelas ini.
      </div>
    ) : (
      <div class="grid gap-4 md:grid-cols-2">
        {resources.map((res) => res.course && (
          <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm hover:border-blue-200 hover:shadow-md transition flex flex-col gap-3">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold text-slate-900">{res.course.title}</h3>
                <p class="text-sm text-slate-600 line-clamp-2">{res.course.description || 'Tidak ada deskripsi.'}</p>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">
                  {res.course.visibility || 'PUBLIC'}
                </span>
                {(isAdmin || membership?.role === 'TEACHER') && (
                  <button
                    class="text-xs text-red-600 hover:text-red-700"
                    data-remove-resource={res.id}
                    data-classroom={classroomId}
                  >
                    Hapus
                  </button>
                )}
              </div>
            </div>
            <div class="flex items-center justify-between">
              <a href={`/courses/${res.course.slug}`} class="text-sm text-blue-600 hover:text-blue-700 font-semibold">Lihat kursus →</a>
              <span class="text-xs text-slate-500">ID #{res.course.id}</span>
            </div>
          </div>
        ))}
      </div>
    )}
  </main>

  {(isAdmin || membership?.role === 'TEACHER') && (
    <script type="module">
      const addBtn = document.querySelector('#add-course-btn');
      const selectEl = document.querySelector('#course-select');
      const statusEl = document.querySelector('#course-status');
      if (addBtn && selectEl && statusEl) {
        addBtn.addEventListener('click', async () => {
          const courseId = selectEl.value;
          if (!courseId) {
            statusEl.textContent = 'Pilih kursus terlebih dahulu.';
            statusEl.className = 'text-xs text-red-600';
            return;
          }
          addBtn.textContent = 'Menambahkan...';
          addBtn.setAttribute('disabled', 'true');
          statusEl.textContent = '';
          try {
            const res = await fetch(`/api/classrooms/${addBtn.getAttribute('data-classroom')}/resources`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ courseId })
            });
            const body = await res.json().catch(() => ({}));
            if (res.ok) {
              statusEl.textContent = body.message || 'Ditambahkan.';
              statusEl.className = 'text-xs text-emerald-600';
              window.location.reload();
            } else {
              statusEl.textContent = body.error || 'Gagal menambahkan.';
              statusEl.className = 'text-xs text-red-600';
            }
          } catch (err) {
            statusEl.textContent = 'Gagal menambahkan.';
            statusEl.className = 'text-xs text-red-600';
          } finally {
            addBtn.textContent = 'Tambahkan';
            addBtn.removeAttribute('disabled');
          }
        });
      }

      document.querySelectorAll('[data-remove-resource]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-remove-resource');
          const classId = btn.getAttribute('data-classroom');
          if (!id || !classId) return;
          btn.textContent = 'Menghapus...';
          btn.setAttribute('disabled', 'true');
          try {
            const res = await fetch(`/api/classrooms/${classId}/resources`, {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ resourceId: id })
            });
            if (res.ok) {
              window.location.reload();
            } else {
              const body = await res.json().catch(() => ({}));
              alert(body.error || 'Gagal menghapus.');
            }
          } finally {
            btn.textContent = 'Hapus';
            btn.removeAttribute('disabled');
          }
        });
      });
    </script>
  )}
</Layout>

